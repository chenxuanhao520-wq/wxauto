#!/usr/bin/env python3
"""
ä½¿ç”¨ Sequential Thinking MCP åˆ†æç³»ç»Ÿæ¶æ„
"""

import asyncio
import sys
import os
from pathlib import Path

sys.path.append(str(Path(__file__).parent))


async def analyze_architecture():
    """ä½¿ç”¨ Sequential Thinking MCP åˆ†æç³»ç»Ÿæ¶æ„"""
    print("\n" + "=" * 70)
    print("ğŸ§  ä½¿ç”¨ Sequential Thinking MCP åˆ†æç³»ç»Ÿæ¶æ„")
    print("=" * 70)
    
    # è®¾ç½® API Keyï¼ˆä»ç¯å¢ƒå˜é‡è¯»å–ï¼‰
    if not os.environ.get('QWEN_API_KEY'):
        print("âš ï¸  è­¦å‘Š: QWEN_API_KEY ç¯å¢ƒå˜é‡æœªè®¾ç½®")
        print("  è¯·è¿è¡Œ: export QWEN_API_KEY='your_api_key'")
        return
    
    try:
        # åˆå§‹åŒ– MCP Manager
        from modules.mcp_platform.mcp_manager_v2 import MCPManagerV2
        
        manager = MCPManagerV2()
        thinking = manager.get_client("sequential_thinking")
        
        print(f"\nâœ… Sequential Thinking MCP åˆå§‹åŒ–æˆåŠŸ")
        
        # å‡†å¤‡ç³»ç»Ÿæ¶æ„åˆ†æé—®é¢˜
        analysis_prompt = """
ä½œä¸ºä¸€ä¸ªé«˜çº§ç³»ç»Ÿæ¶æ„å¸ˆï¼Œè¯·æ·±å…¥åˆ†æä»¥ä¸‹ WeChat æ™ºèƒ½å®¢æœç³»ç»Ÿçš„æ¶æ„ï¼Œå¹¶æå‡ºä¼˜åŒ–å»ºè®®ï¼š

## ç³»ç»Ÿæ¦‚è¿°
è¿™æ˜¯ä¸€ä¸ªåŸºäºå¾®ä¿¡çš„æ™ºèƒ½å®¢æœç³»ç»Ÿï¼Œå…·æœ‰ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

### 1. å®¢æˆ·ç«¯-æœåŠ¡å™¨æ¶æ„
- **å®¢æˆ·ç«¯ (client/)**: 
  - å¾®ä¿¡ UI è‡ªåŠ¨åŒ– (WxAutoAdapter)
  - æœ¬åœ°åŠ å¯†ç¼“å­˜
  - ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—
  - å¿ƒè·³ä¿æ´»æœºåˆ¶
  - JWT è®¤è¯

- **æœåŠ¡å™¨ (server/)**:
  - FastAPI REST API
  - æ¶ˆæ¯å¤„ç†æœåŠ¡
  - JWT è®¤è¯
  - æ•°æ®æŒä¹…åŒ–

### 2. AI ç½‘å…³ (modules/ai_gateway/)
- å¤š LLM æä¾›å•†æ”¯æŒ (Qwen, GLM, DeepSeek, OpenAI, Claude, Gemini, Moonshot, Ernie)
- æ™ºèƒ½è·¯ç”± (æ ¹æ®ä»»åŠ¡å¤æ‚åº¦ã€ç±»å‹ã€æˆæœ¬é€‰æ‹©æ¨¡å‹)
- ç»Ÿä¸€çš„ API æ¥å£

### 3. MCP ä¸­å° (modules/mcp_platform/)
- é…ç½®ç®¡ç† (ConfigManager)
- æ™ºèƒ½ç¼“å­˜ (CacheManager - LRU, å†…å®¹å“ˆå¸Œ, TTL)
- æ’ä»¶æ¶æ„ (è£…é¥°å™¨æ³¨å†Œ)
- å·²é›†æˆæœåŠ¡:
  - AIOCR (æ–‡æ¡£è¯†åˆ«)
  - Sequential Thinking (æ·±åº¦æ€è€ƒ)
  - Zhibang ERP (å®¢æˆ·/è®¢å•/åˆåŒç®¡ç†)

### 4. çŸ¥è¯†åº“æœåŠ¡ (modules/kb_service/)
- æ–‡æ¡£å¤„ç†å™¨ (æ”¯æŒå¤šæ ¼å¼)
- å‘é‡å­˜å‚¨ (ChromaDB)
- åµŒå…¥æ¨¡å‹ (BGE-M3, OpenAI)
- RAG æ£€ç´¢å™¨

### 5. è‡ªé€‚åº”å­¦ä¹  (modules/adaptive_learning/)
- ç”¨æˆ·ç”»åƒ
- å¯¹è¯å†å²å¯¼å…¥
- æŒç»­å­¦ä¹ 
- ä¸ªæ€§åŒ–æç¤º

### 6. å¤šè¡¨é›†æˆ (modules/integrations/)
- é£ä¹¦å¤šç»´è¡¨æ ¼
- é’‰é’‰å¤šç»´è¡¨æ ¼

### 7. å¤šæ¨¡æ€æ”¯æŒ (modules/multimodal/)
- å›¾ç‰‡å¤„ç†
- éŸ³é¢‘å¤„ç†

### 8. å­˜å‚¨å±‚ (modules/storage/)
- SQLite æ•°æ®åº“
- å®¢æˆ·ç®¡ç†
- å¯¹è¯è·Ÿè¸ª
- æ¶ˆæ¯å†å²

## å½“å‰æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å¾®ä¿¡å®¢æˆ·ç«¯                              â”‚
â”‚  (UIè‡ªåŠ¨åŒ–ã€æ¶ˆæ¯æŠ“å–ã€åŠ å¯†ç¼“å­˜ã€ç¦»çº¿é˜Ÿåˆ—ã€JWTè®¤è¯)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ REST API (JWT)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       FastAPI æœåŠ¡å™¨                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              æ¶ˆæ¯å¤„ç†æœåŠ¡ (MessageService)                 â”‚  â”‚
â”‚  â”‚  â€¢ æ„å›¾è¯†åˆ«  â€¢ ä¸Šä¸‹æ–‡ç®¡ç†  â€¢ å¤šæ¨¡æ€å¤„ç†                    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚               â”‚                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  AIç½‘å…³     â”‚  â”‚  MCPä¸­å°    â”‚  â”‚  çŸ¥è¯†åº“æœåŠ¡   â”‚           â”‚
â”‚  â”‚ (æ™ºèƒ½è·¯ç”±)  â”‚  â”‚ (æ’ä»¶æ¶æ„)  â”‚  â”‚  (RAGæ£€ç´¢)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚         â”‚               â”‚                â”‚                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚    8ä¸ªLLMæä¾›å•†    3ä¸ªMCPæœåŠ¡    å‘é‡æ•°æ®åº“      â”‚           â”‚
â”‚  â”‚ (Qwen/GLM/ç­‰)   (OCR/æ€è€ƒ/ERP)  (ChromaDB)      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚               è‡ªé€‚åº”å­¦ä¹  + å¤šè¡¨é›†æˆ                        â”‚  â”‚
â”‚  â”‚  â€¢ ç”¨æˆ·ç”»åƒ  â€¢ æŒç»­å­¦ä¹   â€¢ é£ä¹¦/é’‰é’‰åŒæ­¥                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   SQLite æ•°æ®åº“                            â”‚  â”‚
â”‚  â”‚  â€¢ å®¢æˆ·ä¿¡æ¯  â€¢ å¯¹è¯å†å²  â€¢ æ¶ˆæ¯è®°å½•  â€¢ å­¦ä¹ æ•°æ®           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éœ€è¦åˆ†æçš„å…³é”®ç‚¹

1. **æ¶æ„åˆç†æ€§**: å®¢æˆ·ç«¯-æœåŠ¡å™¨åˆ†ç¦»æ˜¯å¦åˆç†ï¼Ÿæ˜¯å¦æœ‰è¿‡åº¦è®¾è®¡æˆ–ä¸è¶³ï¼Ÿ
2. **æ€§èƒ½ç“¶é¢ˆ**: SQLite æ˜¯å¦èƒ½æ”¯æ’‘é«˜å¹¶å‘ï¼ŸåŒæ­¥è°ƒç”¨ LLM æ˜¯å¦ä¼šé˜»å¡ï¼Ÿ
3. **å¯æ‰©å±•æ€§**: å¦‚ä½•æ”¯æŒå¤šå®¢æˆ·ç«¯ï¼Ÿå¦‚ä½•æ°´å¹³æ‰©å±•ï¼Ÿ
4. **æ•°æ®ä¸€è‡´æ€§**: å®¢æˆ·ç«¯ç¼“å­˜ã€ç¦»çº¿é˜Ÿåˆ—ã€æœåŠ¡å™¨æ•°æ®å¦‚ä½•ä¿è¯ä¸€è‡´ï¼Ÿ
5. **æˆæœ¬ä¼˜åŒ–**: 8ä¸ª LLM æä¾›å•†ã€å¤šä¸ª MCP æœåŠ¡ï¼Œæˆæœ¬å¦‚ä½•æ§åˆ¶ï¼Ÿ
6. **å®‰å…¨æ€§**: JWT è®¤è¯ã€API Key ç®¡ç†ã€æ•°æ®åŠ å¯†æ˜¯å¦è¶³å¤Ÿï¼Ÿ
7. **ç›‘æ§å’Œè¿ç»´**: æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ—¥å¿—ã€ç›‘æ§ã€å‘Šè­¦æœºåˆ¶ï¼Ÿ
8. **æ¨¡å—è€¦åˆ**: å„æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»æ˜¯å¦åˆç†ï¼Ÿ
9. **æŠ€æœ¯é€‰å‹**: ChromaDBã€SQLiteã€FastAPI æ˜¯å¦æ˜¯æœ€ä½³é€‰æ‹©ï¼Ÿ
10. **æœªæ¥æ¼”è¿›**: å¦‚ä½•æ”¯æŒä¼ä¸šå¾®ä¿¡ã€é’‰é’‰ã€é£ä¹¦ç­‰å¤šå¹³å°ï¼Ÿ

è¯·è¿›è¡Œæ·±åº¦åˆ†æï¼Œå¹¶ç»™å‡ºå…·ä½“çš„ä¼˜åŒ–å»ºè®®å’Œå®æ–½æ–¹æ¡ˆã€‚
"""
        
        print(f"\nğŸ¤” å¼€å§‹æ·±åº¦åˆ†æ...")
        print("=" * 70)
        
        # è°ƒç”¨ Sequential Thinking
        result = await thinking.sequential_thinking(
            problem=analysis_prompt,
            context="ç³»ç»Ÿæ¶æ„æ·±åº¦åˆ†æ",
            max_steps=10,
            thinking_style="analytical"
        )
        
        if result.get('success'):
            thinking_steps = result.get('thinking_steps', [])
            conclusion = result.get('conclusion', '')
            reasoning = result.get('reasoning', '')
            confidence = result.get('confidence', 0.0)
            alternatives = result.get('alternatives', [])
            
            print(f"\nğŸ’­ æ€è€ƒè¿‡ç¨‹:")
            print("=" * 70)
            for i, step in enumerate(thinking_steps, 1):
                print(f"\næ€è€ƒæ­¥éª¤ {i}:")
                print(f"  {step}")
            
            print(f"\n\nğŸ¯ æœ€ç»ˆåˆ†æç»“æœ:")
            print("=" * 70)
            print(f"ç»“è®º: {conclusion}")
            print(f"\næ¨ç†è¿‡ç¨‹: {reasoning}")
            print(f"\nç½®ä¿¡åº¦: {confidence}")
            if alternatives:
                print(f"\nå¤‡é€‰æ–¹æ¡ˆ:")
                for alt in alternatives:
                    print(f"  - {alt}")
            
            # ä¿å­˜åˆ†æç»“æœ
            from datetime import datetime
            output_file = "ç³»ç»Ÿæ¶æ„åˆ†ææŠ¥å‘Š.md"
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write("# ç³»ç»Ÿæ¶æ„æ·±åº¦åˆ†ææŠ¥å‘Š\n\n")
                f.write(f"**åˆ†ææ—¶é—´**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n\n")
                f.write(f"**ç½®ä¿¡åº¦**: {confidence}\n\n")
                f.write("## æ€è€ƒè¿‡ç¨‹\n\n")
                for i, step in enumerate(thinking_steps, 1):
                    f.write(f"### æ­¥éª¤ {i}\n")
                    f.write(f"{step}\n\n")
                f.write("## æœ€ç»ˆåˆ†æç»“æœ\n\n")
                f.write(f"### ç»“è®º\n\n{conclusion}\n\n")
                f.write(f"### æ¨ç†è¿‡ç¨‹\n\n{reasoning}\n\n")
                if alternatives:
                    f.write("### å¤‡é€‰æ–¹æ¡ˆ\n\n")
                    for i, alt in enumerate(alternatives, 1):
                        f.write(f"{i}. {alt}\n")
            
            print(f"\nâœ… åˆ†ææŠ¥å‘Šå·²ä¿å­˜åˆ°: {output_file}")
            
        else:
            print(f"âŒ åˆ†æå¤±è´¥: {result.get('error', 'æœªçŸ¥é”™è¯¯')}")
            
    except Exception as e:
        print(f"\nâŒ åˆ†æå¼‚å¸¸: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    asyncio.run(analyze_architecture())
