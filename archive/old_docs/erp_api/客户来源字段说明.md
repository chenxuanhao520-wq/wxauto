# 智邦国际ERP - 客户来源字段详细说明

**更新时间**: 2025-10-18  
**文档用途**: 客户来源字段在不同接口中的使用说明

---

## 一、字段名称汇总

### 1. 客户列表接口 (`/sysa/mobilephone/salesmanage/custom/list.asp`)

在客户列表查询接口中，客户来源相关字段有**三个**：

| 字段名 | 类型 | 用途 | 说明 |
|-------|------|------|------|
| **tjly** | string | 统计来源 | 用于筛选统计，可能是特殊的来源统计字段 |
| **khly** | string | 客户来源 | 单个来源值，用于单选筛选 |
| **ly** | string | 客户来源（多选） | 多个来源ID用逗号分隔，如 "171,173,977" |

### 2. 客户添加/修改接口 (`/sysa/mobilephone/salesmanage/custom/add.asp`)

| 字段名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| **ly** | int | 否 | 客户来源，整型，枚举类型 |

### 3. 客户添加（新版）接口 (`/webapi/v3/sales/customer/add`)

| 字段名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| **ly** | string | 否 | 客户来源，由策略控制是否必填 |

---

## 二、枚举值来源

### 获取客户来源枚举值接口

**接口地址**: `/webapi/v3/mobilephone/source.asp?enumid=13`  
**调用方式**: HTTP | GET/POST  

### 常见枚举值示例

| 枚举ID | 枚举值 | 说明 |
|--------|--------|------|
| 173 | 陌生开发 | 主动开发的客户 |
| 171 | 网站注册 | 通过官网注册的客户 |
| 977 | VIP | VIP客户 |
| 174 | 广告宣传 | 通过广告获取的客户 |
| 172 | 朋友介绍 | 熟人介绍的客户 |

---

## 三、实际使用示例

### 示例1: 查询网站注册的客户

```python
import requests

url = "http://ls1.jmt.ink:46088/sysa/mobilephone/salesmanage/custom/list.asp"
headers = {"Content-Type": "application/json"}

# 使用 ly 字段查询（单个来源）
datas = [
    {"id": "ly", "val": "171"},  # 171 = 网站注册
    {"id": "pagesize", "val": 20},
    {"id": "pageindex", "val": 1}
]

json_data = {
    "session": "your_session_token",
    "cmdkey": "refresh",
    "datas": datas
}

response = requests.post(url, json=json_data, headers=headers)
print(response.json())
```

### 示例2: 查询多个来源的客户

```python
# 查询"网站注册"或"广告宣传"的客户
datas = [
    {"id": "ly", "val": "171,174"},  # 171=网站注册, 174=广告宣传
    {"id": "pagesize", "val": 20}
]

json_data = {
    "session": "your_session_token",
    "cmdkey": "refresh",
    "datas": datas
}
```

### 示例3: 添加客户时指定来源

```python
# 添加单位客户，来源为"朋友介绍"
url = "http://ls1.jmt.ink:46088/sysa/mobilephone/salesmanage/custom/add.asp?intsort=1"

datas = [
    {"id": "ord", "val": 12345},  # 需要先调用分配新客户ID接口获取
    {"id": "name", "val": "测试公司"},
    {"id": "sort1", "val": "潜在客户"},
    {"id": "ly", "val": 172},  # 172 = 朋友介绍
    {"id": "person_name", "val": "张三"}
]

json_data = {
    "session": "your_session_token",
    "cmdkey": "__sys_dosave",
    "datas": datas
}

response = requests.post(url, json=json_data, headers=headers)
```

### 示例4: 使用新版V3接口添加客户

```python
# 使用新版接口，Token在Header中
url = "http://ls1.jmt.ink:46088/webapi/v3/sales/customer/add"
headers = {
    "Content-Type": "application/json",
    "ZBAPI-Token": "your_session_token"
}

json_data = {
    "sort2": 1,  # 1=单位客户
    "name": "测试公司",
    "sort": "潜在客户",
    "sort1": "初步接触",
    "ly": "172",  # 朋友介绍（注意：这里是字符串）
    "person_name": "张三",
    "mobile": "13800138000"
}

response = requests.post(url, json=json_data, headers=headers)
```

---

## 四、注意事项

### 1. 数据类型差异

- **老版接口** (`/sysa/mobilephone/`): `ly` 字段类型为 **int**
- **新版接口** (`/webapi/v3/`): `ly` 字段类型为 **string**

### 2. 参数格式差异

- **老版接口**: 使用 id-val 键值对数组形式
  ```python
  datas = [{"id": "ly", "val": 172}]
  json_data = {"session": "***", "datas": datas}
  ```

- **新版接口**: 使用标准JSON格式，Token在Header中
  ```python
  headers = {"ZBAPI-Token": "***"}
  json_data = {"ly": "172"}
  ```

### 3. 多选查询

在客户列表查询接口中，如果要查询多个来源的客户：
- 使用 `ly` 字段
- 多个枚举ID用**逗号分隔**（不要有空格）
- 示例: `"171,173,977"`

### 4. 统计来源字段

`tjly` (统计来源) 字段的具体用途和值范围需要进一步确认，建议：
- 查看系统后台配置
- 或咨询智邦技术支持
- 或通过实际调用测试

---

## 五、完整调用流程

### 步骤1: 获取客户来源枚举值

```python
# 获取所有可用的客户来源选项
url = "http://ls1.jmt.ink:46088/webapi/v3/mobilephone/source.asp?enumid=13"
response = requests.get(url)
sources = response.json()
# 返回结果包含所有可用的来源选项
```

### 步骤2: 添加客户并指定来源

```python
# 2.1 分配新客户ID
url = "http://ls1.jmt.ink:46088/sysa/mobilephone/salesmanage/custom/add.asp"
datas = [
    {"id": "edit", "val": ""},
    {"id": "intsort", "val": "1"}  # 单位客户
]
json_data = {"session": "***", "datas": datas}
response = requests.post(url, json=json_data, headers=headers)
new_ord = response.json()["data"]["value"]  # 获取新客户ID

# 2.2 保存客户信息（包含来源）
url = "http://ls1.jmt.ink:46088/sysa/mobilephone/salesmanage/custom/add.asp?intsort=1"
datas = [
    {"id": "ord", "val": new_ord},
    {"id": "name", "val": "新客户公司"},
    {"id": "sort1", "val": "潜在客户"},
    {"id": "ly", "val": 171},  # 网站注册
    {"id": "person_name", "val": "李四"}
]
json_data = {"session": "***", "cmdkey": "__sys_dosave", "datas": datas}
response = requests.post(url, json=json_data, headers=headers)
```

### 步骤3: 查询指定来源的客户

```python
# 查询所有"网站注册"的客户
url = "http://ls1.jmt.ink:46088/sysa/mobilephone/salesmanage/custom/list.asp"
datas = [
    {"id": "ly", "val": "171"},
    {"id": "pagesize", "val": 50},
    {"id": "pageindex", "val": 1}
]
json_data = {"session": "***", "cmdkey": "refresh", "datas": datas}
response = requests.post(url, json=json_data, headers=headers)
customers = response.json()["data"]["table"]["rows"]
```

---

## 六、快速参考

### 客户来源字段对照表

| 接口类型 | 接口路径 | 字段名 | 类型 | 多选支持 |
|---------|---------|--------|------|----------|
| 查询列表 | `/custom/list.asp` | ly | string | ✅ 支持（逗号分隔） |
| 查询列表 | `/custom/list.asp` | khly | string | ❌ 单选 |
| 查询列表 | `/custom/list.asp` | tjly | string | ❌ 单选 |
| 添加/修改（老） | `/custom/add.asp` | ly | int | ❌ 单选 |
| 添加（新V3） | `/customer/add` | ly | string | ❌ 单选 |

### Python快速代码片段

```python
# 定义客户来源常量
class CustomerSource:
    STRANGE_DEVELOPMENT = 173  # 陌生开发
    WEBSITE_REGISTER = 171     # 网站注册
    VIP = 977                  # VIP
    ADVERTISEMENT = 174        # 广告宣传
    FRIEND_INTRO = 172         # 朋友介绍

# 使用示例
customer_data = {
    "name": "新客户",
    "ly": CustomerSource.WEBSITE_REGISTER,
    # ... 其他字段
}
```

---

**总结**: 
- 客户列表查询时，使用 `ly` 字段进行筛选（支持多选，逗号分隔）
- 客户添加时，使用 `ly` 字段指定客户来源（单选）
- 枚举值通过 `/mobilephone/source.asp?enumid=13` 接口获取
- 常见值：171=网站注册、172=朋友介绍、173=陌生开发、174=广告宣传、977=VIP

