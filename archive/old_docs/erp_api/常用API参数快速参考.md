# æ™ºé‚¦å›½é™… ERP å¸¸ç”¨ API å‚æ•°å¿«é€Ÿå‚è€ƒ

> åŸºäºæ™ºé‚¦å›½é™… ERP 32.17 ç‰ˆæœ¬  
> **æ³¨æ„**: ä»¥ä¸‹å‚æ•°åŸºäºç»éªŒæ¨æµ‹ï¼Œå®é™…ä½¿ç”¨æ—¶è¯·ä»¥å®˜æ–¹æ–‡æ¡£ä¸ºå‡†

---

## ğŸ“‹ å®¢æˆ·ç®¡ç† API

### è·å–å®¢æˆ·åˆ—è¡¨

**ç«¯ç‚¹**: `POST /webapi/v3/ov1/salesmanage/custom/list`

**è¯·æ±‚å‚æ•°**:

```json
{
  "pageindex": 1,              // é¡µç ï¼ˆä»1å¼€å§‹ï¼‰
  "pagesize": 20,              // æ¯é¡µæ•°é‡
  "keyword": "",               // æœç´¢å…³é”®è¯ï¼ˆå®¢æˆ·åç§°/ç”µè¯/å¤‡æ³¨ï¼‰
  "sort": 0,                   // å®¢æˆ·ç±»å‹: 0=å…¨éƒ¨, 1=å•ä½å®¢æˆ·, 2=ä¸ªäººå®¢æˆ·
  "source": "",                // å®¢æˆ·æ¥æºï¼ˆç•™ç©º=å…¨éƒ¨ï¼‰â­
  "charge": "",                // è´Ÿè´£äººIDï¼ˆç•™ç©º=å…¨éƒ¨ï¼‰
  "starttime": "",             // å¼€å§‹æ—¶é—´ "2025-01-01"
  "endtime": "",               // ç»“æŸæ—¶é—´ "2025-12-31"
  "status": ""                 // çŠ¶æ€: 0=å¾…å®¡æ ¸, 1=å·²å®¡æ ¸, ""=å…¨éƒ¨
}
```

**å“åº”å­—æ®µ**ï¼ˆæ¨æµ‹ï¼‰:

```json
{
  "success": true,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "list": [
      {
        "id": "12345",                    // å®¢æˆ·ID
        "name": "å¼ ä¸‰å…¬å¸",                // å®¢æˆ·åç§°ï¼ˆå®Œæ•´ï¼‰
        "telname": "å¼ ä¸‰",                 // å®¢æˆ·ç®€ç§°
        "sort": 1,                         // 1=å•ä½, 2=ä¸ªäºº
        "source": "å¾®ä¿¡",                  // å®¢æˆ·æ¥æº â­â­â­
        "linkman": "å¼ ç»ç†",               // è”ç³»äºº
        "tel": "13800138000",              // ç”µè¯
        "mobile": "13800138000",           // æ‰‹æœº
        "email": "zhang@example.com",      // é‚®ç®±
        "address": "é‡åº†å¸‚æ¸ä¸­åŒºXXè·¯",      // åœ°å€
        "remark": "é‡è¦å®¢æˆ·",               // å¤‡æ³¨
        "charge": "1001",                  // è´Ÿè´£äººID
        "chargename": "æé”€å”®",            // è´Ÿè´£äººå§“å
        "addtime": "2025-01-01 10:00:00",  // æ·»åŠ æ—¶é—´
        "lasttime": "2025-01-15 15:30:00", // æœ€åè·Ÿè¿›æ—¶é—´
        "status": 1,                       // 0=å¾…å®¡æ ¸, 1=å·²å®¡æ ¸
        "protect": 0,                      // æ˜¯å¦ä¿æŠ¤: 0=å¦, 1=æ˜¯
        "level": "VIP",                    // å®¢æˆ·çº§åˆ«
        "industry": "åˆ¶é€ ä¸š",              // æ‰€å±è¡Œä¸š
        "scale": "100-500äºº",              // ä¼ä¸šè§„æ¨¡
        "region": "é‡åº†",                  // æ‰€å±åŒºåŸŸ
        "website": "www.example.com",      // ç½‘å€
        "fax": "",                         // ä¼ çœŸ
        "zip": "400000"                    // é‚®ç¼–
      }
    ],
    "total": 150,              // æ€»è®°å½•æ•°
    "pageindex": 1,            // å½“å‰é¡µ
    "pagesize": 20             // æ¯é¡µæ•°é‡
  }
}
```

---

### æ·»åŠ å®¢æˆ·

**ç«¯ç‚¹**: `POST /webapi/v3/sales/customer/add`

**è¯·æ±‚å‚æ•°**ï¼ˆæ¨æµ‹ï¼‰:

```json
{
  "name": "å¼ ä¸‰å…¬å¸",              // å®¢æˆ·åç§°ï¼ˆå¿…å¡«ï¼‰
  "telname": "å¼ ä¸‰",               // å®¢æˆ·ç®€ç§°
  "sort": 1,                       // 1=å•ä½å®¢æˆ·, 2=ä¸ªäººå®¢æˆ·ï¼ˆå¿…å¡«ï¼‰
  "source": "å¾®ä¿¡",                // å®¢æˆ·æ¥æº â­â­â­
  "linkman": "å¼ ç»ç†",             // è”ç³»äºº
  "tel": "13800138000",            // ç”µè¯
  "mobile": "13800138000",         // æ‰‹æœº
  "email": "zhang@example.com",    // é‚®ç®±
  "address": "é‡åº†å¸‚æ¸ä¸­åŒºXXè·¯",    // åœ°å€
  "remark": "æ¥è‡ªå¾®ä¿¡å®¢æˆ·ä¸­å°",     // å¤‡æ³¨
  "charge": "1001",                // è´Ÿè´£äººIDï¼ˆå½“å‰ç”¨æˆ·IDï¼‰
  "level": "æ™®é€š",                 // å®¢æˆ·çº§åˆ«
  "industry": "",                  // æ‰€å±è¡Œä¸š
  "region": "é‡åº†",                // æ‰€å±åŒºåŸŸ
  "k_code": "K3208",               // è‡ªå®šä¹‰ç¼–ç ï¼ˆå¯é€‰ï¼‰
  // ä»¥ä¸‹ä¸ºæ‰©å±•å­—æ®µï¼ˆæ ¹æ®ç³»ç»Ÿé…ç½®ï¼‰
  "field1": "",                    // è‡ªå®šä¹‰å­—æ®µ1
  "field2": "",                    // è‡ªå®šä¹‰å­—æ®µ2
  ...
}
```

**å“åº”ç¤ºä¾‹**:

```json
{
  "success": true,
  "message": "æ·»åŠ æˆåŠŸ",
  "data": {
    "id": "12345"              // æ–°åˆ›å»ºçš„å®¢æˆ·ID
  }
}
```

---

### è·å–å®¢æˆ·è¯¦æƒ…

**ç«¯ç‚¹**: `POST /webapi/v3/ov1/salesmanage/custom/add?edit=1&apihelptype=get`

**è¯·æ±‚å‚æ•°**:

```json
{
  "id": "12345"                // å®¢æˆ·ID
}
```

**å“åº”**: åŒ…å«å®Œæ•´çš„å®¢æˆ·ä¿¡æ¯ï¼ˆå­—æ®µåŒ"æ·»åŠ å®¢æˆ·"ï¼‰

---

## ğŸ·ï¸ å®¢æˆ·æ¥æºå­—æ®µè¯¦è§£

### å­—æ®µå: `source`

**å¯èƒ½çš„å€¼**ï¼ˆåŸºäºæ™ºé‚¦å›½é™…æ ‡å‡†é…ç½®ï¼‰:

| å€¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|----|------|----------|
| `"å¾®ä¿¡"` | å¾®ä¿¡æ¸ é“ | å®¢æˆ·ä¸­å°åŒæ­¥ â­ |
| `"ç½‘ç»œ"` | ç½‘ç«™/åœ¨çº¿å’¨è¯¢ | å®˜ç½‘è¡¨å•æäº¤ |
| `"ç”µè¯"` | ç”µè¯å’¨è¯¢ | 400çƒ­çº¿ |
| `"é‚®ä»¶"` | é‚®ä»¶è”ç³» | Emailè¥é”€ |
| `"å±•ä¼š"` | å±•ä¼šè·å– | çº¿ä¸‹æ´»åŠ¨ |
| `"è€å®¢æˆ·ä»‹ç»"` | è½¬ä»‹ç» | å®¢æˆ·æ¨è |
| `"çº¿ä¸‹æ‹œè®¿"` | åœ°æ¨ | é”€å”®å¤–å‹¤ |
| `"å¹¿å‘Š"` | å¹¿å‘ŠæŠ•æ”¾ | ç™¾åº¦/æŠ–éŸ³å¹¿å‘Š |
| `"å…¶ä»–"` | å…¶ä»–æ¸ é“ | æœªåˆ†ç±» |
| `""` | ç©ºå­—ç¬¦ä¸² | æœªå¡«å†™ |

**æ³¨æ„**ï¼š
1. å®¢æˆ·æ¥æºé€šå¸¸æ˜¯**ç³»ç»Ÿé¢„è®¾çš„ä¸‹æ‹‰é€‰é¡¹**
2. å®é™…å€¼éœ€è¦åœ¨ERPç³»ç»Ÿä¸­æŸ¥çœ‹ `ç³»ç»Ÿç®¡ç† â†’ å®¢æˆ·æ¥æºè®¾ç½®`
3. éƒ¨åˆ†ç³»ç»Ÿå…è®¸è‡ªå®šä¹‰æ¥æºåç§°

---

## ğŸ’¡ å¦‚ä½•ç¡®è®¤å®é™…å­—æ®µå

### æ–¹æ³•1: æµè§ˆå™¨å¼€å‘è€…å·¥å…·ï¼ˆæ¨èï¼‰

1. åœ¨ERPç³»ç»Ÿä¸­æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªå®¢æˆ·
2. æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰â†’ Network æ ‡ç­¾
3. æäº¤è¡¨å•
4. æŸ¥çœ‹æäº¤çš„è¯·æ±‚ä½“ï¼ˆRequest Payloadï¼‰

**ç¤ºä¾‹**:
```json
// å®é™…æäº¤çš„æ•°æ®
{
  "name": "æµ‹è¯•å®¢æˆ·",
  "source": "å¾®ä¿¡",     // â† è¿™å°±æ˜¯å­—æ®µå
  "tel": "13800138000"
}
```

### æ–¹æ³•2: APIæ–‡æ¡£é¡µé¢

è®¿é—®å¹¶ç™»å½•ï¼š
```
http://ls1.jmt.ink:46088/sysn/view/OpenApi/help.ashx
```

å¯¼èˆªåˆ°ï¼š`é”€å”®æ ç›® â†’ å®¢æˆ·ç®¡ç† â†’ å®¢æˆ·å¯¹æ¥ â†’ è·å–å®¢æˆ·åˆ—è¡¨`

æŸ¥çœ‹å‚æ•°è¡¨æ ¼ã€‚

---

## ğŸ“Š å…¶ä»–å¸¸ç”¨APIå‚æ•°

### åˆåŒç®¡ç†

**è·å–åˆåŒåˆ—è¡¨**: `POST /webapi/v3/ov1/salesmanage/contract/billlist`

```json
{
  "pageindex": 1,
  "pagesize": 20,
  "keyword": "",           // åˆåŒç¼–å·/åç§°
  "custid": "",            // å®¢æˆ·ID
  "status": ""             // åˆåŒçŠ¶æ€
}
```

### äº§å“ç®¡ç†

**è·å–äº§å“åˆ—è¡¨**: `POST /webapi/v3/ov1/salesmanage/product/billlist`

```json
{
  "pageindex": 1,
  "pagesize": 20,
  "keyword": "",           // äº§å“åç§°/ç¼–å·
  "sortid": ""             // äº§å“åˆ†ç±»ID
}
```

### åº“å­˜æŸ¥è¯¢

**åº“å­˜æ±‡æ€»**: `POST /webapi/v3/store/inventory/InventorySummary`

```json
{
  "pageindex": 1,
  "pagesize": 20,
  "productid": "",         // äº§å“ID
  "warehouseid": ""        // ä»“åº“ID
}
```

---

## ğŸ”— Customer Hub é›†æˆç¤ºä¾‹

### å»ºæ¡£ååŒæ­¥åˆ°ERP

```python
from customer_hub.service import CustomerHubService
import requests

def sync_contact_to_erp(contact_id: str):
    """å°†Customer Hubå®¢æˆ·åŒæ­¥åˆ°ERP"""
    
    # 1. ä»Customer Hubè·å–è”ç³»äºº
    hub = CustomerHubService()
    contact = hub.repo.get_contact_by_id(contact_id)
    
    if not contact:
        return False
    
    # 2. æ˜ å°„å­—æ®µ
    erp_customer = {
        "name": contact.remark or contact.wx_id,
        "telname": contact.remark,
        "sort": 1,                    # å•ä½å®¢æˆ·
        "source": "å¾®ä¿¡",              # å®¢æˆ·æ¥æº â­
        "tel": "",                    # ä»å¾®ä¿¡æ— æ³•è·å–
        "remark": f"Kç¼–ç : {contact.k_code}, ç½®ä¿¡åº¦: {contact.confidence}",
        "k_code": contact.k_code,     # è‡ªå®šä¹‰å­—æ®µï¼ˆå¦‚æœERPæ”¯æŒï¼‰
    }
    
    # 3. è°ƒç”¨ERP API
    response = requests.post(
        'http://ls1.jmt.ink:46088/webapi/v3/sales/customer/add',
        headers={'Cookie': 'your_cookie'},
        json=erp_customer
    )
    
    if response.json().get('success'):
        erp_id = response.json()['data']['id']
        print(f"âœ… åŒæ­¥æˆåŠŸ: ERP ID = {erp_id}")
        
        # å¯ä»¥å°† ERP ID ä¿å­˜åˆ° Contact çš„æ‰©å±•å­—æ®µ
        return True
    else:
        print(f"âŒ åŒæ­¥å¤±è´¥: {response.json().get('message')}")
        return False
```

---

## âš ï¸ é‡è¦æç¤º

1. **ä»¥ä¸Šå‚æ•°ä¸ºç»éªŒæ¨æµ‹**
   - å®é™…å­—æ®µåå¯èƒ½ä¸åŒ
   - å¿…å¡«å­—æ®µå¯èƒ½æœ‰å·®å¼‚
   - æ•°æ®ç±»å‹éœ€éªŒè¯

2. **å»ºè®®éªŒè¯æ­¥éª¤**
   ```bash
   # 1. åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹å®˜æ–¹æ–‡æ¡£
   # 2. æˆ–å®é™…è°ƒç”¨APIæµ‹è¯•
   # 3. æ ¹æ®é”™è¯¯æç¤ºè°ƒæ•´å‚æ•°
   ```

3. **å­—æ®µåå¤§å°å†™**
   - æ™ºé‚¦å›½é™…é€šå¸¸ä½¿ç”¨**å°å†™**å­—æ®µå
   - å¦‚ `pageindex` è€Œé `pageIndex`
   - éƒ¨åˆ†æ–°ç‰ˆAPIå¯èƒ½ä½¿ç”¨é©¼å³°å‘½å

4. **æ—¶é—´æ ¼å¼**
   - é€šå¸¸ä¸º `"YYYY-MM-DD"` æˆ– `"YYYY-MM-DD HH:mm:ss"`
   - éœ€è¦å­—ç¬¦ä¸²æ ¼å¼ï¼Œä¸æ˜¯æ—¶é—´æˆ³

---

## ğŸ¯ é’ˆå¯¹æ‚¨çš„é—®é¢˜ï¼šå®¢æˆ·æ¥æºå­—æ®µ

**å­—æ®µå**: `source`  
**æ•°æ®ç±»å‹**: String  
**ç”¨é€”**:
- æ·»åŠ å®¢æˆ·æ—¶: æŒ‡å®šæ¥æº
- æŸ¥è¯¢å®¢æˆ·æ—¶: æŒ‰æ¥æºç­›é€‰
- è¿”å›æ•°æ®ä¸­: æ˜¾ç¤ºå®¢æˆ·æ¥æº

**æ¨èå€¼**: `"å¾®ä¿¡"` ï¼ˆç”¨äºå®¢æˆ·ä¸­å°åŒæ­¥ï¼‰

**éªŒè¯æ–¹æ³•**:
1. åœ¨ERPç³»ç»Ÿä¸­æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªå®¢æˆ·ï¼Œå¡«å†™æ¥æºä¸º"å¾®ä¿¡"
2. è°ƒç”¨"è·å–å®¢æˆ·åˆ—è¡¨"API
3. æŸ¥çœ‹è¿”å›çš„JSONä¸­è¯¥å®¢æˆ·çš„ `source` å­—æ®µå€¼
4. ç¡®è®¤å­—æ®µåå’Œå€¼æ ¼å¼

---

éœ€è¦æˆ‘å¸®æ‚¨åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹å…·ä½“çš„å‚æ•°æ–‡æ¡£å—ï¼Ÿæ‚¨å¯ä»¥ï¼š
1. æ‰“å¼€æ–‡æ¡£é¡µé¢
2. æˆªå›¾å‚æ•°è¡¨æ ¼
3. å‘ç»™æˆ‘ï¼Œæˆ‘å¸®æ‚¨æ•´ç†æˆå®Œæ•´çš„å‚æ•°è¯´æ˜

