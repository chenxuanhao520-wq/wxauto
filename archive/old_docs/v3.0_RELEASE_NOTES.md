# v3.0 版本发布说明

## 🎉 重大更新

本次 v3.0 版本是一次重大功能升级，完成了多模型支持和多维表格集成两大核心功能。

**发布日期**：2025-10-16  
**版本号**：v3.0.0

---

## ✨ 新增功能

### 1. 多模型支持（7个大模型提供商）

系统现已支持 7 个主流大模型提供商，只需配置相应的 API Key 即可切换使用：

#### 支持的提供商

| 提供商 | 关键字 | 推荐模型 | 特点 |
|--------|--------|----------|------|
| **OpenAI** | `openai` | gpt-4o-mini | 质量高、稳定、生产首选 |
| **DeepSeek** | `deepseek` | deepseek-chat | 性价比极高、国内快 |
| **Claude** | `claude` | claude-3-5-sonnet | 长文本、推理强 |
| **通义千问** | `qwen` | qwen-max | 阿里云、国内稳定 |
| **文心一言** | `ernie` | ernie-4.0 | 百度、中文优化 |
| **Gemini** | `gemini` | gemini-1.5-flash | Google、速度快 |
| **Moonshot** | `moonshot` | moonshot-v1-8k | Kimi、长上下文 |

#### 使用方法

**只需设置环境变量**：

```bash
# 选择一个或多个提供商
export OPENAI_API_KEY=sk-your-key
export DEEPSEEK_API_KEY=sk-your-key
export CLAUDE_API_KEY=sk-ant-your-key
# ...更多

# 系统会按照 config.yaml 中的配置自动选择
```

**主备降级**：

```yaml
llm:
  primary: openai:gpt-4o-mini   # 主提供商
  fallback: deepseek:chat        # 备用提供商
```

当主提供商失败时，自动切换到备用。

#### 新增文件

```
ai_gateway/
├── providers/
│   ├── __init__.py
│   ├── openai_provider.py      # OpenAI
│   ├── deepseek_provider.py    # DeepSeek
│   ├── claude_provider.py      # Claude
│   ├── qwen_provider.py         # 通义千问
│   ├── ernie_provider.py        # 文心一言
│   ├── gemini_provider.py       # Gemini
│   └── moonshot_provider.py     # Moonshot
└── gateway.py (已更新)          # 统一网关，支持所有提供商
```

---

### 2. 多维表格集成

支持将消息日志自动同步到飞书和钉钉多维表格，实现数据可视化和分析。

#### 支持的平台

- ✅ **飞书多维表格（Bitable）**
- ✅ **钉钉多维表格（智能表格）**

#### 功能特性

1. **自动同步**：批量同步消息日志到表格
2. **字段映射**：自动转换数据格式
3. **定时任务**：支持定时增量同步
4. **测试工具**：一键测试连接

#### 使用方法

**配置环境变量**：

```bash
# 飞书
export FEISHU_APP_ID=cli_xxxxx
export FEISHU_APP_SECRET=xxxxx
export FEISHU_BITABLE_TOKEN=bascnxxxxx
export FEISHU_TABLE_ID=tblxxxxx

# 钉钉
export DINGTALK_APP_KEY=dingtalkxxxxx
export DINGTALK_APP_SECRET=xxxxx
export DINGTALK_BASE_ID=xxxxx
export DINGTALK_TABLE_ID=xxxxx
```

**测试连接**：

```bash
python sync_to_bitable.py test --platform feishu
python sync_to_bitable.py test --platform dingtalk
```

**同步数据**：

```bash
# 同步最近 7 天数据
python sync_to_bitable.py sync --platform both --days 7
```

#### 新增文件

```
integrations/
├── __init__.py
├── feishu_bitable.py       # 飞书集成
└── dingtalk_bitable.py     # 钉钉集成

sync_to_bitable.py          # 同步工具脚本
```

---

## 📚 新增文档

1. **`docs/LLM_PROVIDERS.md`** - 大模型提供商配置指南
   - 详细介绍 7 个提供商的配置方法
   - API Key 获取步骤
   - 模型推荐和定价参考
   - 性能对比和成本优化建议

2. **`docs/MULTITABLE_INTEGRATION.md`** - 多维表格集成指南
   - 飞书/钉钉配置完整步骤
   - 表格字段结构说明
   - 同步工具使用方法
   - 数据分析示例
   - 常见问题解答

3. **`docs/v3.0_RELEASE_NOTES.md`** - 本文档

---

## 🔄 升级指南

### 从 v2.0 升级到 v3.0

#### 1. 更新代码

```bash
git pull origin main
# 或直接替换文件
```

#### 2. 安装新依赖

```bash
# Claude 支持（可选）
pip install anthropic>=0.18.0

# 或重新安装所有依赖
pip install -r requirements.txt
```

#### 3. 配置新功能

**多模型支持**：

```bash
# 选择你需要的提供商，设置对应的 API Key
export OPENAI_API_KEY=sk-xxxxx
export DEEPSEEK_API_KEY=sk-xxxxx
# ...
```

**多维表格集成**（可选）：

```bash
# 配置飞书或钉钉（或两者都配置）
export FEISHU_APP_ID=cli_xxxxx
export FEISHU_APP_SECRET=xxxxx
export FEISHU_BITABLE_TOKEN=bascnxxxxx
export FEISHU_TABLE_ID=tblxxxxx
```

#### 4. 测试运行

```bash
# 测试多模型
python main.py

# 测试多维表格
python sync_to_bitable.py test --platform both
```

---

## 🆕 vs 旧版本对比

### v3.0 vs v2.0

| 功能 | v2.0 | v3.0 |
|------|------|------|
| 大模型支持 | 2个（OpenAI, DeepSeek） | **7个** |
| AI 提供商扩展性 | 需要修改代码 | **只需配置环境变量** |
| 数据导出 | CSV | CSV + **多维表格** |
| 数据可视化 | 无 | **飞书/钉钉图表** |
| 批量同步 | 手动 | **自动化工具** |
| 文档完整度 | 基础 | **详尽指南** |

### v3.0 vs v1.0

- ✅ 从模板回复 → **7个AI模型可选**
- ✅ 从模拟检索 → **BM25知识库检索**
- ✅ 从手动统计 → **多维表格自动同步**
- ✅ 从单一模型 → **多模型自动降级**

---

## 🎯 使用示例

### 示例 1：切换大模型

```bash
# 使用 OpenAI（默认）
export OPENAI_API_KEY=sk-xxxxx
python main.py

# 切换到 DeepSeek（更便宜）
export DEEPSEEK_API_KEY=sk-xxxxx
# 修改 config.yaml: primary: deepseek:chat
python main.py

# 或使用 Claude（高质量）
export CLAUDE_API_KEY=sk-ant-xxxxx
# 修改 config.yaml: primary: claude:claude-3-5-sonnet
python main.py
```

### 示例 2：主备降级

```yaml
# config.yaml
llm:
  primary: openai:gpt-4o-mini    # 主力
  fallback: deepseek:chat         # 备用
  enable_fallback: true
```

当 OpenAI 失败时，自动使用 DeepSeek，确保服务不中断。

### 示例 3：多维表格数据分析

```bash
# 1. 同步数据到飞书
python sync_to_bitable.py sync --platform feishu --days 30

# 2. 在飞书中创建视图
# - 按日期分组：统计每日消息量
# - 按分支类型：分析直答/澄清/转人工比例
# - 按AI提供商：分析成本和质量

# 3. 创建仪表板
# - 实时监控 AI 性能
# - 成本趋势分析
# - 用户满意度追踪
```

---

## 💰 成本优化建议

### 策略 1：按场景选择模型

```bash
# 高质量场景 -> OpenAI GPT-4o
export OPENAI_MODEL=gpt-4o

# 一般场景 -> OpenAI mini 或 DeepSeek
export OPENAI_MODEL=gpt-4o-mini
# 或
export DEEPSEEK_MODEL=deepseek-chat

# 成本优先 -> DeepSeek
export DEEPSEEK_MODEL=deepseek-chat  # ¥0.1/百万tokens
```

### 策略 2：混合使用

```yaml
# 工作日使用 OpenAI（质量优先）
primary: openai:gpt-4o-mini

# 周末/低峰使用 DeepSeek（成本优先）
primary: deepseek:chat
```

### 策略 3：实时监控

使用多维表格实时监控每个提供商的：
- Token 消耗
- 平均成本
- 响应质量（置信度）
- 失败率

根据数据调整策略。

---

## 🐛 已知问题

### 1. ~~旧版 llm_provider.py 冲突~~

**状态**：已解决

原来的 `ai_gateway/llm_provider.py` 已被拆分为 `providers/` 目录下的多个文件。

如果遇到导入错误，请删除旧的 `llm_provider.py`。

### 2. Claude 需要额外依赖

**影响**：使用 Claude 时

**解决**：
```bash
pip install anthropic>=0.18.0
```

### 3. 文心一言 API Key 格式特殊

**格式**：`client_id:client_secret`

**示例**：
```bash
export ERNIE_API_KEY=your_client_id:your_client_secret
```

---

## 📊 性能提升

### 响应速度

根据实测（供参考）：

- **Gemini**: 1-2s（最快）
- **DeepSeek**: 1-3s
- **OpenAI**: 2-4s
- **Moonshot**: 2-4s
- **通义千问**: 2-4s
- **文心一言**: 2-5s
- **Claude**: 3-6s

### 成本对比

每百万 Token 成本（输入+输出平均）：

1. **DeepSeek**: ~¥0.1（最便宜）
2. **Gemini**: ~$0.5
3. **OpenAI mini**: ~$0.4
4. **通义千问**: ~$1
5. **Moonshot**: ~$1.5
6. **文心一言**: ~$2
7. **Claude**: ~$15（最贵）

---

## 🔜 未来计划

### v3.1（短期）

- [ ] 向量嵌入检索（提升RAG精度）
- [ ] 会话历史管理（多轮对话）
- [ ] 更多图表模板（飞书/钉钉）

### v3.2（中期）

- [ ] 图片识别（OCR）
- [ ] 语音识别（ASR）
- [ ] Web 管理后台

### v4.0（长期）

- [ ] MCP (Model Context Protocol) 支持
- [ ] 多模态输入（图片+文字）
- [ ] 实时流式响应

---

## 📞 技术支持

如遇问题：

1. **查看文档**
   - [大模型配置指南](LLM_PROVIDERS.md)
   - [多维表格集成指南](MULTITABLE_INTEGRATION.md)

2. **查看日志**
   ```bash
   tail -f logs/app.log
   ```

3. **健康检查**
   ```bash
   python ops_tools.py health
   ```

4. **测试工具**
   ```bash
   # 测试 AI
   python main.py
   
   # 测试表格
   python sync_to_bitable.py test --platform both
   ```

---

## 🎁 感谢

感谢使用本系统！v3.0 版本是一个重要的里程碑，希望新功能能帮助你更好地管理客服工作。

**主要改进**：
- ✅ 7个大模型随意切换
- ✅ 只需配置API Key，无需修改代码
- ✅ 多维表格自动同步，数据可视化
- ✅ 完整文档，开箱即用

**快速开始**：
```bash
# 1. 配置一个大模型
export OPENAI_API_KEY=sk-your-key

# 2. 运行系统
python main.py

# 3. 可选：配置多维表格
export FEISHU_APP_ID=cli_xxxxx
python sync_to_bitable.py test --platform feishu
```

---

**发布日期**：2025-10-16  
**版本**：v3.0.0  
**下一版本**：v3.1（计划中）

