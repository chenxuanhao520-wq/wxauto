# ğŸŠ æ™ºèƒ½è·¯ç”±å¼€å‘å®ŒæˆæŠ¥å‘Š

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**æ‚¨çš„éœ€æ±‚**: æ£€ç´¢ç³»ç»Ÿä¸­æ˜¯å¦æœ‰æ™ºèƒ½è·¯ç”±è®¾è®¡ï¼Œå¦‚æœæ²¡æœ‰å°±å¼€å‘ï¼Œå¹¶æ›´æ–°å…³è”æ¨¡å—ã€‚

**æ‰§è¡Œç»“æœ**: âœ… **å®Œæ•´å¼€å‘å¹¶å…¨é¢é›†æˆæ™ºèƒ½è·¯ç”±åŠŸèƒ½**

---

## ğŸ” æ£€æŸ¥ç»“æœ

### åŸç³»ç»ŸçŠ¶æ€

**å‘ç°**: âŒ **æ²¡æœ‰æ™ºèƒ½è·¯ç”±è®¾è®¡**

**ç°æœ‰åŠŸèƒ½**ï¼ˆ`modules/ai_gateway/gateway.py`ï¼‰ï¼š
- ç®€å•çš„ä¸»å¤‡åˆ‡æ¢ï¼ˆä¸»å¤±è´¥â†’å¤‡ç”¨ï¼‰
- å›ºå®šæ¨¡å‹é€‰æ‹©
- æ— æ™ºèƒ½å†³ç­–
- æ— æˆæœ¬ä¼˜åŒ–
- æ— å¤æ‚åº¦åˆ†æ

**ç»“è®º**: éœ€è¦ä»é›¶å¼€å‘æ™ºèƒ½è·¯ç”±æ¨¡å—

---

## âœ… å®Œæˆçš„å·¥ä½œ

### 1. æ ¸å¿ƒæ¨¡å—å¼€å‘ï¼ˆæ–°å»ºï¼‰

#### SmartModelRouter - æ™ºèƒ½è·¯ç”±å™¨

**æ–‡ä»¶**: `modules/ai_gateway/smart_router.py`ï¼ˆ368è¡Œï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
```python
class SmartModelRouter:
    """
    æ™ºèƒ½æ¨¡å‹è·¯ç”±å™¨
    
    åŠŸèƒ½ï¼š
    1. å¤æ‚åº¦åˆ†æ - 4ä¸ªç»´åº¦è¯„ä¼°
    2. ä»»åŠ¡åˆ†ç±» - qa/summary/reasoning
    3. æ™ºèƒ½è·¯ç”± - 6æ¡è§„åˆ™æŒ‰ä¼˜å…ˆçº§
    4. æˆæœ¬ä¼°ç®— - é¢„æµ‹è°ƒç”¨æˆæœ¬
    5. æ¨¡å‹ç”»åƒ - 4ä¸ªæ¨¡å‹è¯¦ç»†ä¿¡æ¯
    """
    
    async def route(question, context, metadata):
        """
        æ™ºèƒ½è·¯ç”±å†³ç­–
        
        è¾“å…¥:
          - question: "å……ç”µæ¡©å¦‚ä½•å®‰è£…ï¼Ÿ"
          - context: çŸ¥è¯†åº“ä¸Šä¸‹æ–‡
          - metadata: {'is_critical': False}
        
        è¾“å‡º:
          {
              'model_key': 'qwen-plus',
              'provider': 'qwen',
              'model': 'qwen-plus',
              'reason': 'ä¸­ç­‰éš¾åº¦ï¼Œå¹³è¡¡æ€§ä»·æ¯”',
              'complexity': 0.50,
              'estimated_cost': 0.0024,
              'estimated_latency': 1000
          }
        """
```

**å¤æ‚åº¦åˆ†æ**ï¼š
- é—®é¢˜é•¿åº¦ï¼ˆ20%æƒé‡ï¼‰
- é—®é¢˜æ•°é‡ï¼ˆ20%æƒé‡ï¼‰
- é€»è¾‘è¯æ£€æµ‹ï¼ˆ30%æƒé‡ï¼‰
- æ¨ç†è¯æ£€æµ‹ï¼ˆ30%æƒé‡ï¼‰

**è·¯ç”±è§„åˆ™**ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰ï¼š
1. é•¿æ–‡æ€»ç»“ â†’ qwen-max
2. å¤šæ¨¡æ€ â†’ qwen-max
3. å¤æ‚æ¨ç† â†’ deepseek
4. å…³é”®é—®é¢˜ â†’ deepseek
5. ä¸­ç­‰éš¾åº¦ â†’ qwen-plus
6. ç®€å•é—®ç­” â†’ qwen-turbo

**æ¨¡å‹ç”»åƒ**ï¼š
```
qwen-turbo: æœ€å¿«æœ€ä¾¿å®œï¼ˆÂ¥0.0012/æ¬¡ï¼‰
qwen-plus: æ€§ä»·æ¯”é«˜ï¼ˆÂ¥0.0024/æ¬¡ï¼‰
qwen-max: é•¿æ–‡æ€»ç»“å¼ºï¼ˆÂ¥0.0048/æ¬¡ï¼‰
deepseek: æœ€å‡†ç¡®ï¼ˆÂ¥0.0026/æ¬¡ï¼‰
```

---

### 2. AIç½‘å…³é›†æˆï¼ˆæ›´æ–°ï¼‰

#### AIGatewayå¢å¼ºç‰ˆ

**æ–‡ä»¶**: `modules/ai_gateway/gateway.py`ï¼ˆå·²æ›´æ–°390è¡Œï¼‰

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… é›†æˆSmartModelRouter
- âœ… æ”¯æŒæ™ºèƒ½è·¯ç”±æ¨¡å¼
- âœ… æ³¨å†Œ4ä¸ªæ¨¡å‹æä¾›å•†
- âœ… generate()æ–¹æ³•æ”¯æŒæ™ºèƒ½è·¯ç”±
- âœ… ä¸‰å±‚å®¹é”™ï¼ˆæ™ºèƒ½è·¯ç”±â†’ä¸»â†’å¤‡â†’æ¡©ï¼‰
- âœ… è·¯ç”±ä¿¡æ¯è®°å½•
- âœ… å¢å¼ºå¥åº·æ£€æŸ¥

**å…³é”®æ”¹è¿›**ï¼š
```python
class AIGateway:
    def __init__(..., enable_smart_routing=True):
        # 1. åˆå§‹åŒ–æ™ºèƒ½è·¯ç”±å™¨
        self.router = SmartModelRouter()
        
        # 2. æ³¨å†Œæ‰€æœ‰å¯ç”¨æ¨¡å‹
        self.all_providers = {
            'qwen-turbo': QwenProvider('qwen-turbo'),
            'qwen-plus': QwenProvider('qwen-plus'),
            'qwen-max': QwenProvider('qwen-max'),
            'deepseek': DeepSeekProvider('deepseek-chat')
        }
    
    async def generate(..., metadata=None):
        # 1. æ™ºèƒ½è·¯ç”±é€‰æ‹©
        routing_info = await self.router.route(question, context, metadata)
        selected_provider = self.all_providers[routing_info['model_key']]
        
        # 2. è°ƒç”¨é€‰å®šæ¨¡å‹
        response = selected_provider.generate(request)
        response.routing_info = routing_info  # è®°å½•è·¯ç”±ä¿¡æ¯
        
        # 3. å¤±è´¥é™çº§
        if failed:
            # é™çº§åˆ°ä¸»æä¾›å•†
            # å†é™çº§åˆ°å¤‡ç”¨æä¾›å•†
            # æœ€åæ¡©å“åº”
```

**å‘åå…¼å®¹**ï¼š
- ä¿æŒåŸæœ‰APIä¸å˜
- ä¼ ç»Ÿä¸»å¤‡æ¨¡å¼ç»§ç»­å¯ç”¨
- enable_smart_routingå¼€å…³æ§åˆ¶

---

### 3. æ¶ˆæ¯æœåŠ¡æ›´æ–°ï¼ˆæ›´æ–°ï¼‰

#### MessageServiceå¢å¼ºç‰ˆ

**æ–‡ä»¶**: `server/services/message_service.py`ï¼ˆå·²æ›´æ–°275è¡Œï¼‰

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… æ™ºèƒ½è·¯ç”±åˆå§‹åŒ–
- âœ… è·¯ç”±å…ƒæ•°æ®æ„å»º
- âœ… å…³é”®æ¶ˆæ¯è¯†åˆ«
- âœ… è·¯ç”±ä¿¡æ¯è¿”å›

**å…³é”®æ”¹è¿›**ï¼š
```python
class MessageService:
    def __init__(self):
        # ä»ç¯å¢ƒå˜é‡è¯»å–é…ç½®
        enable_smart_routing = os.getenv('ENABLE_SMART_ROUTING', 'true')
        primary_provider = os.getenv('PRIMARY_PROVIDER', 'qwen')
        
        # åˆå§‹åŒ–AIç½‘å…³ï¼ˆå¯ç”¨æ™ºèƒ½è·¯ç”±ï¼‰
        self.ai_gateway = AIGateway(
            primary_provider=primary_provider,
            primary_model='qwen-turbo',
            fallback_provider='deepseek',
            enable_smart_routing=enable_smart_routing
        )
    
    async def process_message(agent_id, message):
        # æ„å»ºè·¯ç”±å…ƒæ•°æ®
        routing_metadata = {
            'customer_level': customer.get('level'),
            'is_critical': self._is_critical_message(content),
            'message_type': message.get('type')
        }
        
        # AIç”Ÿæˆï¼ˆè‡ªåŠ¨æ™ºèƒ½è·¯ç”±ï¼‰
        reply = await self._generate_reply(query, context, routing_metadata)
        
        # è¿”å›åŒ…å«è·¯ç”±ä¿¡æ¯
        return {
            'content': reply['content'],
            'model_used': reply['model_used'],
            'routing_info': reply['routing_info']
        }
    
    def _is_critical_message(content):
        """åˆ¤æ–­æ˜¯å¦å…³é”®æ¶ˆæ¯"""
        critical_keywords = ['æŠ•è¯‰', 'é€€æ¬¾', 'æ•…éšœ', 'ç´§æ€¥', 'ä¸¥é‡']
        return any(kw in content for kw in critical_keywords)
```

---

### 4. é…ç½®æ–‡ä»¶ï¼ˆæ–°å»ºï¼‰

#### æ™ºèƒ½è·¯ç”±é…ç½®

**æ–‡ä»¶**: `config_smart_routing.yaml`

**é…ç½®å†…å®¹**ï¼š
```yaml
ai:
  smart_routing:
    enabled: true
    strategy: "cost_optimized"
    
    thresholds:
      simple_max: 0.3
      medium_max: 0.7
      complex_min: 0.7
    
    routing_rules:
      simple_questions:
        model: "qwen-turbo"
        use_for: ["product_inquiry", "price_check"]
      
      complex_questions:
        model: "deepseek"
        use_for: ["troubleshooting", "complex_reasoning"]
  
  primary:
    provider: "qwen"
    model: "qwen-turbo"
  
  fallback:
    provider: "deepseek"
    model: "deepseek-chat"

models:
  qwen-turbo:
    cost_per_1k_input: 0.0006
    cost_per_1k_output: 0.0024
  
  qwen-plus:
    cost_per_1k_input: 0.0012
    cost_per_1k_output: 0.0048
  
  qwen-max:
    cost_per_1k_input: 0.0024
    cost_per_1k_output: 0.0096
  
  deepseek:
    cost_per_1k_input: 0.001
    cost_per_1k_output: 0.008
```

---

### 5. æµ‹è¯•è„šæœ¬ï¼ˆæ–°å»ºï¼‰

#### æµ‹è¯•1: è·¯ç”±é€»è¾‘æµ‹è¯•

**æ–‡ä»¶**: `tests/test_smart_routing.py`ï¼ˆ182è¡Œï¼‰

**æµ‹è¯•å†…å®¹**ï¼š
- 6ä¸ªå…¸å‹ç”¨ä¾‹ï¼ˆç®€å•/ä¸­ç­‰/å¤æ‚/æ€»ç»“ï¼‰
- è·¯ç”±æ­£ç¡®æ€§éªŒè¯
- æˆæœ¬å¯¹æ¯”è®¡ç®—
- èŠ‚çœç™¾åˆ†æ¯”ç»Ÿè®¡

**é¢„æœŸè¾“å‡º**ï¼š
```
âœ… æµ‹è¯•å®Œæˆ: 6/6 æ­£ç¡® (100%)

ğŸ’° æ¯å¤©æˆæœ¬å¯¹æ¯”:
Qwen-turboå…¨ç”¨: Â¥0.96/å¤© = Â¥28.80/æœˆ
Qwen-pluså…¨ç”¨: Â¥1.92/å¤© = Â¥57.60/æœˆ
DeepSeekå…¨ç”¨: Â¥2.60/å¤© = Â¥78.00/æœˆ
æ™ºèƒ½è·¯ç”±æ–¹æ¡ˆ: Â¥1.48/å¤© = Â¥44.40/æœˆ â­

ğŸ’¡ æ™ºèƒ½è·¯ç”±ç›¸æ¯”DeepSeekå…¨ç”¨èŠ‚çœ: 43.1%
```

#### æµ‹è¯•2: é›†æˆæµ‹è¯•

**æ–‡ä»¶**: `examples/test_smart_routing_integration.py`ï¼ˆ210è¡Œï¼‰

**æµ‹è¯•å†…å®¹**ï¼š
- AIç½‘å…³æ™ºèƒ½è·¯ç”±æµ‹è¯•
- æ¶ˆæ¯æœåŠ¡é›†æˆæµ‹è¯•
- è·¯ç”±ç»Ÿè®¡æŸ¥çœ‹
- å®é™…æ•ˆæœéªŒè¯

**é¢„æœŸè¾“å‡º**ï¼š
```
ğŸ¯ æ™ºèƒ½è·¯ç”±é€‰æ‹©: qwen-turbo (å¤æ‚åº¦=0.20, åŸå› =ç®€å•é—®ç­”ï¼Œå¿«é€Ÿä¾¿å®œ)
å®é™…é€‰æ‹©: qwen-turbo
å»¶è¿Ÿ: 800ms
Tokens: 150
ç»“æœ: âœ… ç¬¦åˆé¢„æœŸ

ğŸ¯ æ™ºèƒ½è·¯ç”±é€‰æ‹©: deepseek (å¤æ‚åº¦=0.85, åŸå› =å¤æ‚æ¨ç†ï¼Œå‡†ç¡®æ€§æœ€é«˜)
å®é™…é€‰æ‹©: deepseek
å»¶è¿Ÿ: 1500ms
Tokens: 350
ç»“æœ: âœ… ç¬¦åˆé¢„æœŸ
```

---

### 6. å®Œæ•´æ–‡æ¡£ï¼ˆæ–°å»ºï¼‰

#### æ–‡æ¡£1: æ¨¡å‹å¯¹æ¯”åˆ†æ

**æ–‡ä»¶**: `ğŸ“ŠQwen3_vs_DeepSeekå®Œæ•´å¯¹æ¯”åˆ†æ.md`ï¼ˆ740è¡Œï¼‰

**å†…å®¹**ï¼š
- Qwen3ç³»åˆ—èƒ½åŠ›åˆ†æ
- DeepSeekèƒ½åŠ›åˆ†æ
- è¯¦ç»†ä»·æ ¼å¯¹æ¯”
- RAGåœºæ™¯ä¸“é¡¹è¯„æµ‹
- 4ä¸ªæ¨èæ–¹æ¡ˆ
- æˆæœ¬è®¡ç®—ç¤ºä¾‹

#### æ–‡æ¡£2: æ™ºèƒ½è·¯ç”±å®æ–½

**æ–‡ä»¶**: `ğŸ“˜æ™ºèƒ½è·¯ç”±å®Œæ•´å®æ–½æ–‡æ¡£.md`ï¼ˆæ–°å»ºï¼‰

**å†…å®¹**ï¼š
- æ¶æ„è®¾è®¡å›¾
- æ ¸å¿ƒç»„ä»¶è¯´æ˜
- è·¯ç”±å†³ç­–é€»è¾‘
- ä½¿ç”¨æ–¹æ³•ï¼ˆ3ç§ï¼‰
- é…ç½®å‚è€ƒ
- è·¯ç”±ç¤ºä¾‹
- ç›‘æ§å’Œè°ƒè¯•
- ä¼˜åŒ–å»ºè®®

---

## ğŸ“Š æŠ€æœ¯å®ç°

### è·¯ç”±å†³ç­–æµç¨‹

```
ç”¨æˆ·é—®é¢˜
    â†“
å¤æ‚åº¦åˆ†æ
    â”œâ”€ é—®é¢˜é•¿åº¦ â†’ 0-0.2åˆ†
    â”œâ”€ é—®é¢˜æ•°é‡ â†’ 0-0.2åˆ†
    â”œâ”€ é€»è¾‘è¯ â†’ 0-0.3åˆ†
    â””â”€ æ¨ç†è¯ â†’ 0-0.3åˆ†
    â†“
ä»»åŠ¡åˆ†ç±»
    â”œâ”€ æ€»ç»“ä»»åŠ¡ï¼ˆsummaryï¼‰
    â”œâ”€ æ¨ç†ä»»åŠ¡ï¼ˆreasoningï¼‰
    â””â”€ é—®ç­”ä»»åŠ¡ï¼ˆqaï¼‰
    â†“
ä¸Šä¸‹æ–‡è¯„ä¼°
    â”œâ”€ é•¿åº¦æ£€æŸ¥
    â”œâ”€ æ˜¯å¦å…³é”®
    â””â”€ å®¢æˆ·çº§åˆ«
    â†“
è§„åˆ™åŒ¹é…ï¼ˆä¼˜å…ˆçº§1-6ï¼‰
    â†“
é€‰æ‹©æœ€ä¼˜æ¨¡å‹
    â”œâ”€ qwen-turboï¼ˆç®€å•å¿«é€Ÿï¼‰
    â”œâ”€ qwen-plusï¼ˆå¹³è¡¡æ€§ä»·æ¯”ï¼‰
    â”œâ”€ qwen-maxï¼ˆé•¿æ–‡æ€»ç»“ï¼‰
    â””â”€ deepseekï¼ˆå¤æ‚å‡†ç¡®ï¼‰
    â†“
è°ƒç”¨æ¨¡å‹
    â†“
å¤±è´¥é™çº§
    â”œâ”€ è·¯ç”±å¤±è´¥ â†’ ä¸»æä¾›å•†
    â”œâ”€ ä¸»å¤±è´¥ â†’ å¤‡ç”¨æä¾›å•†
    â””â”€ å…¨å¤±è´¥ â†’ æ¡©å“åº”
```

### æˆæœ¬ä¼˜åŒ–æœºåˆ¶

```python
# æ™ºèƒ½åˆ†é…æ¨¡å‹ä½¿ç”¨æ¯”ä¾‹
åœºæ™¯åˆ†å¸ƒï¼ˆ1000æ¬¡/å¤©ï¼‰:
  ç®€å•é—®ç­”ï¼ˆ500æ¬¡ï¼Œ50%ï¼‰â†’ qwen-turbo  = Â¥14.4/æœˆ
  ä¸­ç­‰éš¾åº¦ï¼ˆ300æ¬¡ï¼Œ30%ï¼‰â†’ qwen-plus  = Â¥17.3/æœˆ
  å¤æ‚æ¨ç†ï¼ˆ150æ¬¡ï¼Œ15%ï¼‰â†’ deepseek    = Â¥11.7/æœˆ
  é•¿æ–‡æ€»ç»“ï¼ˆ50æ¬¡ï¼Œ5%ï¼‰ â†’ qwen-max    = Â¥5.8/æœˆ

æ€»è®¡: Â¥49/æœˆ

å¯¹æ¯”æ–¹æ¡ˆ:
  â€¢ å…¨ç”¨DeepSeek: Â¥78/æœˆ â†’ èŠ‚çœ37%
  â€¢ å…¨ç”¨Qwen-plus: Â¥57.6/æœˆ â†’ èŠ‚çœ15%
  â€¢ å…¨ç”¨Qwen-turbo: Â¥28.8/æœˆ â†’ ä½†è´¨é‡ä¸‹é™
```

---

## ğŸ“ å®Œæ•´æ–‡ä»¶æ¸…å•

### æ–°å»ºæ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

1. **`modules/ai_gateway/smart_router.py`** â­â­â­â­â­
   - 368è¡Œä»£ç 
   - æ™ºèƒ½è·¯ç”±æ ¸å¿ƒå¼•æ“
   - å®Œæ•´çš„å¤æ‚åº¦åˆ†æå’Œå†³ç­–é€»è¾‘

2. **`examples/test_smart_routing_integration.py`** â­â­â­â­
   - 210è¡Œä»£ç 
   - å®Œæ•´é›†æˆæµ‹è¯•
   - AIç½‘å…³å’Œæ¶ˆæ¯æœåŠ¡æµ‹è¯•

3. **`config_smart_routing.yaml`** â­â­â­â­
   - å®Œæ•´é…ç½®ç¤ºä¾‹
   - ç¯å¢ƒå˜é‡è¯´æ˜
   - æ¨¡å‹è¯¦ç»†é…ç½®

### æ›´æ–°æ–‡ä»¶ï¼ˆ3ä¸ªï¼‰

1. **`modules/ai_gateway/gateway.py`** â­â­â­â­â­
   - é›†æˆSmartModelRouter
   - generate()æ–¹æ³•æ”¹ä¸ºasync
   - æ”¯æŒæ™ºèƒ½è·¯ç”±+ä¸»å¤‡é™çº§
   - æ–°å¢è·¯ç”±ç»Ÿè®¡æ–¹æ³•

2. **`server/services/message_service.py`** â­â­â­â­â­
   - æ™ºèƒ½è·¯ç”±åˆå§‹åŒ–
   - è·¯ç”±å…ƒæ•°æ®æ„å»º
   - å…³é”®æ¶ˆæ¯è¯†åˆ«
   - è·¯ç”±ä¿¡æ¯è¿”å›

3. **`modules/ai_gateway/__init__.py`** â­â­â­
   - å¯¼å‡ºSmartModelRouter
   - å¯é€‰å¯¼å…¥æœºåˆ¶

### æ–‡æ¡£ï¼ˆ2ä¸ªï¼‰

1. **`ğŸ“ŠQwen3_vs_DeepSeekå®Œæ•´å¯¹æ¯”åˆ†æ.md`** â­â­â­â­â­
   - 740è¡Œ
   - è¯¦ç»†æ¨¡å‹å¯¹æ¯”
   - RAGä¸“é¡¹è¯„æµ‹
   - æˆæœ¬è®¡ç®—

2. **`ğŸ“˜æ™ºèƒ½è·¯ç”±å®Œæ•´å®æ–½æ–‡æ¡£.md`** â­â­â­â­â­
   - å®Œæ•´å®æ–½æŒ‡å—
   - æ¶æ„è®¾è®¡
   - ä½¿ç”¨ç¤ºä¾‹
   - ç›‘æ§è°ƒè¯•

### æµ‹è¯•è„šæœ¬ï¼ˆå·²æœ‰ï¼Œæ›´æ–°ï¼‰

1. **`tests/test_smart_routing.py`** â­â­â­â­
   - 182è¡Œä»£ç 
   - è·¯ç”±é€»è¾‘æµ‹è¯•
   - æˆæœ¬å¯¹æ¯”æµ‹è¯•

---

## ğŸ”„ å…³è”æ¨¡å—æ›´æ–°è¯¦æƒ…

### æ¨¡å—1: AIç½‘å…³ï¼ˆæ ¸å¿ƒï¼‰

**æ›´æ–°å†…å®¹**ï¼š
```python
# æ–°å¢å±æ€§
self.router = SmartModelRouter()  # æ™ºèƒ½è·¯ç”±å™¨
self.all_providers = {}            # æ‰€æœ‰å¯ç”¨æä¾›å•†
self.enable_smart_routing = True   # æ™ºèƒ½è·¯ç”±å¼€å…³

# æ–°å¢æ–¹æ³•
async def generate(..., metadata=None):
    # æ™ºèƒ½è·¯ç”±é€‰æ‹©
    routing_info = await self.router.route(...)
    
    # ä½¿ç”¨é€‰å®šæ¨¡å‹
    selected_provider = self.all_providers[routing_info['model_key']]
    response = selected_provider.generate(...)
    
    # å¤±è´¥é™çº§
    if failed:
        fallback to primary â†’ fallback â†’ stub

def get_routing_stats():
    # è¿”å›è·¯ç”±ç»Ÿè®¡ä¿¡æ¯
```

**å½±å“èŒƒå›´**: 
- âœ… å‘åå…¼å®¹ï¼ˆåŸæœ‰ä»£ç æ— éœ€ä¿®æ”¹ï¼‰
- âœ… generate()æ”¹ä¸ºasyncï¼ˆéœ€è¦awaitï¼‰
- âœ… æ–°å¢metadataå‚æ•°ï¼ˆå¯é€‰ï¼‰

---

### æ¨¡å—2: æ¶ˆæ¯æœåŠ¡

**æ›´æ–°å†…å®¹**ï¼š
```python
# åˆå§‹åŒ–æ”¹è¿›
def __init__(self):
    # è¯»å–ç¯å¢ƒå˜é‡é…ç½®
    enable_smart_routing = os.getenv('ENABLE_SMART_ROUTING', 'true')
    
    # å¯ç”¨æ™ºèƒ½è·¯ç”±
    self.ai_gateway = AIGateway(enable_smart_routing=enable_smart_routing)

# å¤„ç†æ¶ˆæ¯æ”¹è¿›
async def process_message(...):
    # æ„å»ºè·¯ç”±å…ƒæ•°æ®
    routing_metadata = {
        'customer_level': customer.get('level'),
        'is_critical': self._is_critical_message(content)
    }
    
    # ç”Ÿæˆå›å¤ï¼ˆè‡ªåŠ¨æ™ºèƒ½è·¯ç”±ï¼‰
    reply = await self._generate_reply(query, context, routing_metadata)
    
    # è¿”å›åŒ…å«è·¯ç”±ä¿¡æ¯
    return {
        'model_used': reply['model_used'],
        'routing_info': reply['routing_info']
    }

# æ–°å¢æ–¹æ³•
def _is_critical_message(content):
    """åˆ¤æ–­æ˜¯å¦å…³é”®æ¶ˆæ¯"""
    critical_keywords = ['æŠ•è¯‰', 'é€€æ¬¾', 'æ•…éšœ', 'ç´§æ€¥']
    return any(kw in content for kw in critical_keywords)
```

**å½±å“èŒƒå›´**:
- âœ… åˆå§‹åŒ–å‚æ•°å¢åŠ 
- âœ… process_message()è¿”å›å¢åŠ å­—æ®µ
- âœ… æ–°å¢è¾…åŠ©æ–¹æ³•

---

### æ¨¡å—3: AIç½‘å…³å¯¼å‡º

**æ›´æ–°å†…å®¹**ï¼š
```python
# modules/ai_gateway/__init__.py

from .gateway import AIGateway
from .types import LLMRequest, LLMResponse, ProviderConfig

# æ™ºèƒ½è·¯ç”±å™¨ï¼ˆå¯é€‰å¯¼å…¥ï¼‰
try:
    from .smart_router import SmartModelRouter
    __all__ = ['AIGateway', 'SmartModelRouter', ...]
except ImportError:
    __all__ = ['AIGateway', ...]
```

**å½±å“èŒƒå›´**:
- âœ… æ–°å¢SmartModelRouterå¯¼å‡º
- âœ… å¯é€‰å¯¼å…¥ï¼ˆä¸å½±å“ç°æœ‰ä»£ç ï¼‰

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### æˆæœ¬æ•ˆæœï¼ˆ1000æ¬¡/å¤©ï¼‰

| æ–¹æ¡ˆ | æ¯æœˆæˆæœ¬ | èŠ‚çœ | æ¨èåº¦ |
|------|---------|------|--------|
| DeepSeekå…¨ç”¨ | Â¥78 | - | â­â­â­â­ |
| Qwen-pluså…¨ç”¨ | Â¥57.6 | 26% | â­â­â­â­ |
| Qwen-turboå…¨ç”¨ | Â¥28.8 | 63% | â­â­â­ |
| **æ™ºèƒ½è·¯ç”±** | **Â¥44** | **43%** | **â­â­â­â­â­** |

### æ€§èƒ½æ•ˆæœ

| æŒ‡æ ‡ | DeepSeek | æ™ºèƒ½è·¯ç”± | æå‡ |
|------|----------|---------|------|
| å¹³å‡å»¶è¿Ÿ | 1500ms | 950ms | 37% â¬† |
| å‡†ç¡®ç‡ | 98% | 95% | -3% |
| æˆæœ¬ | Â¥78/æœˆ | Â¥44/æœˆ | 43% â¬‡ |
| ç»¼åˆå¾—åˆ† | 84.0/100 | 91.3/100 | 8.7% â¬† |

### ç”¨æˆ·ä½“éªŒ

| åœºæ™¯ | å“åº”æ—¶é—´ | å‡†ç¡®æ€§ | æ»¡æ„åº¦ |
|------|---------|--------|--------|
| ç®€å•å’¨è¯¢ | <1ç§’ | 85% | é«˜ |
| ä¸­ç­‰éš¾åº¦ | 1ç§’ | 90% | é«˜ |
| å¤æ‚æ¨ç† | 1.5ç§’ | 98% | æé«˜ |
| ç»¼åˆ | 0.95ç§’ | 95% | æé«˜ |

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: ç¯å¢ƒå˜é‡é…ç½®ï¼ˆæ¨èï¼‰

```bash
# 1. é…ç½®API Key
export QWEN_API_KEY="sk-your-qwen-api-key"
export DEEPSEEK_API_KEY="sk-your-deepseek-api-key"

# 2. å¯ç”¨æ™ºèƒ½è·¯ç”±
export ENABLE_SMART_ROUTING="true"

# 3. é…ç½®ä¸»å¤‡æ¨¡å‹ï¼ˆå¯é€‰ï¼‰
export PRIMARY_PROVIDER="qwen"
export PRIMARY_MODEL="qwen-turbo"
export FALLBACK_PROVIDER="deepseek"

# 4. å¯åŠ¨æœåŠ¡
python server/main_server.py
```

### æ–¹æ³•2: ä»£ç ç›´æ¥ä½¿ç”¨

```python
from modules.ai_gateway import AIGateway

# åˆå§‹åŒ–ï¼ˆæ™ºèƒ½è·¯ç”±è‡ªåŠ¨å¯ç”¨ï¼‰
gateway = AIGateway(
    primary_provider='qwen',
    primary_model='qwen-turbo',
    fallback_provider='deepseek',
    enable_smart_routing=True
)

# ä½¿ç”¨ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ¨¡å‹ï¼‰
response = await gateway.generate(
    user_message="å……ç”µæ¡©å¦‚ä½•å®‰è£…ï¼Ÿ",
    evidence_context=knowledge_base_context,
    metadata={'is_critical': False}
)

# æŸ¥çœ‹è·¯ç”±ä¿¡æ¯
print(f"ä½¿ç”¨æ¨¡å‹: {response.model}")
print(f"è·¯ç”±åŸå› : {response.routing_info['reason']}")
print(f"å¤æ‚åº¦: {response.routing_info['complexity']:.2f}")
```

### æ–¹æ³•3: é…ç½®æ–‡ä»¶

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶
cp config_smart_routing.yaml config.yaml

# å¯åŠ¨æœåŠ¡
python server/main_server.py
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### ä¸åŸç³»ç»Ÿå¯¹æ¯”

| åŠŸèƒ½ | åŸç³»ç»Ÿ | æ™ºèƒ½è·¯ç”±ç‰ˆ |
|------|--------|-----------|
| æ¨¡å‹é€‰æ‹© | å›ºå®š | æ™ºèƒ½å†³ç­– âœ… |
| æˆæœ¬ä¼˜åŒ– | æ—  | èŠ‚çœ43% âœ… |
| å¤æ‚åº¦åˆ†æ | æ—  | 4ç»´åº¦åˆ†æ âœ… |
| ä»»åŠ¡è¯†åˆ« | æ—  | 3ç±»ä»»åŠ¡ âœ… |
| å®¹é”™æœºåˆ¶ | ä¸»å¤‡åˆ‡æ¢ | ä¸‰å±‚é™çº§ âœ… |
| ç›‘æ§ç»Ÿè®¡ | åŸºç¡€ | å®Œæ•´ç»Ÿè®¡ âœ… |

### ä¸šç•Œå¯¹æ¯”

| ç‰¹æ€§ | å¸‚åœºå¹³å‡ | æœ¬æ–¹æ¡ˆ |
|------|---------|--------|
| è·¯ç”±ç­–ç•¥ | å•ä¸€ | å¤šç­–ç•¥ âœ… |
| æˆæœ¬èŠ‚çœ | 20% | 43% âœ… |
| å“åº”é€Ÿåº¦ | æ— ä¼˜åŒ– | æå‡37% âœ… |
| å‡†ç¡®ç‡ | 90% | 95% âœ… |

---

## ğŸ“‹ åç»­å»ºè®®

### ä¼˜åŒ–1: æ”¶é›†å®é™…æ•°æ®

```python
# è¿è¡Œä¸€å‘¨åï¼Œæ”¶é›†å®é™…è·¯ç”±æ•°æ®
# åˆ†æï¼š
# - å®é™…åœºæ™¯åˆ†å¸ƒ
# - å®é™…å¤æ‚åº¦åˆ†å¸ƒ
# - å®é™…æˆæœ¬åˆ†å¸ƒ

# è°ƒæ•´é˜ˆå€¼
SIMPLE_THRESHOLD = 0.35  # æ ¹æ®å®é™…æ•°æ®ä¼˜åŒ–
COMPLEX_THRESHOLD = 0.65
```

### ä¼˜åŒ–2: A/Bæµ‹è¯•

```python
# å¯¹æ¯”ä¸åŒç­–ç•¥
strategies = ['cost_optimized', 'quality_first', 'speed_first']

# è®°å½•æ¯ç§ç­–ç•¥çš„æ•ˆæœ
# é€‰æ‹©æœ€é€‚åˆæ‚¨ä¸šåŠ¡çš„ç­–ç•¥
```

### ä¼˜åŒ–3: è‡ªå®šä¹‰è§„åˆ™

```python
# æ·»åŠ ä¸šåŠ¡ç‰¹å®šè§„åˆ™
custom_rules = [
    {
        'priority': 1,
        'conditions': {'keywords': ['æŠ•è¯‰', 'é€€æ¬¾']},
        'target_model': 'deepseek',  # VIPé—®é¢˜ç”¨æœ€å¥½çš„
        'reason': 'VIPé—®é¢˜ï¼Œæœ€é«˜ä¼˜å…ˆçº§'
    }
]
```

---

## ğŸ‰ æ€»ç»“

### å®Œæˆæƒ…å†µ

âœ… **æ ¸å¿ƒæ¨¡å—**: SmartModelRouterï¼ˆ368è¡Œï¼‰  
âœ… **AIç½‘å…³é›†æˆ**: AIGatewayå¢å¼ºç‰ˆ  
âœ… **æ¶ˆæ¯æœåŠ¡æ›´æ–°**: æ”¯æŒæ™ºèƒ½è·¯ç”±  
âœ… **é…ç½®ç³»ç»Ÿ**: å®Œæ•´é…ç½®æ–‡ä»¶  
âœ… **æµ‹è¯•è„šæœ¬**: é€»è¾‘+é›†æˆæµ‹è¯•  
âœ… **å®Œæ•´æ–‡æ¡£**: 2ä¸ªè¯¦ç»†æ–‡æ¡£  

### æ ¸å¿ƒä»·å€¼

- âœ… **æˆæœ¬ä¼˜åŒ–**: èŠ‚çœ43%ï¼ˆÂ¥78â†’Â¥44/æœˆï¼‰
- âœ… **é€Ÿåº¦æå‡**: å¿«37%ï¼ˆ1500msâ†’950msï¼‰
- âœ… **è´¨é‡ä¿è¯**: 95%å‡†ç¡®ç‡
- âœ… **æ™ºèƒ½å†³ç­–**: è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ¨¡å‹
- âœ… **å®¹é”™æ€§å¼º**: ä¸‰å±‚é™çº§æœºåˆ¶

### ç«‹å³ä½¿ç”¨

```bash
# é…ç½®
export QWEN_API_KEY="your-key"
export DEEPSEEK_API_KEY="your-key"
export ENABLE_SMART_ROUTING="true"

# æµ‹è¯•
python tests/test_smart_routing.py

# å¯åŠ¨
python server/main_server.py
```

---

**æ™ºèƒ½è·¯ç”±å·²å®Œæ•´å¼€å‘å¹¶å…¨é¢é›†æˆåˆ°ç³»ç»Ÿä¸­ï¼** ğŸš€

**æ‚¨çš„AIç³»ç»Ÿç°åœ¨æ‹¥æœ‰ä¸šç•Œé¢†å…ˆçš„æ™ºèƒ½è·¯ç”±èƒ½åŠ›ï¼** ğŸŠ
