# 微信自动化防封号指南

本文档提供使用 wxauto 时避免被微信检测封号的完整方案。

---

## ⚠️ 风险评估

### wxauto 的工作原理

wxauto 通过 **Windows UI 自动化**（类似按键精灵）模拟人工操作：
- 通过 Windows API 查找微信窗口
- 模拟鼠标点击和键盘输入
- 读取屏幕元素获取消息

### 被检测的风险

| 风险点 | 风险等级 | 说明 |
|--------|---------|------|
| 频繁操作 | 🔴 高 | 发送消息过快、过于规律 |
| 操作特征 | 🟡 中 | 机器操作模式与人类不同 |
| 群发广告 | 🔴 高 | 群发、重复内容 |
| 批量加好友 | 🔴 高 | 频繁加人 |
| 异常登录 | 🟡 中 | 异地登录、多设备 |

**好消息**：我们的客服场景风险相对较低，因为：
- ✅ 被动响应（不主动发送）
- ✅ 白名单机制（只在指定群）
- ✅ 已有频控机制

---

## 🛡️ 防封号策略

### 策略1：行为拟人化（必须）✨

#### 1.1 随机延迟

```python
import random
import time

# 发送消息前随机延迟
delay = random.uniform(1.0, 3.0)  # 1-3秒
time.sleep(delay)

# 打字延迟（模拟打字速度）
typing_delay = len(message) * random.uniform(0.05, 0.15)  # 每个字50-150ms
time.sleep(typing_delay)
```

#### 1.2 非规律性操作

```python
# 避免精确的时间间隔
# ❌ 错误：每隔正好500ms检查
time.sleep(0.5)

# ✅ 正确：随机间隔
time.sleep(random.uniform(0.3, 0.8))
```

#### 1.3 模拟人类行为

```python
# 偶尔"思考"一下
if random.random() < 0.1:  # 10%概率
    time.sleep(random.uniform(3, 8))  # 思考3-8秒

# 偶尔"休息"一下
if random.random() < 0.05:  # 5%概率
    logger.info("模拟人工休息...")
    time.sleep(random.uniform(60, 180))  # 休息1-3分钟
```

---

### 策略2：频率限制（已实现）✅

当前系统已实现，但建议调整参数：

```yaml
# config.yaml
rate_limit:
  per_group_per_minute: 10    # 降低到10（原20）
  per_user_per_30s: 1         # 保持
  global_per_minute: 50       # 降低到50（原100）
  
  # 新增：每日总量限制
  per_group_per_day: 200      # 每群每天最多200条
  global_per_day: 1000        # 全局每天最多1000条
```

---

### 策略3：仅白名单群聊（已实现）✅

当前已实现，继续保持：

```yaml
wechat:
  whitelisted_groups:
    - 技术支持群    # 只在这些群响应
    - VIP客户群
```

**建议**：
- 初期只加1-2个测试群
- 观察1-2周无异常后再扩展
- 避免加入过多群聊

---

### 策略4：内容拟人化

#### 4.1 避免机器痕迹

```python
# ❌ 避免
response = "根据《产品手册v2.1》第3章第2节..."  # 太机械

# ✅ 推荐
response = "我看了下安装手册，有几个步骤：\n① ..."  # 更自然
```

#### 4.2 添加语气词

```python
# 在回复中随机添加语气词
greetings = ["嗯", "好的", "明白了", "收到"]
endings = ["～", "哦", "呢", ""]

response = f"{random.choice(greetings)}，{content}{random.choice(endings)}"
```

#### 4.3 变化回复模板

```python
# 不要总是一样的ACK
ack_templates = [
    "收到，正在查询...",
    "好的，让我看看",
    "稍等，查一下资料",
    "嗯，我帮你查查"
]

ack = random.choice(ack_templates)
```

---

### 策略5：错峰响应

```python
# 避免在深夜大量操作（异常）
import datetime

current_hour = datetime.now().hour

# 深夜减少活跃度
if 0 <= current_hour < 7:
    # 延长响应时间
    delay_multiplier = 2.0
    # 或直接静默
    if random.random() < 0.7:  # 70%概率不响应
        logger.info("深夜静默模式")
        return
```

---

### 策略6：IP和设备稳定

- ✅ 使用固定IP（不要频繁换IP）
- ✅ 使用固定设备（不要多设备登录）
- ✅ 保持微信在前台（不要后台运行）
- ✅ 定期人工登录（证明是真人使用）

---

## 🔄 替代方案

如果风险仍然较高，考虑以下替代方案：

### 方案B：企业微信（推荐）✨

**优势**：
- ✅ 官方支持自动化
- ✅ 提供API接口
- ✅ 不会封号
- ✅ 功能完整

**劣势**：
- ❌ 需要企业认证
- ❌ 只能在企业微信群使用
- ❌ 客户需要安装企业微信

**实施**：
```python
# 使用企业微信 Python SDK
from wechatpy.work import WeChatClient

client = WeChatClient(
    corp_id='your_corp_id',
    secret='your_secret'
)

# 发送消息（官方API，安全）
client.message.send_text(
    agent_id=1000001,
    user_id='user1',
    content='你好'
)
```

**成本**：免费（企业认证）

---

### 方案C：微信公众号 + 客服接口

**优势**：
- ✅ 官方API，完全合规
- ✅ 不会封号
- ✅ 功能稳定

**劣势**：
- ❌ 需要认证公众号
- ❌ 用户需要关注公众号
- ❌ 无法在群聊使用

---

### 方案D：webhook 机器人（有限）

飞书、钉钉、企业微信都支持群机器人：

**优势**：
- ✅ 官方支持
- ✅ 配置简单
- ✅ 不会封号

**劣势**：
- ❌ 只能在对应平台使用（不是微信）
- ❌ 功能受限

---

## 🎯 综合建议

### 短期方案（立即实施）

**使用 wxauto + 防封措施**：

1. **启用所有拟人化特性**：
   - 随机延迟
   - 变化模板
   - 添加语气词

2. **严格频率控制**：
   - 每群每分钟 ≤10条
   - 每天总量 ≤500条
   - 深夜静默

3. **保守运营**：
   - 只加3-5个群
   - 持续监控
   - 发现异常立即停止

4. **准备备用方案**：
   - 多准备几个微信号
   - 定期备份数据和联系人

### 中期方案（1-2个月）

**迁移到企业微信**：

1. 申请企业认证
2. 创建企业微信应用
3. 使用官方API
4. 逐步迁移客户

### 长期方案（稳定）

**多渠道客服**：

- 企业微信（主要）
- 个人微信（备用，限制使用）
- 飞书/钉钉（企业客户）
- 公众号（公开咨询）

---

## 💻 代码实现

我将为您实现完整的防封号机制！

---

**下一步**：
1. 创建拟人化行为模块
2. 实现企业级知识库服务
3. 提供企业微信适配器（备用方案）

准备好了，我开始实现！

