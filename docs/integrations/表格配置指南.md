# 飞书/钉钉多维表格配置指南

## 📋 概述

本系统支持与飞书多维表格和钉钉表格的自动同步，实现客户信息的统一管理。您只需在表格中维护客户信息，系统会自动同步到微信客服系统。

---

## 🎯 功能特点

- ✅ **自动双向同步**：表格 ↔ 微信系统
- ✅ **客户编号管理**：KXXXX 格式的唯一编号
- ✅ **优先级管理**：VIP客户优先响应
- ✅ **群聊分类**：不同群聊不同服务策略
- ✅ **统计追踪**：自动记录问题数、解决率等

---

## 📊 飞书多维表格配置

### 1. 创建多维表格

1. 在飞书中创建一个新的多维表格
2. 创建以下字段：

| 字段名称 | 字段类型 | 是否必填 | 说明 |
|---------|---------|---------|------|
| 客户编号 | 文本 | ✅ 是 | KXXXX格式，如K0001 |
| 姓名 | 文本 | ✅ 是 | 客户姓名 |
| 群聊名称 | 单选 | ✅ 是 | 所属群聊（技术支持群/VIP客户群等） |
| 微信备注 | 文本 | 否 | 微信中的备注名称 |
| 优先级 | 数字 | 否 | 1-5，默认3 |
| 电话 | 电话 | 否 | 联系电话 |
| 邮箱 | 邮箱 | 否 | 电子邮箱 |
| 备注 | 多行文本 | 否 | 其他备注信息 |
| 标签 | 多选 | 否 | 客户标签 |
| 总问题数 | 数字 | 否 | 自动同步 |
| 已解决 | 数字 | 否 | 自动同步 |
| 转人工次数 | 数字 | 否 | 自动同步 |
| 最后活跃 | 日期时间 | 否 | 自动同步 |
| 同步时间 | 日期时间 | 否 | 最后同步时间 |

### 2. 获取表格凭证

1. **获取 App ID 和 App Secret**
   - 访问 [飞书开放平台](https://open.feishu.cn/app)
   - 创建企业自建应用
   - 获取 `App ID` 和 `App Secret`

2. **获取表格 Token**
   - 打开您的多维表格
   - 在浏览器地址栏中找到表格URL
   - 格式：`https://xxx.feishu.cn/base/[这里是app_token]`
   - 复制 `app_token` 部分

3. **获取表格 ID**
   - 在多维表格中，右上角「...」→「复制链接」
   - 链接格式：`https://xxx.feishu.cn/base/xxx?table=[这里是table_id]`
   - 复制 `table_id` 部分

### 3. 配置权限

在飞书开放平台中，为应用添加以下权限：
- ✅ `bitable:app`（访问多维表格）
- ✅ `bitable:app:readonly`（只读访问）

### 4. 设置环境变量

在系统配置中设置：
```bash
FEISHU_APP_ID=cli_xxxxxxxxxxxx
FEISHU_APP_SECRET=xxxxxxxxxxxxxxxxxxxx
FEISHU_BITABLE_TOKEN=bascnxxxxxxxxxxxxxx
FEISHU_TABLE_ID=tblxxxxxxxxxxxxxx
```

---

## 📱 钉钉多维表格配置

### 1. 创建钉钉表格

1. 在钉钉中创建一个新的表格
2. 创建与飞书相同的字段结构（参考上表）

### 2. 获取表格凭证

1. **获取 App Key 和 App Secret**
   - 访问 [钉钉开发者后台](https://open-dev.dingtalk.com/)
   - 创建企业内部应用
   - 获取 `AppKey` 和 `AppSecret`

2. **获取 Base ID 和 Table ID**
   - 打开您的钉钉表格
   - 在浏览器地址栏查看URL
   - 提取 `base_id` 和 `table_id`

### 3. 配置权限

在钉钉开发者后台，为应用添加以下权限：
- ✅ 智能表格（读写权限）

### 4. 设置环境变量

在系统配置中设置：
```bash
DINGTALK_APP_KEY=dingtalkxxxxxxxxxxxx
DINGTALK_APP_SECRET=xxxxxxxxxxxxxxxxxxxx
DINGTALK_BASE_ID=xxxxxxxxxxxx
DINGTALK_TABLE_ID=xxxxxxxxxxxx
```

---

## 🔄 同步使用说明

### 手动同步

在 Web 管理界面的「客户管理」页面：

1. **从表格导入**
   - 点击「同步」→「从表格导入」
   - 系统会从飞书/钉钉表格读取客户信息
   - 新客户自动注册，现有客户更新信息

2. **导出到表格**
   - 点击「同步」→「导出到表格」
   - 将本地客户信息同步到飞书/钉钉表格
   - 自动更新统计数据（问题数、解决率等）

3. **双向同步**
   - 点击「同步」→「双向同步」
   - 同时执行导入和导出
   - 确保数据一致性

### 自动同步

系统支持定时自动同步（默认5分钟）：

```python
# 在 sync_manager.py 中配置
sync_manager = SyncManager(sync_interval=300)  # 300秒 = 5分钟
sync_manager.start_auto_sync()
```

---

## 📝 表格维护流程

### 日常维护

1. **添加新客户**
   - 在表格中新增一行
   - 填写客户编号（K0001、K0002...）
   - 填写姓名、群聊名称、微信备注
   - 等待系统自动同步（或手动触发同步）

2. **更新客户信息**
   - 直接在表格中修改客户信息
   - 修改优先级、备注、标签等
   - 系统会在下次同步时更新

3. **微信备注管理**
   - 在微信中将客户备注改为对应的客户编号
   - 例如：张三 → K0001 张三
   - 系统会自动识别客户编号

### 最佳实践

1. **统一编号规则**
   - 使用4位数字编号：K0001 - K9999
   - 为不同类型客户预留号段
   - VIP客户：K0001-K1000
   - 普通客户：K1001-K9000
   - 测试客户：K9001-K9999

2. **群聊分类管理**
   - 预先定义好群聊分类
   - 技术支持群：普通优先级
   - VIP客户群：高优先级
   - 测试群：低优先级

3. **定期检查同步**
   - 每天查看同步状态
   - 检查是否有同步失败的记录
   - 及时处理异常情况

---

## 🎯 实际应用场景

### 场景1：新客户加入

1. 客户被拉入"VIP客户群"
2. 管理员在飞书表格中添加客户信息
   - 客户编号：K0005
   - 姓名：李总
   - 群聊：VIP客户群
   - 优先级：5
3. 在微信中将客户备注改为："K0005 李总"
4. 系统自动同步后，客户咨询会被识别并优先处理

### 场景2：批量导入客户

1. 在Excel中整理客户信息
2. 批量导入到飞书/钉钉表格
3. 在Web界面点击「从表格导入」
4. 系统自动创建所有客户档案

### 场景3：数据统计分析

1. 系统自动更新客户统计信息到表格
2. 在飞书/钉钉中查看：
   - 每个客户的问题总数
   - 问题解决率
   - 转人工次数
   - 最后活跃时间
3. 生成报表和分析图表

---

## ⚠️ 注意事项

1. **数据安全**
   - 妥善保管 API 密钥
   - 不要将密钥提交到代码仓库
   - 定期更换密钥

2. **同步频率**
   - 避免过于频繁的同步（建议>5分钟）
   - 注意API调用次数限制
   - 大批量数据建议手动同步

3. **数据冲突**
   - 优先以表格数据为准（管理员维护）
   - 统计数据由系统自动更新
   - 避免同时在多处修改客户信息

4. **编号唯一性**
   - 确保客户编号全局唯一
   - 不要重复使用已删除客户的编号
   - 保留编号记录以供追溯

---

## 🔧 故障排查

### 同步失败

1. 检查网络连接
2. 验证 API 密钥是否正确
3. 确认表格权限配置
4. 查看系统日志获取详细错误信息

### 客户识别失败

1. 检查微信备注是否包含客户编号
2. 确认客户编号格式正确（KXXXX）
3. 验证表格中是否存在该客户
4. 手动触发同步更新客户信息

### 数据不一致

1. 执行「双向同步」强制同步所有数据
2. 检查是否有重复的客户编号
3. 查看同步日志确认同步时间
4. 必要时可以清空本地数据重新导入

---

## 📞 技术支持

如有问题，请联系：
- 📧 邮箱：support@example.com
- 💬 企业微信：技术支持群
- 📱 钉钉：技术支持部门

---

## 🎉 总结

通过飞书/钉钉表格集成，您可以：

✅ 在熟悉的表格界面管理客户  
✅ 无需登录多个系统  
✅ 数据实时同步，统一管理  
✅ 自动化运营，提升效率  
✅ 完整的数据追踪和分析  

立即开始使用，让客户管理更简单！🚀
