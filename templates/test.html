{% extends "base.html" %}
{% block title %}åŠŸèƒ½æµ‹è¯• - å¾®ä¿¡å®¢æœä¸­å°{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-bug"></i> åŠŸèƒ½æµ‹è¯•</h1>
        <hr>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-chat"></i> å‘é€æµ‹è¯•æ¶ˆæ¯</h5>
            </div>
            <div class="card-body">
                <form id="test-message-form">
                    <div class="mb-3">
                        <label class="form-label">ç¾¤èŠåç§°</label>
                        <input type="text" class="form-control" id="test-group" value="æŠ€æœ¯æ”¯æŒç¾¤" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">å‘é€è€…</label>
                        <input type="text" class="form-control" id="test-sender" value="æµ‹è¯•ç”¨æˆ·" required>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">æ¶ˆæ¯å†…å®¹</label>
                        <textarea class="form-control" id="test-content" rows="3" required>@å°åŠ©æ‰‹ è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼Œè¯·å›å¤æˆ‘ã€‚</textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-send"></i> å‘é€æµ‹è¯•æ¶ˆæ¯
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-list-check"></i> æµ‹è¯•ç»“æœ</h5>
            </div>
            <div class="card-body">
                <div id="test-results">
                    <p class="text-muted">æš‚æ— æµ‹è¯•ç»“æœ</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-gear"></i> å¿«é€Ÿæµ‹è¯•</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="quickTest('æ™®é€šé—®é¢˜')">
                        <i class="bi bi-question-circle"></i> æ™®é€šé—®é¢˜æµ‹è¯•
                    </button>
                    <button class="btn btn-outline-warning" onclick="quickTest('ç¦ç­”åŸŸé—®é¢˜')">
                        <i class="bi bi-exclamation-triangle"></i> ç¦ç­”åŸŸæµ‹è¯•
                    </button>
                    <button class="btn btn-outline-info" onclick="quickTest('ç®¡ç†æŒ‡ä»¤')">
                        <i class="bi bi-tools"></i> ç®¡ç†æŒ‡ä»¤æµ‹è¯•
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-activity"></i> å®æ—¶æ—¥å¿—</h5>
            </div>
            <div class="card-body">
                <div id="test-logs" style="height: 200px; overflow-y: auto; background: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <p class="text-muted">ç­‰å¾…æµ‹è¯•æ¶ˆæ¯...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    
    // è¿æ¥æˆåŠŸ
    socket.on('connect', function() {
        addLog('âœ… WebSocket è¿æ¥æˆåŠŸ', 'success');
    });
    
    // æ¥æ”¶æµ‹è¯•æ¶ˆæ¯å‘é€äº‹ä»¶
    socket.on('test_message_sent', function(data) {
        addLog(`ğŸ“¤ æµ‹è¯•æ¶ˆæ¯å·²å‘é€: ${data.sender} -> ${data.content}`, 'info');
    });
    
    // æäº¤æµ‹è¯•æ¶ˆæ¯è¡¨å•
    document.getElementById('test-message-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const testData = {
            group: document.getElementById('test-group').value,
            sender: document.getElementById('test-sender').value,
            content: document.getElementById('test-content').value
        };
        
        sendTestMessage(testData);
    });
    
    // å‘é€æµ‹è¯•æ¶ˆæ¯
    function sendTestMessage(data) {
        addLog(`ğŸ”„ å‘é€æµ‹è¯•æ¶ˆæ¯: ${data.sender} -> ${data.group}`, 'info');
        
        fetch('/api/test/message', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                addLog(`âœ… ${result.message}`, 'success');
                addTestResult('success', `æ¶ˆæ¯å‘é€æˆåŠŸ: ${data.content}`);
            } else {
                addLog(`âŒ ${result.message}`, 'danger');
                addTestResult('error', `æ¶ˆæ¯å‘é€å¤±è´¥: ${result.message}`);
            }
        })
        .catch(error => {
            addLog(`âŒ å‘é€å¤±è´¥: ${error.message}`, 'danger');
            addTestResult('error', `å‘é€å¤±è´¥: ${error.message}`);
        });
    }
    
    // å¿«é€Ÿæµ‹è¯•
    function quickTest(type) {
        const tests = {
            'æ™®é€šé—®é¢˜': {
                group: 'æŠ€æœ¯æ”¯æŒç¾¤',
                sender: 'æµ‹è¯•ç”¨æˆ·',
                content: '@å°åŠ©æ‰‹ å¦‚ä½•å®‰è£…è®¾å¤‡ï¼Ÿ'
            },
            'ç¦ç­”åŸŸé—®é¢˜': {
                group: 'æŠ€æœ¯æ”¯æŒç¾¤',
                sender: 'æµ‹è¯•ç”¨æˆ·',
                content: '@å°åŠ©æ‰‹ ä½ ä»¬çš„ä»·æ ¼æ˜¯å¤šå°‘ï¼Ÿ'
            },
            'ç®¡ç†æŒ‡ä»¤': {
                group: 'æŠ€æœ¯æ”¯æŒç¾¤',
                sender: 'ç®¡ç†å‘˜',
                content: '@å°åŠ©æ‰‹ #status'
            }
        };
        
        const testData = tests[type];
        if (testData) {
            // æ›´æ–°è¡¨å•
            document.getElementById('test-group').value = testData.group;
            document.getElementById('test-sender').value = testData.sender;
            document.getElementById('test-content').value = testData.content;
            
            // å‘é€æµ‹è¯•
            sendTestMessage(testData);
        }
    }
    
    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
        const logsDiv = document.getElementById('test-logs');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `mb-1 text-${type}`;
        logEntry.innerHTML = `<small>[${timestamp}]</small> ${message}`;
        
        logsDiv.appendChild(logEntry);
        logsDiv.scrollTop = logsDiv.scrollHeight;
        
        // é™åˆ¶æ—¥å¿—æ¡æ•°
        while (logsDiv.children.length > 50) {
            logsDiv.removeChild(logsDiv.firstChild);
        }
    }
    
    // æ·»åŠ æµ‹è¯•ç»“æœ
    function addTestResult(type, message) {
        const resultsDiv = document.getElementById('test-results');
        const resultEntry = document.createElement('div');
        resultEntry.className = `alert alert-${type} alert-sm mb-2`;
        resultEntry.innerHTML = `
            <small><strong>[${new Date().toLocaleTimeString()}]</strong></small><br>
            ${message}
        `;
        
        resultsDiv.appendChild(resultEntry);
        
        // é™åˆ¶ç»“æœæ¡æ•°
        while (resultsDiv.children.length > 10) {
            resultsDiv.removeChild(resultsDiv.firstChild);
        }
    }
</script>
{% endblock %}