<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ·ä¸­å° - Customer Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header p {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            gap: 20px;
            height: calc(100vh - 140px);
        }
        
        /* å·¦ä¾§ï¼šæœªçŸ¥æ±  */
        .unknown-pool {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .pool-header {
            padding: 20px;
            border-bottom: 1px solid #e4e7ed;
            background: #fef5e7;
        }
        
        .pool-header h2 {
            font-size: 18px;
            color: #f39c12;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: #f39c12;
            color: white;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .pool-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .pool-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #f39c12;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pool-item:hover {
            background: #fff7e6;
            transform: translateX(2px);
        }
        
        .pool-item.active {
            background: #fff7e6;
            border-left-color: #e67e22;
        }
        
        .pool-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .pool-item-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .score {
            font-size: 12px;
            color: #f39c12;
            font-weight: 600;
        }
        
        .pool-item-preview {
            font-size: 12px;
            color: #7f8c8d;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .pool-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-promote {
            background: #27ae60;
            color: white;
        }
        
        .btn-ignore {
            background: #95a5a6;
            color: white;
        }
        
        .btn-blacklist {
            background: #e74c3c;
            color: white;
        }
        
        .btn-sm:hover {
            opacity: 0.8;
        }
        
        /* ä¸­é—´ï¼šçœ‹æ¿ */
        .dashboard {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .counters-bar {
            padding: 20px;
            border-bottom: 1px solid #e4e7ed;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }
        
        .counter {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .counter-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .counter-value {
            font-size: 28px;
            font-weight: 600;
        }
        
        .counter.unseen { border-left: 3px solid #3498db; }
        .counter.unseen .counter-value { color: #3498db; }
        
        .counter.need-reply { border-left: 3px solid #e67e22; }
        .counter.need-reply .counter-value { color: #e67e22; }
        
        .counter.waiting { border-left: 3px solid #95a5a6; }
        .counter.waiting .counter-value { color: #95a5a6; }
        
        .counter.overdue { border-left: 3px solid #e74c3c; }
        .counter.overdue .counter-value { color: #e74c3c; }
        
        .counter.resolved { border-left: 3px solid #27ae60; }
        .counter.resolved .counter-value { color: #27ae60; }
        
        .thread-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .thread-card {
            padding: 15px;
            margin-bottom: 12px;
            background: white;
            border: 1px solid #e4e7ed;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .thread-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .thread-card.overdue { border-left-color: #e74c3c; }
        .thread-card.need-reply { border-left-color: #e67e22; }
        .thread-card.waiting { border-left-color: #95a5a6; }
        
        .thread-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .thread-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .thread-status {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-overdue {
            background: #fee;
            color: #e74c3c;
        }
        
        .status-need-reply {
            background: #fff4e6;
            color: #e67e22;
        }
        
        .status-waiting {
            background: #f0f0f0;
            color: #7f8c8d;
        }
        
        .thread-preview {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .thread-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #95a5a6;
        }
        
        .thread-labels {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        
        .label {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .label-pre { background: #e3f2fd; color: #1976d2; }
        .label-post { background: #fce4ec; color: #c2185b; }
        .label-biz { background: #f3e5f5; color: #7b1fa2; }
        
        /* å³ä¾§ï¼šå·¥ä½œå° */
        .workspace {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .workspace-header {
            padding: 20px;
            border-bottom: 1px solid #e4e7ed;
            background: #f8f9fa;
        }
        
        .workspace-header h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .workspace-header p {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .workspace-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
            display: block;
        }
        
        .form-value {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .draft-box {
            padding: 15px;
            background: #f0f7ff;
            border-radius: 6px;
            border: 1px solid #d0e8ff;
            margin-bottom: 15px;
        }
        
        .draft-text {
            font-size: 13px;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 12px;
        }
        
        .btn-copy {
            width: 100%;
            padding: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-copy:hover {
            background: #2980b9;
        }
        
        .sla-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .btn-action {
            padding: 10px;
            border: 1px solid #e4e7ed;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-action:hover {
            background: #f8f9fa;
        }
        
        .btn-resolve {
            grid-column: span 2;
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }
        
        .btn-resolve:hover {
            background: #229954;
        }
        
        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* æ»šåŠ¨æ¡ç¾åŒ– */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ å®¢æˆ·ä¸­å° Customer Hub</h1>
        <p>åŸºäº"æœ€åè¯´è¯æ–¹ + SLA"çš„æ™ºèƒ½å®¢æˆ·åˆ†çº§ç³»ç»Ÿ | æœªçŸ¥æ± æ—¥æ¸… Â· ç™½/ç°/é»‘åå• Â· ä¸‰å¤§è§¦å‘</p>
    </div>
    
    <div class="container">
        <!-- å·¦ä¾§ï¼šæœªçŸ¥æ±  -->
        <div class="unknown-pool">
            <div class="pool-header">
                <h2>
                    ğŸ“¥ æœªçŸ¥æ±  (ç°åå•)
                    <span class="badge" id="pool-count">0</span>
                </h2>
                <p style="margin-top: 5px; font-size: 12px; color: #7f8c8d;">ä»Šæ—¥å¾…å»ºæ¡£ Â· æ”¯æŒä¸æ—¢è¯»é¢„è§ˆ</p>
            </div>
            <div class="pool-list" id="pool-list">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>æœªçŸ¥æ± å·²æ¸…ç©º âœ¨</p>
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šçœ‹æ¿ -->
        <div class="dashboard">
            <div class="counters-bar">
                <div class="counter unseen">
                    <div class="counter-label">æœªå¤„ç†</div>
                    <div class="counter-value" id="count-unseen">0</div>
                </div>
                <div class="counter need-reply">
                    <div class="counter-label">éœ€å›å¤</div>
                    <div class="counter-value" id="count-need-reply">0</div>
                </div>
                <div class="counter waiting">
                    <div class="counter-label">ç­‰å¾…å¯¹æ–¹</div>
                    <div class="counter-value" id="count-waiting">0</div>
                </div>
                <div class="counter overdue">
                    <div class="counter-label">é€¾æœŸ</div>
                    <div class="counter-value" id="count-overdue">0</div>
                </div>
                <div class="counter resolved">
                    <div class="counter-label">å·²è§£å†³</div>
                    <div class="counter-value" id="count-resolved">0</div>
                </div>
            </div>
            
            <div class="thread-list" id="thread-list">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                    <p>æš‚æ— å¾…åŠä¼šè¯</p>
                </div>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šå·¥ä½œå° -->
        <div class="workspace">
            <div class="workspace-header">
                <h3>âš¡ å·¥ä½œå°</h3>
                <p id="workspace-subtitle">é€‰æ‹©ä¸€ä¸ªä¼šè¯æŸ¥çœ‹è¯¦æƒ…</p>
            </div>
            <div class="workspace-content" id="workspace-content">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¼šè¯</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // çŠ¶æ€ç®¡ç†
        let state = {
            unknownPool: [],
            todayTodo: [],
            statistics: {},
            selectedThread: null
        };
        
        // åˆå§‹åŒ–
        async function init() {
            await loadStatistics();
            await loadUnknownPool();
            await loadTodayTodo();
            
            // å®šæ—¶åˆ·æ–°(æ¯30ç§’)
            setInterval(async () => {
                await loadStatistics();
                await loadUnknownPool();
                await loadTodayTodo();
            }, 30000);
        }
        
        // åŠ è½½ç»Ÿè®¡
        async function loadStatistics() {
            try {
                const res = await fetch('/api/hub/statistics');
                const data = await res.json();
                
                if (data.success) {
                    state.statistics = data.data.threads;
                    updateCounters();
                }
            } catch (err) {
                console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', err);
            }
        }
        
        // æ›´æ–°è®¡æ•°å™¨
        function updateCounters() {
            const stats = state.statistics;
            document.getElementById('count-unseen').textContent = stats.unseen || 0;
            document.getElementById('count-need-reply').textContent = stats.need_reply || 0;
            document.getElementById('count-waiting').textContent = stats.waiting_them || 0;
            document.getElementById('count-overdue').textContent = stats.overdue || 0;
            document.getElementById('count-resolved').textContent = stats.resolved || 0;
        }
        
        // åŠ è½½æœªçŸ¥æ± 
        async function loadUnknownPool() {
            try {
                const res = await fetch('/api/hub/unknown-pool?limit=50');
                const data = await res.json();
                
                if (data.success) {
                    state.unknownPool = data.data;
                    renderUnknownPool();
                }
            } catch (err) {
                console.error('åŠ è½½æœªçŸ¥æ± å¤±è´¥:', err);
            }
        }
        
        // æ¸²æŸ“æœªçŸ¥æ± 
        function renderUnknownPool() {
            const list = document.getElementById('pool-list');
            const count = document.getElementById('pool-count');
            
            count.textContent = state.unknownPool.length;
            
            if (state.unknownPool.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p>æœªçŸ¥æ± å·²æ¸…ç©º âœ¨</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = state.unknownPool.map(item => `
                <div class="pool-item" onclick="selectUnknownPoolItem('${item.thread_id}')">
                    <div class="pool-item-header">
                        <span class="pool-item-title">${item.remark || item.wx_id}</span>
                        <span class="score">${item.total_score}åˆ†</span>
                    </div>
                    <div class="pool-item-preview">${item.topic || 'æš‚æ— æ‘˜è¦'}</div>
                    <div class="pool-actions" onclick="event.stopPropagation()">
                        <button class="btn-sm btn-promote" onclick="promoteContact('${item.contact_id}', '${item.remark || 'å®¢æˆ·'}')">å»ºæ¡£</button>
                        <button class="btn-sm btn-ignore" onclick="ignoreItem('${item.thread_id}')">å¿½ç•¥</button>
                        <button class="btn-sm btn-blacklist" onclick="blacklistItem('${item.contact_id}')">æ‹‰é»‘</button>
                    </div>
                </div>
            `).join('');
        }
        
        // åŠ è½½ä»Šæ—¥å¾…åŠ
        async function loadTodayTodo() {
            try {
                const res = await fetch('/api/hub/today-todo?limit=100');
                const data = await res.json();
                
                if (data.success) {
                    state.todayTodo = data.data;
                    renderTodayTodo();
                }
            } catch (err) {
                console.error('åŠ è½½ä»Šæ—¥å¾…åŠå¤±è´¥:', err);
            }
        }
        
        // æ¸²æŸ“ä»Šæ—¥å¾…åŠ
        function renderTodayTodo() {
            const list = document.getElementById('thread-list');
            
            if (state.todayTodo.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                        </svg>
                        <p>æš‚æ— å¾…åŠä¼šè¯</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = state.todayTodo.map(item => {
                const statusClass = item.status.toLowerCase().replace('_', '-');
                const statusText = {
                    'OVERDUE': 'é€¾æœŸ',
                    'NEED_REPLY': 'éœ€å›å¤',
                    'UNSEEN': 'æœªå¤„ç†',
                    'WAITING_THEM': 'ç­‰å¾…å¯¹æ–¹',
                    'SNOOZED': 'å·²æ¨è¿Ÿ'
                }[item.status] || item.status;
                
                return `
                    <div class="thread-card ${statusClass}" onclick="selectThread('${item.thread_id}')">
                        <div class="thread-header">
                            <span class="thread-title">${item.k_code || item.remark || item.wx_id}</span>
                            <span class="thread-status status-${statusClass}">${statusText}</span>
                        </div>
                        <div class="thread-preview">${item.topic || 'æš‚æ— æ‘˜è¦'}</div>
                        <div class="thread-meta">
                            <span>ğŸ• ${formatTime(item.last_msg_at)}</span>
                            <span>ğŸ“‚ ${item.bucket}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // é€‰æ‹©æœªçŸ¥æ± é¡¹ç›®
        function selectUnknownPoolItem(threadId) {
            state.selectedThread = threadId;
            renderWorkspace();
        }
        
        // é€‰æ‹©çº¿ç¨‹
        function selectThread(threadId) {
            state.selectedThread = threadId;
            renderWorkspace();
        }
        
        // æ¸²æŸ“å·¥ä½œå°
        function renderWorkspace() {
            const content = document.getElementById('workspace-content');
            const subtitle = document.getElementById('workspace-subtitle');
            
            if (!state.selectedThread) {
                content.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>è¯·ä»å·¦ä¾§é€‰æ‹©ä¼šè¯</p>
                    </div>
                `;
                return;
            }
            
            subtitle.textContent = 'ä¼šè¯è¯¦æƒ… Â· ID: ' + state.selectedThread.substring(0, 8) + '...';
            
            // ç®€åŒ–ç‰ˆå·¥ä½œå°(å®é™…åº”è¯¥åŠ è½½trigger_outputç­‰)
            content.innerHTML = `
                <div class="section">
                    <div class="section-title">ğŸ“ LLM æ‘˜è¦</div>
                    <div class="draft-box">
                        <div class="draft-text">
                            æš‚æ— AIç”Ÿæˆçš„å›å¤è‰ç¨¿ã€‚<br>
                            ç‚¹å‡»"è§¦å‘åœºæ™¯"æŒ‰é’®ç”Ÿæˆæ™ºèƒ½å›å¤ã€‚
                        </div>
                        <button class="btn-copy" onclick="copyDraft()">ğŸ“‹ ä¸€é”®å¤åˆ¶è¯æœ¯</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">ğŸ“‹ è¡¨å•ä¿¡æ¯</div>
                    <p style="font-size: 12px; color: #95a5a6;">ç­‰å¾…è§¦å‘å™¨ç”Ÿæˆ...</p>
                </div>
                
                <div class="section">
                    <div class="section-title">â° SLA æ“ä½œ</div>
                    <div class="sla-actions">
                        <button class="btn-action" onclick="snoozeThread('${state.selectedThread}')">â±ï¸ æ¨è¿Ÿ1å°æ—¶</button>
                        <button class="btn-action" onclick="markWaiting('${state.selectedThread}')">âŒ› ç­‰å¾…å¯¹æ–¹</button>
                        <button class="btn-action btn-resolve" onclick="resolveThread('${state.selectedThread}')">âœ… æ ‡è®°å·²è§£å†³</button>
                    </div>
                </div>
            `;
        }
        
        // å»ºæ¡£
        async function promoteContact(contactId, name) {
            const customerName = prompt('è¯·è¾“å…¥å®¢æˆ·åç§°:', name);
            if (!customerName) return;
            
            const region = prompt('è¯·è¾“å…¥åœ°åŒºä»£ç (å¯é€‰,å¦‚"æ¸A"):', '');
            const level = prompt('è¯·è¾“å…¥å®¢æˆ·çº§åˆ«(å¯é€‰,å¦‚"VIP"):', '');
            
            try {
                const res = await fetch('/api/hub/contacts/promote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contact_id: contactId,
                        customer_name: customerName,
                        region: region || null,
                        level: level || null
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(`å»ºæ¡£æˆåŠŸï¼Kç¼–ç : ${data.data.k_code}`);
                    await loadUnknownPool();
                    await loadTodayTodo();
                } else {
                    alert('å»ºæ¡£å¤±è´¥: ' + data.message);
                }
            } catch (err) {
                alert('å»ºæ¡£å¤±è´¥: ' + err.message);
            }
        }
        
        // å¿½ç•¥
        async function ignoreItem(threadId) {
            await snoozeThread(threadId, 1440); // æ¨è¿Ÿ24å°æ—¶
        }
        
        // æ‹‰é»‘
        async function blacklistItem(contactId) {
            if (!confirm('ç¡®å®šè¦å°†æ­¤è”ç³»äººæ‹‰é»‘å—ï¼Ÿ')) return;
            alert('æ‹‰é»‘åŠŸèƒ½å¾…å®ç°');
        }
        
        // æ¨è¿Ÿ
        async function snoozeThread(threadId, minutes = 60) {
            try {
                const res = await fetch(`/api/hub/threads/${threadId}/snooze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snooze_minutes: minutes })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('å·²æ¨è¿Ÿå¤„ç†');
                    await loadUnknownPool();
                    await loadTodayTodo();
                }
            } catch (err) {
                alert('æ“ä½œå¤±è´¥: ' + err.message);
            }
        }
        
        // æ ‡è®°ç­‰å¾…å¯¹æ–¹
        async function markWaiting(threadId) {
            try {
                const res = await fetch(`/api/hub/threads/${threadId}/waiting`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('å·²æ ‡è®°ä¸ºç­‰å¾…å¯¹æ–¹');
                    await loadTodayTodo();
                }
            } catch (err) {
                alert('æ“ä½œå¤±è´¥: ' + err.message);
            }
        }
        
        // æ ‡è®°å·²è§£å†³
        async function resolveThread(threadId) {
            if (!confirm('ç¡®å®šè¦æ ‡è®°ä¸ºå·²è§£å†³å—ï¼Ÿ')) return;
            
            try {
                const res = await fetch(`/api/hub/threads/${threadId}/resolve`, {
                    method: 'POST'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('å·²æ ‡è®°ä¸ºå·²è§£å†³');
                    state.selectedThread = null;
                    await loadTodayTodo();
                    renderWorkspace();
                }
            } catch (err) {
                alert('æ“ä½œå¤±è´¥: ' + err.message);
            }
        }
        
        // å¤åˆ¶è‰ç¨¿
        function copyDraft() {
            alert('å¤åˆ¶åŠŸèƒ½å¾…å®ç°');
        }
        
        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            const now = new Date();
            const diff = (now - date) / 1000 / 60; // åˆ†é’Ÿ
            
            if (diff < 1) return 'åˆšåˆš';
            if (diff < 60) return Math.floor(diff) + 'åˆ†é’Ÿå‰';
            if (diff < 1440) return Math.floor(diff / 60) + 'å°æ—¶å‰';
            return Math.floor(diff / 1440) + 'å¤©å‰';
        }
        
        // å¯åŠ¨
        init();
    </script>
</body>
</html>

