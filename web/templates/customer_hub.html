<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客户中台 - Customer Hub</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        .header p {
            margin-top: 5px;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 350px 1fr 400px;
            gap: 20px;
            height: calc(100vh - 140px);
        }
        
        /* 左侧：未知池 */
        .unknown-pool {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .pool-header {
            padding: 20px;
            border-bottom: 1px solid #e4e7ed;
            background: #fef5e7;
        }
        
        .pool-header h2 {
            font-size: 18px;
            color: #f39c12;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .badge {
            display: inline-block;
            padding: 2px 8px;
            background: #f39c12;
            color: white;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .pool-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .pool-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f9f9f9;
            border-radius: 6px;
            border-left: 3px solid #f39c12;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pool-item:hover {
            background: #fff7e6;
            transform: translateX(2px);
        }
        
        .pool-item.active {
            background: #fff7e6;
            border-left-color: #e67e22;
        }
        
        .pool-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .pool-item-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .score {
            font-size: 12px;
            color: #f39c12;
            font-weight: 600;
        }
        
        .pool-item-preview {
            font-size: 12px;
            color: #7f8c8d;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .pool-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }
        
        .btn-sm {
            padding: 4px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-promote {
            background: #27ae60;
            color: white;
        }
        
        .btn-ignore {
            background: #95a5a6;
            color: white;
        }
        
        .btn-blacklist {
            background: #e74c3c;
            color: white;
        }
        
        .btn-sm:hover {
            opacity: 0.8;
        }
        
        /* 中间：看板 */
        .dashboard {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .counters-bar {
            padding: 20px;
            border-bottom: 1px solid #e4e7ed;
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
        }
        
        .counter {
            text-align: center;
            padding: 15px;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .counter-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .counter-value {
            font-size: 28px;
            font-weight: 600;
        }
        
        .counter.unseen { border-left: 3px solid #3498db; }
        .counter.unseen .counter-value { color: #3498db; }
        
        .counter.need-reply { border-left: 3px solid #e67e22; }
        .counter.need-reply .counter-value { color: #e67e22; }
        
        .counter.waiting { border-left: 3px solid #95a5a6; }
        .counter.waiting .counter-value { color: #95a5a6; }
        
        .counter.overdue { border-left: 3px solid #e74c3c; }
        .counter.overdue .counter-value { color: #e74c3c; }
        
        .counter.resolved { border-left: 3px solid #27ae60; }
        .counter.resolved .counter-value { color: #27ae60; }
        
        .thread-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .thread-card {
            padding: 15px;
            margin-bottom: 12px;
            background: white;
            border: 1px solid #e4e7ed;
            border-radius: 6px;
            border-left: 4px solid #3498db;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .thread-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .thread-card.overdue { border-left-color: #e74c3c; }
        .thread-card.need-reply { border-left-color: #e67e22; }
        .thread-card.waiting { border-left-color: #95a5a6; }
        
        .thread-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .thread-title {
            font-weight: 600;
            font-size: 14px;
        }
        
        .thread-status {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .status-overdue {
            background: #fee;
            color: #e74c3c;
        }
        
        .status-need-reply {
            background: #fff4e6;
            color: #e67e22;
        }
        
        .status-waiting {
            background: #f0f0f0;
            color: #7f8c8d;
        }
        
        .thread-preview {
            font-size: 13px;
            color: #7f8c8d;
            margin-bottom: 8px;
        }
        
        .thread-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #95a5a6;
        }
        
        .thread-labels {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }
        
        .label {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: 600;
        }
        
        .label-pre { background: #e3f2fd; color: #1976d2; }
        .label-post { background: #fce4ec; color: #c2185b; }
        .label-biz { background: #f3e5f5; color: #7b1fa2; }
        
        /* 右侧：工作台 */
        .workspace {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .workspace-header {
            padding: 20px;
            border-bottom: 1px solid #e4e7ed;
            background: #f8f9fa;
        }
        
        .workspace-header h3 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .workspace-header p {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .workspace-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            color: #2c3e50;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        .form-label {
            font-size: 12px;
            color: #7f8c8d;
            margin-bottom: 5px;
            display: block;
        }
        
        .form-value {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .draft-box {
            padding: 15px;
            background: #f0f7ff;
            border-radius: 6px;
            border: 1px solid #d0e8ff;
            margin-bottom: 15px;
        }
        
        .draft-text {
            font-size: 13px;
            line-height: 1.6;
            color: #2c3e50;
            margin-bottom: 12px;
        }
        
        .btn-copy {
            width: 100%;
            padding: 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-copy:hover {
            background: #2980b9;
        }
        
        .sla-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .btn-action {
            padding: 10px;
            border: 1px solid #e4e7ed;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .btn-action:hover {
            background: #f8f9fa;
        }
        
        .btn-resolve {
            grid-column: span 2;
            background: #27ae60;
            color: white;
            border-color: #27ae60;
        }
        
        .btn-resolve:hover {
            background: #229954;
        }
        
        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #95a5a6;
        }
        
        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* 滚动条美化 */
        ::-webkit-scrollbar {
            width: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎯 客户中台 Customer Hub</h1>
        <p>基于"最后说话方 + SLA"的智能客户分级系统 | 未知池日清 · 白/灰/黑名单 · 三大触发</p>
    </div>
    
    <div class="container">
        <!-- 左侧：未知池 -->
        <div class="unknown-pool">
            <div class="pool-header">
                <h2>
                    📥 未知池 (灰名单)
                    <span class="badge" id="pool-count">0</span>
                </h2>
                <p style="margin-top: 5px; font-size: 12px; color: #7f8c8d;">今日待建档 · 支持不既读预览</p>
            </div>
            <div class="pool-list" id="pool-list">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p>未知池已清空 ✨</p>
                </div>
            </div>
        </div>
        
        <!-- 中间：看板 -->
        <div class="dashboard">
            <div class="counters-bar">
                <div class="counter unseen">
                    <div class="counter-label">未处理</div>
                    <div class="counter-value" id="count-unseen">0</div>
                </div>
                <div class="counter need-reply">
                    <div class="counter-label">需回复</div>
                    <div class="counter-value" id="count-need-reply">0</div>
                </div>
                <div class="counter waiting">
                    <div class="counter-label">等待对方</div>
                    <div class="counter-value" id="count-waiting">0</div>
                </div>
                <div class="counter overdue">
                    <div class="counter-label">逾期</div>
                    <div class="counter-value" id="count-overdue">0</div>
                </div>
                <div class="counter resolved">
                    <div class="counter-label">已解决</div>
                    <div class="counter-value" id="count-resolved">0</div>
                </div>
            </div>
            
            <div class="thread-list" id="thread-list">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>
                    <p>暂无待办会话</p>
                </div>
            </div>
        </div>
        
        <!-- 右侧：工作台 -->
        <div class="workspace">
            <div class="workspace-header">
                <h3>⚡ 工作台</h3>
                <p id="workspace-subtitle">选择一个会话查看详情</p>
            </div>
            <div class="workspace-content" id="workspace-content">
                <div class="empty-state">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <p>请从左侧选择会话</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 状态管理
        let state = {
            unknownPool: [],
            todayTodo: [],
            statistics: {},
            selectedThread: null
        };
        
        // 初始化
        async function init() {
            await loadStatistics();
            await loadUnknownPool();
            await loadTodayTodo();
            
            // 定时刷新(每30秒)
            setInterval(async () => {
                await loadStatistics();
                await loadUnknownPool();
                await loadTodayTodo();
            }, 30000);
        }
        
        // 加载统计
        async function loadStatistics() {
            try {
                const res = await fetch('/api/hub/statistics');
                const data = await res.json();
                
                if (data.success) {
                    state.statistics = data.data.threads;
                    updateCounters();
                }
            } catch (err) {
                console.error('加载统计失败:', err);
            }
        }
        
        // 更新计数器
        function updateCounters() {
            const stats = state.statistics;
            document.getElementById('count-unseen').textContent = stats.unseen || 0;
            document.getElementById('count-need-reply').textContent = stats.need_reply || 0;
            document.getElementById('count-waiting').textContent = stats.waiting_them || 0;
            document.getElementById('count-overdue').textContent = stats.overdue || 0;
            document.getElementById('count-resolved').textContent = stats.resolved || 0;
        }
        
        // 加载未知池
        async function loadUnknownPool() {
            try {
                const res = await fetch('/api/hub/unknown-pool?limit=50');
                const data = await res.json();
                
                if (data.success) {
                    state.unknownPool = data.data;
                    renderUnknownPool();
                }
            } catch (err) {
                console.error('加载未知池失败:', err);
            }
        }
        
        // 渲染未知池
        function renderUnknownPool() {
            const list = document.getElementById('pool-list');
            const count = document.getElementById('pool-count');
            
            count.textContent = state.unknownPool.length;
            
            if (state.unknownPool.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p>未知池已清空 ✨</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = state.unknownPool.map(item => `
                <div class="pool-item" onclick="selectUnknownPoolItem('${item.thread_id}')">
                    <div class="pool-item-header">
                        <span class="pool-item-title">${item.remark || item.wx_id}</span>
                        <span class="score">${item.total_score}分</span>
                    </div>
                    <div class="pool-item-preview">${item.topic || '暂无摘要'}</div>
                    <div class="pool-actions" onclick="event.stopPropagation()">
                        <button class="btn-sm btn-promote" onclick="promoteContact('${item.contact_id}', '${item.remark || '客户'}')">建档</button>
                        <button class="btn-sm btn-ignore" onclick="ignoreItem('${item.thread_id}')">忽略</button>
                        <button class="btn-sm btn-blacklist" onclick="blacklistItem('${item.contact_id}')">拉黑</button>
                    </div>
                </div>
            `).join('');
        }
        
        // 加载今日待办
        async function loadTodayTodo() {
            try {
                const res = await fetch('/api/hub/today-todo?limit=100');
                const data = await res.json();
                
                if (data.success) {
                    state.todayTodo = data.data;
                    renderTodayTodo();
                }
            } catch (err) {
                console.error('加载今日待办失败:', err);
            }
        }
        
        // 渲染今日待办
        function renderTodayTodo() {
            const list = document.getElementById('thread-list');
            
            if (state.todayTodo.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                        </svg>
                        <p>暂无待办会话</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = state.todayTodo.map(item => {
                const statusClass = item.status.toLowerCase().replace('_', '-');
                const statusText = {
                    'OVERDUE': '逾期',
                    'NEED_REPLY': '需回复',
                    'UNSEEN': '未处理',
                    'WAITING_THEM': '等待对方',
                    'SNOOZED': '已推迟'
                }[item.status] || item.status;
                
                return `
                    <div class="thread-card ${statusClass}" onclick="selectThread('${item.thread_id}')">
                        <div class="thread-header">
                            <span class="thread-title">${item.k_code || item.remark || item.wx_id}</span>
                            <span class="thread-status status-${statusClass}">${statusText}</span>
                        </div>
                        <div class="thread-preview">${item.topic || '暂无摘要'}</div>
                        <div class="thread-meta">
                            <span>🕐 ${formatTime(item.last_msg_at)}</span>
                            <span>📂 ${item.bucket}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 选择未知池项目
        function selectUnknownPoolItem(threadId) {
            state.selectedThread = threadId;
            renderWorkspace();
        }
        
        // 选择线程
        function selectThread(threadId) {
            state.selectedThread = threadId;
            renderWorkspace();
        }
        
        // 渲染工作台
        function renderWorkspace() {
            const content = document.getElementById('workspace-content');
            const subtitle = document.getElementById('workspace-subtitle');
            
            if (!state.selectedThread) {
                content.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>请从左侧选择会话</p>
                    </div>
                `;
                return;
            }
            
            subtitle.textContent = '会话详情 · ID: ' + state.selectedThread.substring(0, 8) + '...';
            
            // 简化版工作台(实际应该加载trigger_output等)
            content.innerHTML = `
                <div class="section">
                    <div class="section-title">📝 LLM 摘要</div>
                    <div class="draft-box">
                        <div class="draft-text">
                            暂无AI生成的回复草稿。<br>
                            点击"触发场景"按钮生成智能回复。
                        </div>
                        <button class="btn-copy" onclick="copyDraft()">📋 一键复制话术</button>
                    </div>
                </div>
                
                <div class="section">
                    <div class="section-title">📋 表单信息</div>
                    <p style="font-size: 12px; color: #95a5a6;">等待触发器生成...</p>
                </div>
                
                <div class="section">
                    <div class="section-title">⏰ SLA 操作</div>
                    <div class="sla-actions">
                        <button class="btn-action" onclick="snoozeThread('${state.selectedThread}')">⏱️ 推迟1小时</button>
                        <button class="btn-action" onclick="markWaiting('${state.selectedThread}')">⌛ 等待对方</button>
                        <button class="btn-action btn-resolve" onclick="resolveThread('${state.selectedThread}')">✅ 标记已解决</button>
                    </div>
                </div>
            `;
        }
        
        // 建档
        async function promoteContact(contactId, name) {
            const customerName = prompt('请输入客户名称:', name);
            if (!customerName) return;
            
            const region = prompt('请输入地区代码(可选,如"渝A"):', '');
            const level = prompt('请输入客户级别(可选,如"VIP"):', '');
            
            try {
                const res = await fetch('/api/hub/contacts/promote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contact_id: contactId,
                        customer_name: customerName,
                        region: region || null,
                        level: level || null
                    })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert(`建档成功！K编码: ${data.data.k_code}`);
                    await loadUnknownPool();
                    await loadTodayTodo();
                } else {
                    alert('建档失败: ' + data.message);
                }
            } catch (err) {
                alert('建档失败: ' + err.message);
            }
        }
        
        // 忽略
        async function ignoreItem(threadId) {
            await snoozeThread(threadId, 1440); // 推迟24小时
        }
        
        // 拉黑
        async function blacklistItem(contactId) {
            if (!confirm('确定要将此联系人拉黑吗？')) return;
            alert('拉黑功能待实现');
        }
        
        // 推迟
        async function snoozeThread(threadId, minutes = 60) {
            try {
                const res = await fetch(`/api/hub/threads/${threadId}/snooze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snooze_minutes: minutes })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('已推迟处理');
                    await loadUnknownPool();
                    await loadTodayTodo();
                }
            } catch (err) {
                alert('操作失败: ' + err.message);
            }
        }
        
        // 标记等待对方
        async function markWaiting(threadId) {
            try {
                const res = await fetch(`/api/hub/threads/${threadId}/waiting`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('已标记为等待对方');
                    await loadTodayTodo();
                }
            } catch (err) {
                alert('操作失败: ' + err.message);
            }
        }
        
        // 标记已解决
        async function resolveThread(threadId) {
            if (!confirm('确定要标记为已解决吗？')) return;
            
            try {
                const res = await fetch(`/api/hub/threads/${threadId}/resolve`, {
                    method: 'POST'
                });
                
                const data = await res.json();
                
                if (data.success) {
                    alert('已标记为已解决');
                    state.selectedThread = null;
                    await loadTodayTodo();
                    renderWorkspace();
                }
            } catch (err) {
                alert('操作失败: ' + err.message);
            }
        }
        
        // 复制草稿
        function copyDraft() {
            alert('复制功能待实现');
        }
        
        // 格式化时间
        function formatTime(isoString) {
            if (!isoString) return '--';
            const date = new Date(isoString);
            const now = new Date();
            const diff = (now - date) / 1000 / 60; // 分钟
            
            if (diff < 1) return '刚刚';
            if (diff < 60) return Math.floor(diff) + '分钟前';
            if (diff < 1440) return Math.floor(diff / 60) + '小时前';
            return Math.floor(diff / 1440) + '天前';
        }
        
        // 启动
        init();
    </script>
</body>
</html>

