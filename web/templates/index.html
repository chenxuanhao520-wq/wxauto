{% extends "base.html" %}
{% block title %}首页 - 微信客服中台{% endblock %}
{% block content %}
<div class="row">
    <div class="col-12">
        <h1><i class="bi bi-house"></i> 系统概览</h1>
        <hr>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card status-card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-chat-dots"></i> 今日消息</h5>
                <h3 id="messages-today">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card success-card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-people"></i> 活跃会话</h5>
                <h3 id="active-sessions">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card warning-card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-robot"></i> AI 状态</h5>
                <h3 id="ai-status">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card danger-card">
            <div class="card-body">
                <h5 class="card-title"><i class="bi bi-book"></i> 知识库</h5>
                <h3 id="kb-count">-</h3>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-clock-history"></i> 最近消息</h5>
            </div>
            <div class="card-body">
                <div id="recent-messages">
                    <p class="text-muted">加载中...</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-tools"></i> 快速操作</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{{ url_for('config_page') }}" class="btn btn-primary">
                        <i class="bi bi-gear"></i> 配置管理
                    </a>
                    <a href="{{ url_for('monitor_page') }}" class="btn btn-info">
                        <i class="bi bi-graph-up"></i> 系统监控
                    </a>
                    <a href="{{ url_for('test_page') }}" class="btn btn-success">
                        <i class="bi bi-bug"></i> 功能测试
                    </a>
                    <a href="{{ url_for('logs_page') }}" class="btn btn-secondary">
                        <i class="bi bi-chat-text"></i> 查看日志
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const socket = io();
    
    // 连接成功
    socket.on('connect', function() {
        console.log('WebSocket 连接成功');
        socket.emit('request_status');
    });
    
    // 接收状态更新
    socket.on('status_update', function(data) {
        document.getElementById('messages-today').textContent = data.messages_today || 0;
        document.getElementById('active-sessions').textContent = data.active_sessions || 0;
    });
    
    // 加载初始数据
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('messages-today').textContent = data.messages_today || 0;
            document.getElementById('active-sessions').textContent = data.active_sessions || 0;
            document.getElementById('ai-status').textContent = data.ai_status === 'available' ? '正常' : '异常';
            document.getElementById('kb-count').textContent = data.knowledge_base_count || 0;
            
            // 显示最近消息
            const messagesDiv = document.getElementById('recent-messages');
            if (data.recent_messages && data.recent_messages.length > 0) {
                messagesDiv.innerHTML = data.recent_messages.map(msg => 
                    `<div class="mb-2">
                        <strong>${msg[0]}:</strong> ${msg[1].substring(0, 50)}...
                        <small class="text-muted">${new Date(msg[2]).toLocaleString()}</small>
                    </div>`
                ).join('');
            } else {
                messagesDiv.innerHTML = '<p class="text-muted">暂无消息</p>';
            }
        })
        .catch(error => {
            console.error('加载状态失败:', error);
        });
    
    // 定期更新状态
    setInterval(() => {
        socket.emit('request_status');
    }, 10000);
</script>
{% endblock %}