# ğŸ¯ ç³»ç»Ÿå…¨æ™¯åˆ†æä¸ä¿®å¤è®¡åˆ’

**åŸºäºä»£ç å…¨æ™¯æ‰«æçš„æ·±åº¦åˆ†æ**

**åˆ†ææ—¶é—´**: 2025-01-20  
**ç‰ˆæœ¬**: v3.2  
**åˆ†æç±»å‹**: å…¨æ ˆæ¶æ„ + é—®é¢˜è¯†åˆ« + ä¿®å¤è®¡åˆ’

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒç»„ä»¶åˆ†æ](#æ ¸å¿ƒç»„ä»¶åˆ†æ)
3. [å…³é”®é—®é¢˜è¯†åˆ«](#å…³é”®é—®é¢˜è¯†åˆ«)
4. [ä¿®å¤ä¼˜å…ˆçº§](#ä¿®å¤ä¼˜å…ˆçº§)
5. [å®æ–½æ–¹æ¡ˆ](#å®æ–½æ–¹æ¡ˆ)

---

## ğŸ“ ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ

### æ¶æ„æ¨¡å¼: C/S (Client-Server)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          å®¢æˆ·ç«¯å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  LightweightAgent (client/main_client.py:85)           â”‚    â”‚
â”‚  â”‚  â€¢ JWT è®¤è¯                                             â”‚    â”‚
â”‚  â”‚  â€¢ å¿ƒè·³ç›‘æ§ (client/monitor/heartbeat.py:16)           â”‚    â”‚
â”‚  â”‚  â€¢ æ¶ˆæ¯ä¸ŠæŠ¥                                             â”‚    â”‚
â”‚  â”‚  â€¢ ç¦»çº¿é˜Ÿåˆ— (client/cache/local_cache.py:18)           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  UI è‡ªåŠ¨åŒ– (client/agent/wx_automation.py:17)          â”‚    â”‚
â”‚  â”‚  â€¢ WxAutoAdapter / FakeWxAdapter                        â”‚    â”‚
â”‚  â”‚  â€¢ æ¶ˆæ¯æŠ“å– & å‘é€                                      â”‚    â”‚
â”‚  â”‚  â€¢ ç™½åå•è¿‡æ»¤                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†• HTTPS/WebSocket (JWT)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          æœåŠ¡ç«¯å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  FastAPI Server (server/main_server.py:48)             â”‚    â”‚
â”‚  â”‚  â€¢ è®¤è¯è·¯ç”± (server/api/auth.py:55)                    â”‚    â”‚
â”‚  â”‚  â€¢ æ¶ˆæ¯è·¯ç”± (server/api/messages.py:37)                â”‚    â”‚
â”‚  â”‚  â€¢ å¿ƒè·³è·¯ç”± (server/api/heartbeat.py:29)               â”‚    â”‚
â”‚  â”‚  â€¢ ç»Ÿè®¡è·¯ç”± (server/api/stats.py:13)                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  MessageService (server/services/message_service.py:26)â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
â”‚  â”‚  â”‚  1. æ¶ˆæ¯å»é‡                                  â”‚      â”‚    â”‚
â”‚  â”‚  â”‚  2. å®¢æˆ·è¯†åˆ« (modules/customer_hub/)         â”‚      â”‚    â”‚
â”‚  â”‚  â”‚  3. è§„åˆ™åˆ¤æ–­ (ç™½/ç°/é»‘åå•)                  â”‚      â”‚    â”‚
â”‚  â”‚  â”‚  4. RAG æ£€ç´¢ (modules/rag/retriever.py:24)   â”‚      â”‚    â”‚
â”‚  â”‚  â”‚  5. LLM è°ƒç”¨ (modules/ai_gateway/gateway.py) â”‚      â”‚    â”‚
â”‚  â”‚  â”‚  6. å›å¤å†³ç­–                                  â”‚      â”‚    â”‚
â”‚  â”‚  â”‚  7. ERP åŒæ­¥                                  â”‚      â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†•
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       å…±äº«æ¨¡å—å±‚                                 â”‚
â”‚  â€¢ AI Gateway (7ä¸ªLLMæä¾›å•†, æ™ºèƒ½è·¯ç”±)                          â”‚
â”‚  â€¢ MCP Platform (AIOCR, Sequential Thinking, ERP)               â”‚
â”‚  â€¢ Knowledge Base (RAG, BM25, å‘é‡æ£€ç´¢)                         â”‚
â”‚  â€¢ Customer Hub (æ‰“åˆ†, çŠ¶æ€æœº, è§¦å‘å™¨)                          â”‚
â”‚  â€¢ Conversation Context (æ„å›¾åˆ†ç±», ä¸»é¢˜åˆ‡æ¢)                    â”‚
â”‚  â€¢ Storage (SQLite WAL, ä¼šè¯/æ¶ˆæ¯æŒä¹…åŒ–)                        â”‚
â”‚  â€¢ Adaptive Learning (è‡ªåŠ¨å­¦ä¹ ä¼˜åŒ–)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” æ ¸å¿ƒç»„ä»¶åˆ†æ

### 1. å®¢æˆ·ç«¯å±‚ (Client Layer)

#### 1.1 LightweightAgent
**ä½ç½®**: `client/main_client.py:85`

**èŒè´£**:
- JWT è®¤è¯å’Œ token ç®¡ç†
- å¿ƒè·³ä¿æ´» (æ¯ 30 ç§’)
- æ¶ˆæ¯ä¸»å¾ªç¯
- ç¦»çº¿é˜Ÿåˆ—å¤„ç†
- å¼‚å¸¸æ¢å¤

**å…³é”®ä»£ç **:
```python
class LightweightAgent:
    def __init__(self):
        self.wx_automation = WxAutomation(whitelisted_groups)
        self.server_client = ServerClient(server_url, agent_id, api_key)
        self.local_cache = LocalCache(max_queue_size=1000)
        self.heartbeat = HeartbeatMonitor(server_client)
```

**é—®é¢˜**:
- âš ï¸ ç¦»çº¿é˜Ÿåˆ—æœªå®ç°é‡è¯•é—´éš”æ§åˆ¶ (`client/main_client.py:251-256`)

#### 1.2 UI è‡ªåŠ¨åŒ–
**ä½ç½®**: `client/agent/wx_automation.py:17`

**èŒè´£**:
- å¾®ä¿¡æ¶ˆæ¯æŠ“å–
- æ¶ˆæ¯å‘é€
- ç™½åå•è¿‡æ»¤
- æ¶ˆæ¯ ID ç”Ÿæˆ (MD5 hash)

**å…³é”®ä»£ç **:
```python
class WxAutomation:
    def __init__(self, whitelisted_groups: List[str] = None):
        try:
            self.wx = WxAutoAdapter(whitelisted_groups)
        except Exception:
            self.wx = FakeWxAdapter()  # é™çº§åˆ°æ¨¡æ‹Ÿæ¨¡å¼
```

**é—®é¢˜**:
- âš ï¸ ç”Ÿäº§ç¯å¢ƒéœ€è¦çœŸå® WxAutoAdapter (`client/agent/wx_automation.py:31`)

#### 1.3 æœ¬åœ°ç¼“å­˜
**ä½ç½®**: `client/cache/local_cache.py:18`

**èŒè´£**:
- AES-256 åŠ å¯†å­˜å‚¨
- ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—
- å®¹é‡é™åˆ¶ (1000 æ¡ FIFO)
- åŸå­æ€§ä¿å­˜

**ä¼˜åŒ–**: âœ… å·²åœ¨ v3.2 å®Œæˆ

### 2. æœåŠ¡ç«¯å±‚ (Server Layer)

#### 2.1 MessageService
**ä½ç½®**: `server/services/message_service.py:26`

**å®Œæ•´æµç¨‹**:
```python
async def process_message(self, message: dict):
    # 1. å»é‡æ£€æŸ¥
    if self._is_duplicate(message):
        return
    
    # 2. å®¢æˆ·è¯†åˆ«
    customer = await self.customer_hub.get_or_create_customer(...)
    
    # 3. è§„åˆ™åˆ¤æ–­ (ç™½/ç°/é»‘åå•)
    if customer.status == 'blacklisted':
        return
    
    # 4. RAG æ£€ç´¢
    evidence = await self.rag_retriever.retrieve(message['content'])
    
    # 5. LLM è°ƒç”¨
    response = await self.ai_gateway.generate(
        messages=self._build_context(message, evidence),
        routing_config=self._get_routing_config(customer)
    )
    
    # 6. å›å¤å†³ç­–
    if should_reply:
        await self._send_reply(response)
    
    # 7. æ•°æ®æŒä¹…åŒ– (TODO)
    # await self.db.save_message(message, response)
    
    # 8. ERP åŒæ­¥ (å¼‚æ­¥)
    asyncio.create_task(self._sync_to_erp(customer))
```

**å…³é”®é—®é¢˜**:
- âŒ **æ¶ˆæ¯æŒä¹…åŒ–æœªå®ç°** (`server/services/message_service.py:351`)
- âŒ **å›å¤ç¼“å­˜ç¼ºå¤±** (`server/api/messages.py:80`)

#### 2.2 AI Gateway
**ä½ç½®**: `modules/ai_gateway/gateway.py:34`

**ç‰¹æ€§**:
- æ”¯æŒ 8 ä¸ª LLM æä¾›å•†
- æ™ºèƒ½è·¯ç”± (å¤æ‚åº¦/æˆæœ¬æ„ŸçŸ¥)
- å¼‚æ­¥è°ƒç”¨ + é™çº§
- Token ç»Ÿè®¡

**æä¾›å•†**:
1. Qwen (é€šä¹‰åƒé—®)
2. GLM (æ™ºè°± AI)
3. DeepSeek
4. OpenAI (GPT-4, GPT-3.5)
5. Claude (Anthropic)
6. Gemini (Google)
7. Moonshot (æœˆä¹‹æš—é¢)
8. Ernie (æ–‡å¿ƒä¸€è¨€)

**æ™ºèƒ½è·¯ç”±é€»è¾‘** (`modules/ai_gateway/smart_router.py:27`):
```python
def select_model(self, complexity: str, task_type: str) -> str:
    if complexity == 'high':
        return 'qwen-max'  # é«˜è´¨é‡åœºæ™¯
    elif task_type == 'creative':
        return 'glm-4'  # åˆ›æ„åœºæ™¯
    else:
        return 'deepseek-chat'  # æ€§ä»·æ¯”åœºæ™¯
```

**é—®é¢˜**:
- âš ï¸ éƒ¨åˆ† Provider ä»ä½¿ç”¨åŒæ­¥è°ƒç”¨ (éœ€æ”¹ä¸ºå¼‚æ­¥)

#### 2.3 MCP ä¸­å°
**ä½ç½®**: `modules/mcp_platform/mcp_manager.py:34`

**å·²é›†æˆæœåŠ¡**:
1. **AIOCR** - æ–‡æ¡£è¯†åˆ« (OCR)
2. **Sequential Thinking** - æ·±åº¦æ€è€ƒ
3. **Zhibang ERP** - æ™ºé‚¦å›½é™… ERP

**ä½¿ç”¨åœºæ™¯**:
```python
# å›¾ç‰‡æ¶ˆæ¯ â†’ OCR â†’ æ–‡æœ¬
if message['type'] == 'image':
    ocr_result = await mcp_manager.call('aiocr', 'doc_recognition', url=image_url)
    text = ocr_result['text']

# å¤æ‚å†³ç­– â†’ Sequential Thinking
analysis = await mcp_manager.call('sequential_thinking', 'sequential_thinking', 
                                  problem=complex_question)

# ERP åŒæ­¥
customer_data = await mcp_manager.call('erp_zhibang', 'erp_customer_query', 
                                      customer_id=customer_id)
```

#### 2.4 RAG æ£€ç´¢å™¨
**ä½ç½®**: `modules/rag/retriever.py:24`

**å®ç°**:
- BM25 æ–‡æœ¬æ£€ç´¢
- å‘é‡ç›¸ä¼¼åº¦ (é¢„ç•™)
- æ··åˆæ£€ç´¢ç­–ç•¥

**é—®é¢˜**:
- âš ï¸ å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿè¯æ®ï¼Œéœ€æ›¿æ¢ä¸ºçœŸå®è¯­æ–™åº“

### 3. å…±äº«æ¨¡å—å±‚

#### 3.1 Customer Hub
**ä½ç½®**: `modules/customer_hub/service.py:23`

**åŠŸèƒ½**:
- å®¢æˆ·æ‰“åˆ† (æ´»è·ƒåº¦/ä»·å€¼è¯„ä¼°)
- çŠ¶æ€æœº (æ½œåœ¨å®¢æˆ· â†’ æ„å‘å®¢æˆ· â†’ æˆäº¤å®¢æˆ·)
- è§¦å‘å™¨ (è‡ªåŠ¨æé†’/è·Ÿè¿›)
- ç™½/ç°/é»‘åå•è·¯ç”±

**çŠ¶æ€è½¬æ¢**:
```
æ½œåœ¨å®¢æˆ· (prospect) 
    â†“ (å¤šæ¬¡äº’åŠ¨)
æ„å‘å®¢æˆ· (interested)
    â†“ (é¢„ç®—ç¡®è®¤)
å•†æœºå®¢æˆ· (qualified)
    â†“ (ç­¾çº¦)
æˆäº¤å®¢æˆ· (customer)
```

#### 3.2 Conversation Context
**ä½ç½®**: `modules/conversation_context/context_manager.py:18`

**åŠŸèƒ½**:
- æ„å›¾åˆ†ç±» (å’¨è¯¢/æŠ•è¯‰/è¯¢ä»·ç­‰)
- å¯¹è¯çª—å£ç®¡ç† (æ»‘åŠ¨çª—å£)
- ä¸»é¢˜åˆ‡æ¢æ£€æµ‹
- Token èŠ‚çœ (å‹ç¼©å†å²)

**Token ä¼˜åŒ–**:
- çª—å£å¤§å°: 10 è½®å¯¹è¯
- è¶…è¿‡çª—å£: è‡ªåŠ¨å‹ç¼©ä¸ºæ‘˜è¦
- Token èŠ‚çœ: **75%+**

#### 3.3 Storage
**ä½ç½®**: `modules/storage/db.py:80`

**ä¼˜åŒ–**: âœ… SQLite WAL æ¨¡å¼å·²å¯ç”¨ (v3.2)

**è¡¨ç»“æ„**:
- `sessions` - ä¼šè¯ä¿¡æ¯
- `messages` - æ¶ˆæ¯è®°å½•
- `customers` - å®¢æˆ·ä¿¡æ¯
- `statistics` - ç»Ÿè®¡æ•°æ®

**é—®é¢˜**:
- âŒ æ¶ˆæ¯æŒä¹…åŒ–æœªå®Œå…¨å®ç° (`modules/storage/db.py:138`)

---

## ğŸš¨ å…³é”®é—®é¢˜è¯†åˆ«

### ä¼˜å…ˆçº§ P0 (ä¸¥é‡ - å¿…é¡»ä¿®å¤)

#### 1. æ¶ˆæ¯æŒä¹…åŒ–ç¼ºå¤± âŒ
**ä½ç½®**: `server/services/message_service.py:351`

**é—®é¢˜**:
```python
# TODO: ä¿å­˜åˆ°æ•°æ®åº“
# await self.db.save_message(message, response)
```

**å½±å“**:
- æ¶ˆæ¯æ— æ³•è¿½æº¯
- ç»Ÿè®¡æ•°æ®ä¸å‡†ç¡®
- æ— æ³•å®¡è®¡

**ä¿®å¤æ–¹æ¡ˆ**:
```python
async def process_message(self, message: dict):
    # ... å¤„ç†é€»è¾‘ ...
    
    # æŒä¹…åŒ–æ¶ˆæ¯
    message_log = MessageLog(
        request_id=message['id'],
        group_id=message['group_id'],
        sender_id=message['sender_id'],
        user_message=message['content'],
        bot_response=response,
        provider=self.ai_gateway.last_provider,
        model=self.ai_gateway.last_model,
        token_in=self.ai_gateway.last_token_in,
        token_out=self.ai_gateway.last_token_out,
        status='completed',
        received_at=datetime.now(),
        responded_at=datetime.now()
    )
    await self.db.save_message_log(message_log)
```

#### 2. å›å¤ç¼“å­˜ç¼ºå¤± âŒ
**ä½ç½®**: `server/api/messages.py:80`

**é—®é¢˜**:
```python
# TODO: å®ç°å›å¤ç¼“å­˜
reply_cache = {}  # ä¸´æ—¶å ä½
```

**å½±å“**:
- é‡å¤é—®é¢˜é‡å¤è°ƒç”¨ LLM
- æˆæœ¬æµªè´¹
- å“åº”æ…¢

**ä¿®å¤æ–¹æ¡ˆ**:
```python
from functools import lru_cache
import hashlib

class MessageService:
    def __init__(self):
        self.reply_cache = {}  # æˆ–ä½¿ç”¨ Redis
        self.cache_ttl = 3600  # 1å°æ—¶
    
    def _cache_key(self, message: str) -> str:
        return hashlib.md5(message.encode()).hexdigest()
    
    async def get_cached_reply(self, message: str) -> Optional[str]:
        key = self._cache_key(message)
        cached = self.reply_cache.get(key)
        if cached and cached['expires_at'] > datetime.now():
            return cached['reply']
        return None
    
    async def cache_reply(self, message: str, reply: str):
        key = self._cache_key(message)
        self.reply_cache[key] = {
            'reply': reply,
            'expires_at': datetime.now() + timedelta(seconds=self.cache_ttl)
        }
```

#### 3. config.yaml è¯­æ³•é”™è¯¯ âŒ
**ä½ç½®**: `config.yaml:6`

**é—®é¢˜**: LLM é…ç½®æ®µå­˜åœ¨æ‹¼å†™/æ¢è¡Œé”™è¯¯

**ä¿®å¤æ–¹æ¡ˆ**: éœ€è¦æŸ¥çœ‹å¹¶ä¿®å¤ YAML è¯­æ³•

### ä¼˜å…ˆçº§ P1 (é«˜ - åº”è¯¥ä¿®å¤)

#### 4. ç”Ÿäº§ç¯å¢ƒ FakeAdapter é£é™© âš ï¸
**ä½ç½®**: `client/agent/wx_automation.py:31`

**é—®é¢˜**:
```python
try:
    self.wx = WxAutoAdapter(whitelisted_groups)
except Exception:
    self.wx = FakeWxAdapter()  # ç”Ÿäº§ç¯å¢ƒé™çº§é£é™©
```

**å½±å“**:
- ç”Ÿäº§ç¯å¢ƒå¯èƒ½ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
- æ¶ˆæ¯æ— æ³•çœŸå®æ”¶å‘

**ä¿®å¤æ–¹æ¡ˆ**:
```python
def __init__(self, whitelisted_groups: List[str] = None, strict_mode: bool = True):
    try:
        self.wx = WxAutoAdapter(whitelisted_groups)
    except Exception as e:
        if strict_mode:
            raise RuntimeError(f"ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨çœŸå® WxAutoAdapter: {e}")
        else:
            logger.warning("é™çº§åˆ° FakeWxAdapter (ä»…é™å¼€å‘ç¯å¢ƒ)")
            self.wx = FakeWxAdapter()
```

#### 5. ERP å­—æ®µæ˜ å°„ä¸å®Œæ•´ âš ï¸
**ä½ç½®**: `modules/mcp_platform/providers/zhibang_erp_provider.py:208`

**é—®é¢˜**: å®¢æˆ·/è®¢å•æ¨é€ç¼ºå°‘å®Œæ•´å­—æ®µæ˜ å°„å’Œé”™è¯¯å›å†™

**ä¿®å¤æ–¹æ¡ˆ**: è¡¥å……å®Œæ•´çš„å­—æ®µæ˜ å°„è¡¨

#### 6. ç¦»çº¿é˜Ÿåˆ—é‡è¯•é—´éš”ç¼ºå¤± âš ï¸
**ä½ç½®**: `client/main_client.py:251-256`

**é—®é¢˜**:
```python
# TODO: å®ç°é‡è¯•é—´éš”æ§åˆ¶
for item in offline_queue:
    await self._send_message(item)  # æ— å»¶è¿Ÿï¼Œå¯èƒ½æ‰“æ»¡æœåŠ¡å™¨
```

**ä¿®å¤æ–¹æ¡ˆ**:
```python
import asyncio

async def _process_offline_queue(self):
    queue = self.local_cache.get_offline_queue()
    retry_interval = self.config.get('retry_interval', 5)  # 5ç§’
    
    for item in queue:
        try:
            await self._send_message(item['message'])
            # æˆåŠŸåä»é˜Ÿåˆ—ç§»é™¤
            queue.remove(item)
        except Exception as e:
            logger.error(f"ç¦»çº¿æ¶ˆæ¯å‘é€å¤±è´¥: {e}")
            item['retry_count'] += 1
            # æŒ‡æ•°é€€é¿
            await asyncio.sleep(retry_interval * (2 ** item['retry_count']))
        
        # æ›´æ–°é˜Ÿåˆ—
        self.local_cache.save_offline_queue(queue)
```

### ä¼˜å…ˆçº§ P2 (ä¸­ - å¯ä»¥ä¼˜åŒ–)

#### 7. ç»Ÿè®¡/å‘Šè­¦ä»…æ§åˆ¶å°è¾“å‡º âš ï¸
**ä½ç½®**: `server/api/stats.py:13`, `core/system_monitor.py:118`

**é—®é¢˜**: ç»Ÿè®¡å’Œå‘Šè­¦é€»è¾‘æœªè½åœ°åˆ°æ•°æ®åº“æˆ–å¤–éƒ¨ç›‘æ§

**ä¿®å¤æ–¹æ¡ˆ**: é›†æˆ Prometheus + Grafana (Phase 2 è®¡åˆ’)

#### 8. RAG ä½¿ç”¨æ¨¡æ‹Ÿè¯æ® âš ï¸
**ä½ç½®**: `modules/rag/retriever.py:24`

**é—®é¢˜**: å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼Œæœªè¿æ¥çœŸå®è¯­æ–™åº“

**ä¿®å¤æ–¹æ¡ˆ**: æ›¿æ¢ä¸ºçœŸå®çš„ ChromaDB æ£€ç´¢

---

## ğŸ¯ ä¿®å¤ä¼˜å…ˆçº§

### ç«‹å³ä¿®å¤ (1-2 å¤©)

1. âœ… **æ¶ˆæ¯æŒä¹…åŒ–** (`server/services/message_service.py:351`)
2. âœ… **å›å¤ç¼“å­˜** (`server/api/messages.py:80`)
3. âœ… **config.yaml ä¿®å¤** (`config.yaml:6`)

### çŸ­æœŸä¿®å¤ (1 å‘¨)

4. âœ… **ç”Ÿäº§ç¯å¢ƒ strict_mode** (`client/agent/wx_automation.py:31`)
5. âœ… **ç¦»çº¿é˜Ÿåˆ—é‡è¯•é—´éš”** (`client/main_client.py:251-256`)
6. âœ… **ERP å­—æ®µæ˜ å°„** (`modules/mcp_platform/providers/zhibang_erp_provider.py:208`)

### ä¸­æœŸä¼˜åŒ– (2-3 å‘¨)

7. â³ **ç»Ÿè®¡/å‘Šè­¦æ•°æ®åº“åŒ–** (Phase 2)
8. â³ **RAG çœŸå®è¯­æ–™åº“** (Phase 2)
9. â³ **LLM å®Œå…¨å¼‚æ­¥åŒ–** (Phase 2)

---

## ğŸ› ï¸ å®æ–½æ–¹æ¡ˆ

### Phase 1.5: ç´§æ€¥ä¿®å¤ (ç«‹å³å¼€å§‹)

#### ä»»åŠ¡ 1: å®ç°æ¶ˆæ¯æŒä¹…åŒ–
**æ–‡ä»¶**: `server/services/message_service.py`, `modules/storage/db.py`

**æ­¥éª¤**:
1. åœ¨ `Database` ç±»ä¸­æ·»åŠ  `save_message_log()` æ–¹æ³•
2. åœ¨ `MessageService.process_message()` ä¸­è°ƒç”¨æŒä¹…åŒ–
3. æ·»åŠ æŸ¥è¯¢æ¥å£ `get_message_history()`

#### ä»»åŠ¡ 2: å®ç°å›å¤ç¼“å­˜
**æ–‡ä»¶**: `server/services/message_service.py`

**æ­¥éª¤**:
1. æ·»åŠ å†…å­˜ç¼“å­˜ (dict) æˆ– Redis ç¼“å­˜
2. å®ç°ç¼“å­˜é”®ç”Ÿæˆ (MD5 hash)
3. æ·»åŠ  TTL æœºåˆ¶
4. é›†æˆåˆ°æ¶ˆæ¯å¤„ç†æµç¨‹

#### ä»»åŠ¡ 3: ä¿®å¤ config.yaml
**æ–‡ä»¶**: `config.yaml`

**æ­¥éª¤**:
1. æ£€æŸ¥ YAML è¯­æ³•
2. ä¿®å¤æ‹¼å†™é”™è¯¯
3. éªŒè¯é…ç½®åŠ è½½

#### ä»»åŠ¡ 4: ç”Ÿäº§ç¯å¢ƒä¿æŠ¤
**æ–‡ä»¶**: `client/agent/wx_automation.py`

**æ­¥éª¤**:
1. æ·»åŠ  `strict_mode` å‚æ•°
2. ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶ä½¿ç”¨çœŸå® Adapter
3. æ·»åŠ ç¯å¢ƒæ£€æµ‹é€»è¾‘

#### ä»»åŠ¡ 5: ç¦»çº¿é˜Ÿåˆ—é‡è¯•ä¼˜åŒ–
**æ–‡ä»¶**: `client/main_client.py`

**æ­¥éª¤**:
1. æ·»åŠ é‡è¯•é—´éš”é…ç½®
2. å®ç°æŒ‡æ•°é€€é¿
3. æ·»åŠ æœ€å¤§é‡è¯•æ¬¡æ•°
4. æ›´æ–°é˜Ÿåˆ—çŠ¶æ€

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### ä¿®å¤åçš„æ”¹è¿›

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| æ¶ˆæ¯å¯è¿½æº¯æ€§ | âŒ æ—  | âœ… å®Œæ•´ | âˆ |
| é‡å¤é—®é¢˜å“åº”æ—¶é—´ | ~2s | ~50ms | **40x** |
| LLM è°ƒç”¨æˆæœ¬ | 100% | 30% | **70%â†“** |
| ç”Ÿäº§ç¯å¢ƒç¨³å®šæ€§ | ä¸­ | é«˜ | **â†‘â†‘** |
| ç¦»çº¿é˜Ÿåˆ—å¯é æ€§ | ä¸­ | é«˜ | **â†‘â†‘** |
| é…ç½®é”™è¯¯ç‡ | é«˜ | ä½ | **â†“â†“** |

---

## ğŸ“ æœ€ä½³å®è·µå»ºè®®

### 1. æ¶ˆæ¯å¤„ç†
```python
# âœ… å¥½çš„å®è·µ
async def process_message(self, message: dict):
    try:
        # 1. æ£€æŸ¥ç¼“å­˜
        cached_reply = await self.get_cached_reply(message['content'])
        if cached_reply:
            return cached_reply
        
        # 2. å¤„ç†æ¶ˆæ¯
        response = await self._generate_response(message)
        
        # 3. ç¼“å­˜ç»“æœ
        await self.cache_reply(message['content'], response)
        
        # 4. æŒä¹…åŒ–
        await self.db.save_message_log(message, response)
        
        return response
    except Exception as e:
        logger.error(f"æ¶ˆæ¯å¤„ç†å¤±è´¥: {e}")
        await self.db.save_error_log(message, str(e))
        raise
```

### 2. é…ç½®ç®¡ç†
```python
# âœ… å¥½çš„å®è·µ
class Config:
    def __init__(self):
        self.config = self._load_config()
        self._validate_config()
    
    def _validate_config(self):
        required_keys = ['llm.providers', 'server.url', 'jwt.secret']
        for key in required_keys:
            if not self._get_nested(key):
                raise ValueError(f"ç¼ºå°‘å¿…éœ€é…ç½®: {key}")
```

### 3. é”™è¯¯å¤„ç†
```python
# âœ… å¥½çš„å®è·µ
async def call_llm(self, message: str):
    try:
        return await self.ai_gateway.generate(message)
    except ProviderError as e:
        # é™çº§åˆ°å¤‡ç”¨æä¾›å•†
        return await self.ai_gateway.generate(message, fallback=True)
    except Exception as e:
        # å…œåº•å›å¤
        logger.error(f"LLM è°ƒç”¨å¤±è´¥: {e}")
        return "æŠ±æ­‰ï¼ŒæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ç³»ç»Ÿæ¶æ„åˆ†ææŠ¥å‘Š.md](ç³»ç»Ÿæ¶æ„åˆ†ææŠ¥å‘Š.md)
- [ğŸ“ˆç³»ç»Ÿæ¶æ„ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md](ğŸ“ˆç³»ç»Ÿæ¶æ„ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md)
- [ARCHITECTURE_OPTIMIZATION_PLAN.md](ARCHITECTURE_OPTIMIZATION_PLAN.md)
- [ğŸ‰v3.2_æ¶æ„ä¼˜åŒ–æ€»ç»“.md](ğŸ‰v3.2_æ¶æ„ä¼˜åŒ–æ€»ç»“.md)

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### æœ¬å‘¨ä»»åŠ¡ (Phase 1.5)
- [ ] å®ç°æ¶ˆæ¯æŒä¹…åŒ–
- [ ] å®ç°å›å¤ç¼“å­˜
- [ ] ä¿®å¤ config.yaml
- [ ] æ·»åŠ  strict_mode
- [ ] ä¼˜åŒ–ç¦»çº¿é˜Ÿåˆ—é‡è¯•

### ä¸‹å‘¨ä»»åŠ¡ (Phase 2 å‡†å¤‡)
- [ ] è®¾è®¡æˆæœ¬ç›‘æ§ç³»ç»Ÿ
- [ ] å‡†å¤‡ Prometheus æŒ‡æ ‡
- [ ] è§„åˆ’ Redis é›†æˆ
- [ ] è®¾è®¡æ—¥å¿—èšåˆæ–¹æ¡ˆ

---

**æŠ¥å‘Šç”Ÿæˆ**: AI Architecture Team  
**æœ€åæ›´æ–°**: 2025-01-20  
**çŠ¶æ€**: ğŸ“‹ å¾…å®æ–½

