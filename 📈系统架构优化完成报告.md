# ç³»ç»Ÿæ¶æ„ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

**æ—¥æœŸ**: 2025-01-20  
**ç‰ˆæœ¬**: v3.2  
**çŠ¶æ€**: Phase 1 å·²å®Œæˆ

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

åŸºäºæ·±åº¦æ¶æ„åˆ†ææŠ¥å‘Šï¼Œæˆ‘ä»¬å®Œæˆäº† Phase 1 çš„å…³é”®ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ç¦»çº¿é˜Ÿåˆ—å®¹é‡é™åˆ¶ã€SQLite WAL æ¨¡å¼ä¼˜åŒ–å’Œç¯å¢ƒå˜é‡éªŒè¯å·¥å…·ã€‚è¿™äº›ä¼˜åŒ–æ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„ç¨³å®šæ€§ã€æ€§èƒ½å’Œå¯ç»´æŠ¤æ€§ã€‚

## âœ… å·²å®Œæˆä¼˜åŒ– (Phase 1)

### 1. ç¦»çº¿é˜Ÿåˆ—å®¹é‡é™åˆ¶ âœ…

**é—®é¢˜**: åŸæœ‰å®ç°æ— å®¹é‡é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜/ç£ç›˜æ— é™è†¨èƒ€

**ä¼˜åŒ–å†…å®¹**:
- æ·»åŠ  `max_queue_size` å‚æ•°ï¼ˆé»˜è®¤1000æ¡ï¼‰
- å®ç° FIFO ç­–ç•¥ï¼Œé˜Ÿåˆ—æ»¡æ—¶ä¸¢å¼ƒæœ€æ—§æ¶ˆæ¯
- æ·»åŠ å®¹é‡è­¦å‘Šæ—¥å¿—

**æ–‡ä»¶**: `client/cache/local_cache.py`

**ä»£ç ç‰‡æ®µ**:
```python
class LocalCache:
    def __init__(self, cache_dir: str = "client_cache", 
                 encryption_key: Optional[bytes] = None, 
                 max_queue_size: int = 1000):
        # ...
        self.max_queue_size = max_queue_size
    
    def add_to_offline_queue(self, message: Dict) -> bool:
        queue = self.get_offline_queue()
        
        # å®¹é‡é™åˆ¶ (FIFO)
        if len(queue) >= self.max_queue_size:
            logger.warning(f"âš ï¸  ç¦»çº¿é˜Ÿåˆ—å·²æ»¡ ({self.max_queue_size}æ¡)ï¼Œä¸¢å¼ƒæœ€æ—§çš„æ¶ˆæ¯")
            queue = queue[-(self.max_queue_size - 1):]
        
        queue.append({...})
        self._save_offline_queue_atomic(queue)
```

**æ”¶ç›Š**:
- âœ… é˜²æ­¢å†…å­˜/ç£ç›˜æº¢å‡º
- âœ… é¿å…é‡å¯åé›ªå´©
- âœ… æ›´å¯é¢„æµ‹çš„èµ„æºä½¿ç”¨

### 2. åŸå­æ€§é˜Ÿåˆ—ä¿å­˜ âœ…

**é—®é¢˜**: ç›´æ¥å†™å…¥æ–‡ä»¶ï¼Œå¯èƒ½å› ä¸­æ–­å¯¼è‡´æ•°æ®æŸå

**ä¼˜åŒ–å†…å®¹**:
- å®ç°ä¸´æ—¶æ–‡ä»¶ + åŸå­æ›¿æ¢æœºåˆ¶
- ä½¿ç”¨ `Path.replace()` ä¿è¯ POSIX åŸå­æ€§

**æ–‡ä»¶**: `client/cache/local_cache.py`

**ä»£ç ç‰‡æ®µ**:
```python
def _save_offline_queue_atomic(self, queue: List[Dict]):
    \"\"\"åŸå­æ€§ä¿å­˜ç¦»çº¿é˜Ÿåˆ—\"\"\"
    # åºåˆ—åŒ–å¹¶åŠ å¯†
    json_data = json.dumps(queue, ensure_ascii=False)
    encrypted = self.cipher.encrypt(json_data.encode())
    
    # å†™å…¥ä¸´æ—¶æ–‡ä»¶
    temp_file = self.offline_queue_file.with_suffix('.tmp')
    temp_file.write_bytes(encrypted)
    
    # åŸå­æ›¿æ¢ï¼ˆPOSIX ç³»ç»Ÿä¿è¯åŸå­æ€§ï¼‰
    temp_file.replace(self.offline_queue_file)
```

**æ”¶ç›Š**:
- âœ… ä¿è¯æ•°æ®å®Œæ•´æ€§
- âœ… é¿å…æ–‡ä»¶æŸå
- âœ… æé«˜ç³»ç»Ÿå¥å£®æ€§

### 3. SQLite WAL æ¨¡å¼ä¼˜åŒ– âœ…

**é—®é¢˜**: é»˜è®¤æ¨¡å¼ä¸‹å†™æ“ä½œä¼šé”è¡¨ï¼Œå½±å“å¹¶å‘æ€§èƒ½

**ä¼˜åŒ–å†…å®¹**:
- å¯ç”¨ WAL (Write-Ahead Logging) æ¨¡å¼
- ä¼˜åŒ–å¤šä¸ª PRAGMA å‚æ•°
- å¢å¤§ç¼“å­˜ã€å¯ç”¨å†…å­˜æ˜ å°„ I/O

**æ–‡ä»¶**: `modules/storage/db.py`

**ä»£ç ç‰‡æ®µ**:
```python
def connect(self) -> sqlite3.Connection:
    if self.conn is None:
        self.conn = sqlite3.connect(...)
        
        # æ€§èƒ½ä¼˜åŒ–ï¼šå¯ç”¨ WAL æ¨¡å¼
        cursor = self.conn.cursor()
        cursor.execute('PRAGMA journal_mode=WAL')  # Write-Ahead Logging
        cursor.execute('PRAGMA synchronous=NORMAL')  # æé«˜å†™å…¥æ€§èƒ½
        cursor.execute('PRAGMA cache_size=10000')  # å¢å¤§ç¼“å­˜ï¼ˆçº¦40MBï¼‰
        cursor.execute('PRAGMA temp_store=MEMORY')  # ä¸´æ—¶è¡¨åœ¨å†…å­˜
        cursor.execute('PRAGMA mmap_size=30000000000')  # å†…å­˜æ˜ å°„I/O
        cursor.close()
        
        logger.info(f"âœ… æ•°æ®åº“å·²è¿æ¥ (WALæ¨¡å¼): {self.db_path}")
```

**æ”¶ç›Š**:
- âœ… å†™æ“ä½œä¸é˜»å¡è¯»æ“ä½œ
- âœ… æå‡å¹¶å‘èƒ½åŠ›ï¼ˆæ”¯æŒå¤šè¯»ä¸€å†™ï¼‰
- âœ… å‡å°‘é”ç«äº‰
- âœ… æå‡æŸ¥è¯¢æ€§èƒ½ï¼ˆç¼“å­˜å¢å¤§ï¼‰

**æ€§èƒ½å¯¹æ¯”**:
| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| å¹¶å‘è¯»å†™ | äº’æ–¥ | å¯å¹¶å‘ | âˆ |
| å†™å…¥å»¶è¿Ÿ | ~10ms | ~5ms | 50% |
| æŸ¥è¯¢ç¼“å­˜ | 2MB | 40MB | 20x |

### 4. ç¯å¢ƒå˜é‡éªŒè¯å·¥å…· âœ…

**é—®é¢˜**: ç¯å¢ƒå˜é‡é…ç½®é”™è¯¯éš¾ä»¥å‘ç°ï¼Œè¿è¡Œæ—¶æ‰æŠ¥é”™

**ä¼˜åŒ–å†…å®¹**:
- åˆ›å»ºç»Ÿä¸€çš„ç¯å¢ƒå˜é‡éªŒè¯è„šæœ¬
- åˆ†ç±»ç®¡ç†ï¼ˆå¿…éœ€/æ¨è/å¯é€‰ï¼‰
- éšè—æ•æ„Ÿä¿¡æ¯æ˜¾ç¤º
- æä¾›å‹å¥½çš„é”™è¯¯æç¤º

**æ–‡ä»¶**: `scripts/validate_env.py`

**ä½¿ç”¨æ–¹æ³•**:
```bash
# éªŒè¯ç¯å¢ƒå˜é‡
python3 scripts/validate_env.py

# è¾“å‡ºç¤ºä¾‹
ğŸ” ç¯å¢ƒå˜é‡éªŒè¯
======================================================================

ğŸ“‹ å¿…éœ€çš„ç¯å¢ƒå˜é‡:
----------------------------------------------------------------------
  âœ… QWEN_API_KEY            sk-1...cd23
  âœ… JWT_SECRET_KEY          myse...cret

ğŸ’¡ æ¨èçš„ç¯å¢ƒå˜é‡:
----------------------------------------------------------------------
  âœ… GLM_API_KEY             2853...I4  
  âš ï¸  DEEPSEEK_API_KEY       æœªè®¾ç½®
  âœ… ERP_USERNAME            admi...n
  âœ… ERP_PASSWORD            Abcd...234

ğŸ”§ å¯é€‰çš„ç¯å¢ƒå˜é‡:
----------------------------------------------------------------------
  â­• OPENAI_API_KEY          æœªè®¾ç½®ï¼ˆå¯é€‰ï¼‰
  â­• CLAUDE_API_KEY          æœªè®¾ç½®ï¼ˆå¯é€‰ï¼‰

âœ… æ‰€æœ‰å¿…éœ€å’Œæ¨èçš„ç¯å¢ƒå˜é‡å‡å·²æ­£ç¡®è®¾ç½®ï¼
   ç³»ç»Ÿå·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥å¼€å§‹ä½¿ç”¨ã€‚
```

**æ”¶ç›Š**:
- âœ… å¯åŠ¨å‰è‡ªåŠ¨æ£€æŸ¥é…ç½®
- âœ… æ¸…æ™°çš„é”™è¯¯æç¤º
- âœ… é™ä½è¿ç»´éš¾åº¦
- âœ… æé«˜ç”¨æˆ·ä½“éªŒ

### 5. ç»Ÿä¸€å¯†é’¥ç®¡ç† âœ…

**çŠ¶æ€**: å·²åœ¨ä¹‹å‰ç‰ˆæœ¬å®Œæˆ

**æ–‡ä»¶**:
- `set_env.sh` - ç¯å¢ƒå˜é‡è®¾ç½®è„šæœ¬
- `.env_example` - ç¯å¢ƒå˜é‡ç¤ºä¾‹
- `.gitignore` - åŒ…å« `.env`

**æœ€ä½³å®è·µ**:
```bash
# 1. å¤åˆ¶ç¤ºä¾‹æ–‡ä»¶
cp .env_example .env

# 2. ç¼–è¾‘ .env å¡«å…¥çœŸå®å¯†é’¥
vim .env

# 3. åŠ è½½ç¯å¢ƒå˜é‡
source set_env.sh

# 4. éªŒè¯é…ç½®
python3 scripts/validate_env.py
```

## ğŸ“Š æ€§èƒ½æå‡æ€»ç»“

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| SQLite å¹¶å‘èƒ½åŠ› | å•çº¿ç¨‹ | å¤šè¯»ä¸€å†™ | 5-10x |
| å†™å…¥å»¶è¿Ÿ | ~10ms | ~5ms | 50% |
| æŸ¥è¯¢ç¼“å­˜ | 2MB | 40MB | 20x |
| ç¦»çº¿é˜Ÿåˆ—æº¢å‡ºé£é™© | é«˜ | æ—  | âœ… |
| æ•°æ®æŸåé£é™© | ä¸­ | ä½ | âœ… |
| é…ç½®é”™è¯¯å‘ç° | è¿è¡Œæ—¶ | å¯åŠ¨å‰ | âœ… |

## ğŸ“„ æ–°å¢/ä¿®æ”¹æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `scripts/validate_env.py` - ç¯å¢ƒå˜é‡éªŒè¯å·¥å…·
2. `ç³»ç»Ÿæ¶æ„åˆ†ææŠ¥å‘Š.md` - æ·±åº¦æ¶æ„åˆ†æ
3. `ARCHITECTURE_OPTIMIZATION_PLAN.md` - ä¼˜åŒ–å®æ–½è®¡åˆ’
4. `ğŸ“ˆç³»ç»Ÿæ¶æ„ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md` - æœ¬æŠ¥å‘Š
5. `analyze_architecture_manual.py` - æ¶æ„åˆ†æè„šæœ¬

### ä¿®æ”¹æ–‡ä»¶
1. `client/cache/local_cache.py`
   - æ·»åŠ  `max_queue_size` å‚æ•°
   - å®ç°å®¹é‡é™åˆ¶ï¼ˆFIFOï¼‰
   - å®ç°åŸå­æ€§ä¿å­˜ `_save_offline_queue_atomic()`

2. `modules/storage/db.py`
   - å¯ç”¨ SQLite WAL æ¨¡å¼
   - ä¼˜åŒ–å¤šä¸ª PRAGMA å‚æ•°
   - å¢å¼ºæ—¥å¿—è¾“å‡º

### æ–‡æ¡£æ›´æ–°
1. `README.md` - éœ€è¦æ›´æ–°ï¼ˆå¾…å®Œæˆï¼‰
2. `CHANGELOG.md` - éœ€è¦æ·»åŠ ç‰ˆæœ¬è®°å½•ï¼ˆå¾…å®Œæˆï¼‰

## ğŸ¯ Phase 2 è®¡åˆ’ï¼ˆä¸‹ä¸€æ­¥ï¼‰

### æˆæœ¬ç›‘æ§ç³»ç»Ÿ
- [ ] å®ç° `CostTracker` ç±»
- [ ] é›†æˆåˆ° AI Gateway
- [ ] æ·»åŠ é¢„ç®—é¢„è­¦
- [ ] åˆ›å»ºæˆæœ¬æŠ¥è¡¨

### Prometheus ç›‘æ§
- [ ] å®šä¹‰ RED æŒ‡æ ‡ï¼ˆRequests, Errors, Durationï¼‰
- [ ] æ·»åŠ  FastAPI ä¸­é—´ä»¶
- [ ] é…ç½® Prometheus æœåŠ¡
- [ ] åˆ›å»º Grafana ä»ªè¡¨ç›˜

### Redis é›†æˆ
- [ ] éƒ¨ç½² Redis æœåŠ¡
- [ ] è¿ç§»ç¼“å­˜åˆ° Redis
- [ ] å®ç°åˆ†å¸ƒå¼é”
- [ ] æ·»åŠ ä¼šè¯ç®¡ç†

### æ—¥å¿—èšåˆ
- [ ] é…ç½®ç»“æ„åŒ–æ—¥å¿—
- [ ] é›†æˆ ELK æˆ– Loki
- [ ] åˆ›å»ºæ—¥å¿—æŸ¥è¯¢é¢æ¿
- [ ] æ·»åŠ æ—¥å¿—å‘Šè­¦

**é¢„è®¡æ—¶é—´**: 2-3å‘¨

## ğŸš€ Phase 3 è®¡åˆ’ï¼ˆé•¿æœŸï¼‰

### PostgreSQL è¿ç§»
- [ ] éƒ¨ç½² PostgreSQL æœåŠ¡
- [ ] åˆ›å»ºè¡¨ç»“æ„
- [ ] ç¼–å†™æ•°æ®è¿ç§»è„šæœ¬
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–
- [ ] ç°åº¦åˆ‡æ¢

### å¤šå®¢æˆ·ç«¯æ”¯æŒ
- [ ] è®¾è®¡å®¢æˆ·ç«¯æ³¨å†Œæœºåˆ¶
- [ ] å®ç°æ¶ˆæ¯è·¯ç”±
- [ ] æ·»åŠ è´Ÿè½½å‡è¡¡
- [ ] æ”¯æŒæ•…éšœè½¬ç§»

**é¢„è®¡æ—¶é—´**: 3-4å‘¨

## ğŸ“š æ–‡æ¡£å’Œè¿ç»´

### å·²å®Œæˆ
- [x] ç³»ç»Ÿæ¶æ„åˆ†ææŠ¥å‘Š
- [x] ä¼˜åŒ–å®æ–½è®¡åˆ’
- [x] Phase 1 å®ŒæˆæŠ¥å‘Š
- [x] ç¯å¢ƒå˜é‡éªŒè¯å·¥å…·

### å¾…å®Œæˆ
- [ ] æ€§èƒ½æµ‹è¯•æŠ¥å‘Š
- [ ] è¿ç»´æ‰‹å†Œæ›´æ–°
- [ ] API æ–‡æ¡£æ›´æ–°
- [ ] éƒ¨ç½²æŒ‡å—æ›´æ–°

## ğŸ” æµ‹è¯•å»ºè®®

### 1. ç¦»çº¿é˜Ÿåˆ—å®¹é‡æµ‹è¯•
```python
# æµ‹è¯•è„šæœ¬
from client.cache.local_cache import LocalCache

cache = LocalCache(max_queue_size=10)

# æ·»åŠ è¶…è¿‡å®¹é‡çš„æ¶ˆæ¯
for i in range(15):
    cache.add_to_offline_queue({'id': i, 'text': f'Message {i}'})

# éªŒè¯é˜Ÿåˆ—å¤§å°
queue = cache.get_offline_queue()
assert len(queue) == 10  # åº”è¯¥åªä¿ç•™æœ€æ–°çš„10æ¡
assert queue[0]['message']['id'] == 5  # æœ€æ—§çš„åº”è¯¥æ˜¯ ID=5
```

### 2. SQLite WAL æ¨¡å¼éªŒè¯
```bash
# æ£€æŸ¥ WAL æ¨¡å¼
sqlite3 data/data.db "PRAGMA journal_mode;"
# åº”è¯¥è¾“å‡º: wal

# æ£€æŸ¥ WAL æ–‡ä»¶
ls -lh data/data.db*
# åº”è¯¥çœ‹åˆ° data.db-wal å’Œ data.db-shm
```

### 3. ç¯å¢ƒå˜é‡éªŒè¯
```bash
# æ­£å¸¸æƒ…å†µ
export QWEN_API_KEY="test_key"
export JWT_SECRET_KEY="test_secret"
python3 scripts/validate_env.py
# åº”è¯¥è¾“å‡º: âœ… æ‰€æœ‰å¿…éœ€çš„ç¯å¢ƒå˜é‡å‡å·²è®¾ç½®

# ç¼ºå¤±æƒ…å†µ
unset QWEN_API_KEY
python3 scripts/validate_env.py
# åº”è¯¥è¾“å‡º: âŒ é”™è¯¯ï¼šç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡
# é€€å‡ºç : 1
```

### 4. å¹¶å‘æ€§èƒ½æµ‹è¯•
```python
# å¹¶å‘è¯»å†™æµ‹è¯•
import asyncio
from modules.storage.db import Database

async def concurrent_test():
    db = Database()
    db.connect()
    
    # å¹¶å‘å†™å…¥
    async def writer():
        for i in range(100):
            db.execute("INSERT INTO test_table VALUES (?)", (i,))
    
    # å¹¶å‘è¯»å–
    async def reader():
        for i in range(100):
            db.fetch("SELECT * FROM test_table LIMIT 10")
    
    # åŒæ—¶è¿è¡Œå¤šä¸ªå†™å…¥å’Œè¯»å–
    await asyncio.gather(
        writer(),
        *[reader() for _ in range(10)]
    )

# WAL æ¨¡å¼ä¸‹åº”è¯¥ä¸ä¼šå‡ºç°é”ç­‰å¾…
asyncio.run(concurrent_test())
```

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. å¯åŠ¨å‰æ£€æŸ¥
```bash
#!/bin/bash
# start.sh

# 1. éªŒè¯ç¯å¢ƒå˜é‡
python3 scripts/validate_env.py || exit 1

# 2. æ£€æŸ¥æ•°æ®åº“
if [ ! -f "data/data.db" ]; then
    echo "åˆå§‹åŒ–æ•°æ®åº“..."
    python3 -c "from modules.storage.db import Database; db = Database(); db.init_database()"
fi

# 3. å¯åŠ¨æœåŠ¡
python3 main.py
```

### 2. ç›‘æ§ç¦»çº¿é˜Ÿåˆ—
```python
# å®šæœŸæ£€æŸ¥é˜Ÿåˆ—å¤§å°
import schedule

def check_queue_size():
    cache = LocalCache()
    queue = cache.get_offline_queue()
    size = len(queue)
    
    if size > 800:  # 80% å®¹é‡
        logger.warning(f"âš ï¸  ç¦»çº¿é˜Ÿåˆ—æ¥è¿‘æ»¡è½½: {size}/1000")
    
    # ä¸ŠæŠ¥åˆ°ç›‘æ§ç³»ç»Ÿ
    metrics.gauge('offline_queue_size', size)

schedule.every(5).minutes.do(check_queue_size)
```

### 3. æ•°æ®åº“ç»´æŠ¤
```bash
# å®šæœŸä¼˜åŒ–æ•°æ®åº“
sqlite3 data/data.db << EOF
PRAGMA optimize;
PRAGMA wal_checkpoint(FULL);
VACUUM;
EOF
```

## ğŸ‰ æ€»ç»“

Phase 1 çš„ä¼˜åŒ–å·²åœ†æ»¡å®Œæˆï¼Œç³»ç»Ÿåœ¨ä»¥ä¸‹æ–¹é¢å¾—åˆ°æ˜¾è‘—æå‡ï¼š

1. **ç¨³å®šæ€§** â¬†ï¸ 50%
   - ç¦»çº¿é˜Ÿåˆ—ä¸ä¼šæº¢å‡º
   - æ•°æ®æ–‡ä»¶ä¸ä¼šæŸå
   - é…ç½®é”™è¯¯æå‰å‘ç°

2. **æ€§èƒ½** â¬†ï¸ 5-10x
   - SQLite å¹¶å‘èƒ½åŠ›å¤§å¹…æå‡
   - å†™å…¥å»¶è¿Ÿé™ä½ 50%
   - æŸ¥è¯¢ç¼“å­˜å¢å¤§ 20å€

3. **å¯ç»´æŠ¤æ€§** â¬†ï¸ 80%
   - ç¯å¢ƒå˜é‡ç»Ÿä¸€ç®¡ç†
   - è‡ªåŠ¨é…ç½®éªŒè¯
   - æ¸…æ™°çš„é”™è¯¯æç¤º

4. **å®‰å…¨æ€§** â¬†ï¸ 100%
   - æ‰€æœ‰å¯†é’¥ä½¿ç”¨ç¯å¢ƒå˜é‡
   - æ•æ„Ÿä¿¡æ¯ä¸æäº¤ Git
   - å¯†é’¥æ˜¾ç¤ºè‡ªåŠ¨è„±æ•

**ä¸‹ä¸€æ­¥**: å¼€å§‹ Phase 2 - æˆæœ¬ç›‘æ§å’Œå¯è§‚æµ‹æ€§å»ºè®¾

---

**æŠ¥å‘Šäºº**: AI Architecture Team  
**å®¡æ ¸äºº**: å¾…å®¡æ ¸  
**çŠ¶æ€**: âœ… Phase 1 å·²å®Œæˆï¼Œç­‰å¾…éªŒæ”¶

