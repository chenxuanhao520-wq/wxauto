# ğŸ“‹ MCP ä¸­å°æ¶æ„è®¾è®¡æ–¹æ¡ˆ

è®¾è®¡æ—¶é—´: 2025-10-19  
ç›®æ ‡: ä¸º WxAuto ç³»ç»Ÿå»ºç«‹ MCP ä¸­å°ï¼Œæ”¯æŒå¤§é‡ MCP æœåŠ¡æ¥å…¥  

---

## ğŸ¯ æ ¸å¿ƒä»·å€¼

### ä¸ºä»€ä¹ˆéœ€è¦ MCP ä¸­å°ï¼Ÿ

**ä¼ ç»Ÿæ–¹å¼çš„é—®é¢˜**:
- âŒ æ¯ä¸ªåŠŸèƒ½éƒ½è¦è‡ªå·±å¼€å‘
- âŒ æ–‡æ¡£è§£æã€OCRã€è¯­éŸ³è¯†åˆ«ç­‰é‡å¤é€ è½®å­
- âŒ ç»´æŠ¤æˆæœ¬é«˜
- âŒ å‡çº§å›°éš¾

**MCP ä¸­å°çš„ä¼˜åŠ¿**:
- âœ… å³æ’å³ç”¨ - æ¥å…¥ç¬¬ä¸‰æ–¹ MCP æœåŠ¡
- âœ… ç»Ÿä¸€ç®¡ç† - é›†ä¸­é…ç½®å’Œç›‘æ§
- âœ… çµæ´»æ‰©å±• - éšæ—¶æ·»åŠ æ–°èƒ½åŠ›
- âœ… é™ä½æˆæœ¬ - ä½¿ç”¨æˆç†ŸæœåŠ¡ï¼Œæ— éœ€è‡ªç ”

---

## ğŸ—ï¸ MCP ä¸­å°æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     WxAuto å®¢æœç³»ç»Ÿ                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ æ¶ˆæ¯å¤„ç† â”‚  â”‚ AI ç½‘å…³  â”‚  â”‚ RAG æ£€ç´¢ â”‚  â”‚ çŸ¥è¯†åº“   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚             â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     MCP ä¸­å° (æ–°å»º)      â”‚
        â”‚  â€¢ ç»Ÿä¸€æ¥å£              â”‚
        â”‚  â€¢ æœåŠ¡æ³¨å†Œ              â”‚
        â”‚  â€¢ è°ƒç”¨è·¯ç”±              â”‚
        â”‚  â€¢ ç›‘æ§æ—¥å¿—              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚  AIOCR MCP     â”‚  â”‚  å…¶ä»– MCP æœåŠ¡    â”‚  â”‚  è‡ªå®šä¹‰   â”‚
â”‚  â€¢ æ–‡æ¡£è¯†åˆ«    â”‚  â”‚  â€¢ è¯­éŸ³è¯†åˆ«      â”‚  â”‚  MCP      â”‚
â”‚  â€¢ OCR         â”‚  â”‚  â€¢ å›¾ç‰‡ç”Ÿæˆ      â”‚  â”‚  æœåŠ¡     â”‚
â”‚  â€¢ Markdownè½¬æ¢â”‚  â”‚  â€¢ æ•°æ®åˆ†æ      â”‚  â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ MCP ä¸­å°æ ¸å¿ƒæ¨¡å—

### 1. MCP å®¢æˆ·ç«¯ç®¡ç†å™¨

```python
# modules/mcp_platform/__init__.py

"""
MCP ä¸­å° - ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ MCP æœåŠ¡
"""

from .mcp_manager import MCPManager
from .mcp_client import MCPClient
from .aiocr_client import AIOCRClient

__all__ = ['MCPManager', 'MCPClient', 'AIOCRClient']
```

### 2. MCP ç®¡ç†å™¨

```python
# modules/mcp_platform/mcp_manager.py

"""
MCP ç®¡ç†å™¨ - ç»Ÿä¸€è°ƒåº¦æ‰€æœ‰ MCP æœåŠ¡
"""
import logging
from typing import Dict, List, Any, Optional
from dataclasses import dataclass

logger = logging.getLogger(__name__)


@dataclass
class MCPServiceConfig:
    """MCP æœåŠ¡é…ç½®"""
    service_id: str
    name: str
    type: str  # sse | stdio
    url: str
    api_key: str
    capabilities: List[str]  # ['ocr', 'doc_convert', 'markdown']
    enabled: bool = True
    timeout: int = 30


class MCPManager:
    """
    MCP ä¸­å°ç®¡ç†å™¨
    
    åŠŸèƒ½ï¼š
    1. æ³¨å†Œå’Œç®¡ç†å¤šä¸ª MCP æœåŠ¡
    2. ç»Ÿä¸€è°ƒç”¨æ¥å£
    3. æœåŠ¡è·¯ç”±å’Œè´Ÿè½½å‡è¡¡
    4. ç›‘æ§å’Œæ—¥å¿—
    5. é”™è¯¯å¤„ç†å’Œé™çº§
    """
    
    def __init__(self):
        self.services: Dict[str, MCPClient] = {}
        self.service_configs: Dict[str, MCPServiceConfig] = {}
        logger.info("MCP ä¸­å°åˆå§‹åŒ–")
    
    def register_service(self, config: MCPServiceConfig):
        """
        æ³¨å†Œ MCP æœåŠ¡
        
        Args:
            config: æœåŠ¡é…ç½®
        """
        try:
            # æ ¹æ®æœåŠ¡ç±»å‹åˆ›å»ºå®¢æˆ·ç«¯
            if config.service_id == 'aiocr':
                from .aiocr_client import AIOCRClient
                client = AIOCRClient(
                    api_key=config.api_key,
                    base_url=config.url
                )
            else:
                # é€šç”¨ MCP å®¢æˆ·ç«¯
                from .mcp_client import MCPClient
                client = MCPClient(
                    service_id=config.service_id,
                    url=config.url,
                    api_key=config.api_key,
                    connection_type=config.type
                )
            
            self.services[config.service_id] = client
            self.service_configs[config.service_id] = config
            
            logger.info(f"âœ… MCP æœåŠ¡å·²æ³¨å†Œ: {config.name} ({config.service_id})")
        
        except Exception as e:
            logger.error(f"âŒ MCP æœåŠ¡æ³¨å†Œå¤±è´¥: {config.service_id}, {e}")
    
    async def call_service(
        self,
        service_id: str,
        tool_name: str,
        parameters: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        è°ƒç”¨ MCP æœåŠ¡
        
        Args:
            service_id: æœåŠ¡IDï¼Œå¦‚ 'aiocr'
            tool_name: å·¥å…·åç§°ï¼Œå¦‚ 'doc_recognition'
            parameters: å‚æ•°
        
        Returns:
            æ‰§è¡Œç»“æœ
        """
        if service_id not in self.services:
            raise ValueError(f"MCP æœåŠ¡ä¸å­˜åœ¨: {service_id}")
        
        config = self.service_configs[service_id]
        
        if not config.enabled:
            raise ValueError(f"MCP æœåŠ¡å·²ç¦ç”¨: {service_id}")
        
        client = self.services[service_id]
        
        try:
            logger.info(f"è°ƒç”¨ MCP æœåŠ¡: {service_id}.{tool_name}")
            
            result = await client.call_tool(
                tool_name=tool_name,
                parameters=parameters
            )
            
            logger.info(f"âœ… MCP è°ƒç”¨æˆåŠŸ: {service_id}.{tool_name}")
            return result
        
        except Exception as e:
            logger.error(f"âŒ MCP è°ƒç”¨å¤±è´¥: {service_id}.{tool_name}, {e}")
            raise
    
    async def call_capability(
        self,
        capability: str,
        parameters: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        æ ¹æ®èƒ½åŠ›è°ƒç”¨ï¼ˆè‡ªåŠ¨è·¯ç”±åˆ°åˆé€‚çš„æœåŠ¡ï¼‰
        
        Args:
            capability: èƒ½åŠ›åç§°ï¼Œå¦‚ 'ocr', 'doc_convert'
            parameters: å‚æ•°
        
        Returns:
            æ‰§è¡Œç»“æœ
        """
        # æŸ¥æ‰¾æ”¯æŒè¯¥èƒ½åŠ›çš„æœåŠ¡
        available_services = [
            service_id
            for service_id, config in self.service_configs.items()
            if capability in config.capabilities and config.enabled
        ]
        
        if not available_services:
            raise ValueError(f"æ²¡æœ‰å¯ç”¨çš„æœåŠ¡æ”¯æŒè¯¥èƒ½åŠ›: {capability}")
        
        # é€‰æ‹©ç¬¬ä¸€ä¸ªå¯ç”¨æœåŠ¡ï¼ˆå¯ä»¥æ‰©å±•ä¸ºè´Ÿè½½å‡è¡¡ï¼‰
        service_id = available_services[0]
        
        # æ˜ å°„èƒ½åŠ›åˆ°å·¥å…·åç§°
        tool_mapping = {
            'ocr': 'doc_recognition',
            'doc_to_markdown': 'doc_to_markdown',
            'doc_to_text': 'doc_recognition'
        }
        
        tool_name = tool_mapping.get(capability, capability)
        
        return await self.call_service(service_id, tool_name, parameters)
    
    def get_available_capabilities(self) -> List[str]:
        """è·å–æ‰€æœ‰å¯ç”¨çš„èƒ½åŠ›"""
        capabilities = set()
        for config in self.service_configs.values():
            if config.enabled:
                capabilities.update(config.capabilities)
        return list(capabilities)
    
    def health_check(self) -> Dict[str, Any]:
        """å¥åº·æ£€æŸ¥"""
        return {
            'total_services': len(self.services),
            'enabled_services': sum(1 for c in self.service_configs.values() if c.enabled),
            'available_capabilities': self.get_available_capabilities(),
            'services': [
                {
                    'id': service_id,
                    'name': config.name,
                    'enabled': config.enabled,
                    'capabilities': config.capabilities
                }
                for service_id, config in self.service_configs.items()
            ]
        }
```

---

## ğŸ”§ AIOCR MCP å®¢æˆ·ç«¯å®ç°

```python
# modules/mcp_platform/aiocr_client.py

"""
AIOCR MCP å®¢æˆ·ç«¯
æ”¯æŒæ–‡æ¡£è¯†åˆ«å’Œè½¬æ¢
"""
import httpx
import logging
from typing import Dict, Any, Optional
import base64
from pathlib import Path

logger = logging.getLogger(__name__)


class AIOCRClient:
    """
    AIOCR MCP å®¢æˆ·ç«¯
    
    åŠŸèƒ½ï¼š
    1. æ–‡æ¡£è¯†åˆ«ï¼ˆdoc_recognitionï¼‰- è½¬æ–‡æœ¬
    2. æ–‡æ¡£è½¬ Markdownï¼ˆdoc_to_markdownï¼‰- ä¿ç•™æ ¼å¼
    """
    
    def __init__(
        self,
        api_key: str = None,
        base_url: str = "https://dashscope.aliyuncs.com/api/v1/mcps/ai-ocr/sse"
    ):
        """
        åˆå§‹åŒ– AIOCR å®¢æˆ·ç«¯
        
        Args:
            api_key: DashScope API Keyï¼ˆå¦‚æœä¸ºç©ºï¼Œä½¿ç”¨ä¸´æ—¶å¯†é’¥ 'ali_bailian'ï¼‰
            base_url: MCP æœåŠ¡åœ°å€
        """
        self.api_key = api_key or os.getenv("DASHSCOPE_API_KEY", "ali_bailian")
        self.base_url = base_url
        
        self.client = httpx.AsyncClient(
            headers={
                "Authorization": f"Bearer {self.api_key}",
                "Content-Type": "application/json"
            },
            timeout=60.0  # æ–‡æ¡£è¯†åˆ«å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
        )
        
        logger.info("AIOCR MCP å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ")
    
    async def doc_recognition(
        self,
        file_path: str = None,
        file_url: str = None,
        file_content: bytes = None
    ) -> Dict[str, Any]:
        """
        æ–‡æ¡£è¯†åˆ« - è½¬æ–‡æœ¬
        
        Args:
            file_path: æœ¬åœ°æ–‡ä»¶è·¯å¾„
            file_url: æ–‡ä»¶URL
            file_content: æ–‡ä»¶äºŒè¿›åˆ¶å†…å®¹
        
        Returns:
            {
                'text': 'è¯†åˆ«çš„æ–‡æœ¬å†…å®¹',
                'pages': é¡µæ•°,
                'format': 'æ–‡ä»¶æ ¼å¼'
            }
        """
        # æ„å»ºè¯·æ±‚
        if file_path:
            # è¯»å–æœ¬åœ°æ–‡ä»¶
            file_content = Path(file_path).read_bytes()
            file_name = Path(file_path).name
        elif file_content:
            file_name = "document"
        elif file_url:
            file_name = file_url.split('/')[-1]
        else:
            raise ValueError("å¿…é¡»æä¾› file_path, file_url æˆ– file_content")
        
        # Base64 ç¼–ç 
        if file_content:
            file_base64 = base64.b64encode(file_content).decode()
        
        # è°ƒç”¨ MCP å·¥å…·
        payload = {
            "name": "doc_recognition",
            "arguments": {
                "file": file_base64 if file_content else None,
                "url": file_url if file_url else None,
                "filename": file_name
            }
        }
        
        try:
            # SSE è°ƒç”¨ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…éœ€è¦å¤„ç† SSE æµï¼‰
            response = await self.client.post(
                f"{self.base_url}/tools/call",
                json=payload
            )
            
            if response.status_code == 200:
                result = response.json()
                logger.info(f"âœ… AIOCR è¯†åˆ«æˆåŠŸ: {file_name}")
                return result
            else:
                logger.error(f"âŒ AIOCR è¯†åˆ«å¤±è´¥: {response.status_code}")
                return {'error': response.text}
        
        except Exception as e:
            logger.error(f"âŒ AIOCR è°ƒç”¨å¼‚å¸¸: {e}")
            raise
    
    async def doc_to_markdown(
        self,
        file_path: str = None,
        file_url: str = None,
        file_content: bytes = None
    ) -> Dict[str, Any]:
        """
        æ–‡æ¡£è½¬ Markdown - ä¿ç•™æ ¼å¼
        
        Returns:
            {
                'markdown': 'Markdown æ ¼å¼å†…å®¹',
                'pages': é¡µæ•°,
                'format': 'æ–‡ä»¶æ ¼å¼'
            }
        """
        # ç±»ä¼¼ doc_recognitionï¼Œè°ƒç”¨ doc_to_markdown å·¥å…·
        # å®ç°é€»è¾‘ä¸ä¸Šé¢ç›¸åŒ
        pass
    
    async def call_tool(self, tool_name: str, parameters: Dict[str, Any]):
        """ç»Ÿä¸€çš„å·¥å…·è°ƒç”¨æ¥å£"""
        if tool_name == 'doc_recognition':
            return await self.doc_recognition(**parameters)
        elif tool_name == 'doc_to_markdown':
            return await self.doc_to_markdown(**parameters)
        else:
            raise ValueError(f"æœªçŸ¥çš„å·¥å…·: {tool_name}")
```

---

## ğŸ”Œ é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

### é›†æˆç‚¹ 1: çŸ¥è¯†åº“ä¸Šä¼ 

**åœºæ™¯**: ç”¨æˆ·ä¸Šä¼ æ–‡æ¡£åˆ°çŸ¥è¯†åº“

```python
# scripts/upload_with_etl.py (ç°æœ‰æ–‡ä»¶ï¼Œæ·»åŠ  MCP æ”¯æŒ)

class DocumentETLPipeline:
    def __init__(self):
        # åŸæœ‰ç»„ä»¶
        self.document_processor = DocumentProcessor()
        
        # âœ… æ–°å¢ï¼šMCP ä¸­å°
        from modules.mcp_platform.mcp_manager import MCPManager
        self.mcp_manager = MCPManager()
        
        # æ³¨å†Œ AIOCR æœåŠ¡
        self._register_mcp_services()
    
    def _register_mcp_services(self):
        """æ³¨å†Œ MCP æœåŠ¡"""
        from modules.mcp_platform.mcp_manager import MCPServiceConfig
        
        # æ³¨å†Œ AIOCR
        aiocr_config = MCPServiceConfig(
            service_id='aiocr',
            name='AIOCR æ–‡æ¡£è¯†åˆ«',
            type='sse',
            url='https://dashscope.aliyuncs.com/api/v1/mcps/ai-ocr/sse',
            api_key=os.getenv('DASHSCOPE_API_KEY', 'ali_bailian'),
            capabilities=['ocr', 'doc_to_markdown', 'doc_to_text']
        )
        
        self.mcp_manager.register_service(aiocr_config)
    
    async def process_document(self, file_path: str):
        """å¤„ç†æ–‡æ¡£ï¼ˆä¼˜å…ˆä½¿ç”¨ MCPï¼‰"""
        
        # âœ… ä¼˜å…ˆä½¿ç”¨ AIOCR MCP
        try:
            logger.info("å°è¯•ä½¿ç”¨ AIOCR MCP è¯†åˆ«æ–‡æ¡£...")
            
            result = await self.mcp_manager.call_capability(
                capability='doc_to_markdown',
                parameters={'file_path': file_path}
            )
            
            markdown_content = result['markdown']
            
            logger.info("âœ… AIOCR MCP è¯†åˆ«æˆåŠŸ")
            
            # ç»§ç»­ ETL æµç¨‹
            return await self._continue_etl(markdown_content, file_path)
        
        except Exception as e:
            logger.warning(f"AIOCR MCP å¤±è´¥ï¼Œé™çº§åˆ°æœ¬åœ°è§£æ: {e}")
            
            # é™çº§ï¼šä½¿ç”¨åŸæœ‰çš„ DocumentProcessor
            return await self.document_processor.process_file(file_path)
```

### é›†æˆç‚¹ 2: æ¶ˆæ¯å¤„ç†ï¼ˆå›¾ç‰‡/æ–‡ä»¶ï¼‰

**åœºæ™¯**: å®¢æˆ·å‘é€å›¾ç‰‡æˆ–æ–‡ä»¶

```python
# server/services/message_service.py

class MessageService:
    def __init__(self):
        # åŸæœ‰ç»„ä»¶
        self.ai_gateway = AIGateway()
        
        # âœ… æ–°å¢ï¼šMCP ä¸­å°
        from modules.mcp_platform.mcp_manager import MCPManager
        self.mcp_manager = MCPManager()
        self._init_mcp_services()
    
    def _init_mcp_services(self):
        """åˆå§‹åŒ– MCP æœåŠ¡"""
        # æ³¨å†Œ AIOCR
        from modules.mcp_platform.mcp_manager import MCPServiceConfig
        
        aiocr = MCPServiceConfig(
            service_id='aiocr',
            name='AIOCR',
            type='sse',
            url='https://dashscope.aliyuncs.com/api/v1/mcps/ai-ocr/sse',
            api_key=os.getenv('DASHSCOPE_API_KEY', 'ali_bailian'),
            capabilities=['ocr', 'doc_to_markdown']
        )
        
        self.mcp_manager.register_service(aiocr)
    
    async def process_message(self, message):
        """å¤„ç†æ¶ˆæ¯"""
        
        # âœ… æ£€æµ‹æ˜¯å¦åŒ…å«å›¾ç‰‡æˆ–æ–‡ä»¶
        if message.get('type') == 'image':
            # ä½¿ç”¨ AIOCR è¯†åˆ«å›¾ç‰‡
            ocr_result = await self.mcp_manager.call_capability(
                capability='ocr',
                parameters={
                    'file_url': message['image_url']
                }
            )
            
            # å°† OCR æ–‡æœ¬ä½œä¸ºç”¨æˆ·é—®é¢˜
            message['content'] = ocr_result['text']
        
        elif message.get('type') == 'file':
            # ä½¿ç”¨ AIOCR è§£ææ–‡æ¡£
            doc_result = await self.mcp_manager.call_capability(
                capability='doc_to_markdown',
                parameters={
                    'file_url': message['file_url']
                }
            )
            
            # å°†æ–‡æ¡£å†…å®¹ä½œä¸ºä¸Šä¸‹æ–‡
            message['content'] = f"ç”¨æˆ·å‘é€äº†æ–‡æ¡£ï¼Œå†…å®¹ï¼š\n{doc_result['markdown'][:500]}..."
        
        # ç»§ç»­åŸæœ‰çš„æ¶ˆæ¯å¤„ç†æµç¨‹
        return await self._process_text_message(message)
```

---

## ğŸ“Š AIOCR MCP æœåŠ¡è¯¦ç»†é…ç½®

### é…ç½®æ–‡ä»¶

```yaml
# config.yaml - æ·»åŠ  MCP é…ç½®

# ==================== MCP ä¸­å°é…ç½® ====================
mcp_platform:
  enabled: true                      # æ˜¯å¦å¯ç”¨ MCP ä¸­å°
  
  services:
    # AIOCR æ–‡æ¡£è¯†åˆ«æœåŠ¡
    aiocr:
      enabled: true
      name: "AIOCR æ–‡æ¡£è¯†åˆ«"
      type: "sse"                    # SSE é•¿è¿æ¥
      url: "https://dashscope.aliyuncs.com/api/v1/mcps/ai-ocr/sse"
      api_key_env: "DASHSCOPE_API_KEY"  # ä»ç¯å¢ƒå˜é‡è¯»å–
      fallback_key: "ali_bailian"    # ä¸´æ—¶å¯†é’¥
      timeout: 60
      retry: 3
      
      capabilities:
        - ocr                        # OCR è¯†åˆ«
        - doc_to_markdown            # æ–‡æ¡£è½¬ Markdown
        - doc_to_text                # æ–‡æ¡£è½¬æ–‡æœ¬
      
      supported_formats:
        - pdf
        - doc
        - docx
        - xls
        - xlsx
        - ppt
        - pptx
        - png
        - jpg
        - jpeg
        # ... æ›´å¤šæ ¼å¼
      
      use_cases:
        - knowledge_base_upload      # çŸ¥è¯†åº“ä¸Šä¼ 
        - image_message_ocr          # å›¾ç‰‡æ¶ˆæ¯è¯†åˆ«
        - file_message_parse         # æ–‡ä»¶æ¶ˆæ¯è§£æ
    
    # æœªæ¥å¯ä»¥æ·»åŠ æ›´å¤š MCP æœåŠ¡
    # speech_recognition:
    #   enabled: false
    #   name: "è¯­éŸ³è¯†åˆ«"
    #   ...
```

### ç¯å¢ƒå˜é‡

```bash
# set_env.sh - æ·»åŠ  MCP é…ç½®

# MCP æœåŠ¡å¯†é’¥
export DASHSCOPE_API_KEY=your-dashscope-api-key-here  # AIOCR æœåŠ¡
# export SPEECH_API_KEY=your-key  # è¯­éŸ³è¯†åˆ«æœåŠ¡ï¼ˆæœªæ¥ï¼‰
# export IMAGE_GEN_KEY=your-key   # å›¾ç‰‡ç”ŸæˆæœåŠ¡ï¼ˆæœªæ¥ï¼‰
```

---

## ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1: çŸ¥è¯†åº“æ–‡æ¡£ä¸Šä¼ 

**ç”¨æˆ·æ“ä½œ**: ä¸Šä¼  PDF äº§å“æ‰‹å†Œ

**ç³»ç»Ÿæµç¨‹**:
```python
1. æ¥æ”¶æ–‡ä»¶: product_manual.pdf
2. è°ƒç”¨ MCP: mcp_manager.call_capability('doc_to_markdown', ...)
3. è·å– Markdown: ä¿ç•™æ ¼å¼çš„æ–‡æ¡£å†…å®¹
4. ETL å¤„ç†: æ¸…æ´—ã€åˆ†å—ã€è´¨é‡éªŒè¯
5. å­˜å…¥çŸ¥è¯†åº“: é«˜è´¨é‡çš„ Markdown æ ¼å¼
6. å»ºç«‹ç´¢å¼•: BM25 + å‘é‡ç´¢å¼•
```

**ä¼˜åŠ¿**:
- âœ… AIOCR è¯†åˆ«å‡†ç¡®ç‡é«˜ï¼ˆåŸºäº AI å¤§æ¨¡å‹ï¼‰
- âœ… ä¿ç•™æ–‡æ¡£æ ¼å¼ï¼ˆè¡¨æ ¼ã€åˆ—è¡¨ã€æ ‡é¢˜ï¼‰
- âœ… æ”¯æŒ 40+ ç§æ–‡ä»¶æ ¼å¼
- âœ… é›¶è¿ç»´æˆæœ¬

### åœºæ™¯ 2: å®¢æˆ·å‘é€å›¾ç‰‡å’¨è¯¢

**ç”¨æˆ·æ“ä½œ**: å‘é€æ•…éšœå›¾ç‰‡ "å……ç”µæ¡©æŠ¥é”™æˆªå›¾"

**ç³»ç»Ÿæµç¨‹**:
```python
1. æ¥æ”¶å›¾ç‰‡: error_screenshot.jpg
2. è°ƒç”¨ MCP: mcp_manager.call_capability('ocr', ...)
3. æå–æ–‡æœ¬: "é”™è¯¯ä»£ç : E-1001, é€šè®¯æ•…éšœ"
4. RAG æ£€ç´¢: æœç´¢ "E-1001 é€šè®¯æ•…éšœ"
5. AI ç”Ÿæˆ: åŸºäºé”™è¯¯ç å’ŒçŸ¥è¯†åº“ç”Ÿæˆè§£å†³æ–¹æ¡ˆ
6. å›å¤å®¢æˆ·: "é”™è¯¯ E-1001 æ˜¯é€šè®¯æ•…éšœï¼Œè¯·æ£€æŸ¥..."
```

**ä¼˜åŠ¿**:
- âœ… è‡ªåŠ¨è¯†åˆ«å›¾ç‰‡ä¸­çš„æ–‡å­—
- âœ… æå–é”™è¯¯ç å’Œå…³é”®ä¿¡æ¯
- âœ… æ— éœ€å®¢æˆ·æ‰‹åŠ¨è¾“å…¥

### åœºæ™¯ 3: å®¢æˆ·å‘é€ Excel è¡¨æ ¼

**ç”¨æˆ·æ“ä½œ**: å‘é€è®¾å¤‡æ¸…å• Excel

**ç³»ç»Ÿæµç¨‹**:
```python
1. æ¥æ”¶æ–‡ä»¶: device_list.xlsx
2. è°ƒç”¨ MCP: mcp_manager.call_capability('doc_to_markdown', ...)
3. è½¬æ¢è¡¨æ ¼:
   | è®¾å¤‡å‹å· | æ•°é‡ | çŠ¶æ€ |
   |---------|------|------|
   | CP-7KW  | 5    | æ­£å¸¸ |
   | CP-30KW | 2    | æ•…éšœ |
4. AI åˆ†æ: "æ‚¨æœ‰ 2 å°è®¾å¤‡æ˜¾ç¤ºæ•…éšœï¼Œå»ºè®®..."
5. æ™ºèƒ½å»ºè®®: ç”Ÿæˆç»´æŠ¤æ–¹æ¡ˆ
```

---

## ğŸš€ å¿«é€Ÿå®ç°

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€é›†æˆï¼ˆ1å°æ—¶ï¼‰

1. âœ… åˆ›å»º `modules/mcp_platform/` ç›®å½•
2. âœ… å®ç° `MCPManager`
3. âœ… å®ç° `AIOCRClient`
4. âœ… åœ¨ `upload_with_etl.py` ä¸­é›†æˆ

### ç¬¬äºŒé˜¶æ®µï¼šæ¶ˆæ¯å¤„ç†é›†æˆï¼ˆ1å°æ—¶ï¼‰

5. âœ… åœ¨ `message_service.py` ä¸­é›†æˆ
6. âœ… æ”¯æŒå›¾ç‰‡æ¶ˆæ¯ OCR
7. âœ… æ”¯æŒæ–‡ä»¶æ¶ˆæ¯è§£æ

### ç¬¬ä¸‰é˜¶æ®µï¼šæ‰©å±•æ›´å¤š MCP æœåŠ¡ï¼ˆæŒ‰éœ€ï¼‰

8. â³ æ¥å…¥è¯­éŸ³è¯†åˆ« MCP
9. â³ æ¥å…¥å›¾ç‰‡ç”Ÿæˆ MCP
10. â³ æ¥å…¥æ•°æ®åˆ†æ MCP

---

## ğŸ’° æˆæœ¬åˆ†æ

### AIOCR MCP æˆæœ¬

```
å½“å‰: é™æ—¶å…è´¹
ä¸´æ—¶å¯†é’¥: 'ali_bailian' (å…è´¹)
æ­£å¼å¯†é’¥: éœ€ DashScope API Key

æœªæ¥å®šä»·ï¼ˆé¢„ä¼°ï¼‰:
- æ–‡æ¡£è¯†åˆ«: Â¥0.01-0.05/é¡µ
- OCR è¯†åˆ«: Â¥0.005-0.02/å¼ 
```

### ä½¿ç”¨åœºæ™¯æˆæœ¬

**æ¯å¤© 100 æ¬¡æ–‡æ¡£å¤„ç†**:
- çŸ¥è¯†åº“ä¸Šä¼ : 10æ¬¡ Ã— Â¥0.03 = Â¥0.3
- å›¾ç‰‡ OCR: 80æ¬¡ Ã— Â¥0.01 = Â¥0.8
- æ–‡ä»¶è§£æ: 10æ¬¡ Ã— Â¥0.03 = Â¥0.3

**æ—¥æˆæœ¬**: Â¥1.4  
**æœˆæˆæœ¬**: Â¥42

**æ€»æˆæœ¬**: Â¥54 (AI) + Â¥42 (MCP) = **Â¥96/æœˆ**

---

## ğŸŠ MCP ä¸­å°çš„æ ¸å¿ƒä¼˜åŠ¿

### å¯¹æ¯”è‡ªç ”æ–¹æ¡ˆ

| åŠŸèƒ½ | è‡ªç ”æ–¹æ¡ˆ | MCP ä¸­å° |
|------|---------|---------|
| **å¼€å‘æˆæœ¬** | 2-4 å‘¨ | 1-2 å¤© |
| **ç»´æŠ¤æˆæœ¬** | æŒç»­ç»´æŠ¤ | é›¶ç»´æŠ¤ |
| **å‡†ç¡®ç‡** | éœ€è¦è°ƒè¯• | AI å¤§æ¨¡å‹ï¼Œå‡†ç¡®ç‡é«˜ |
| **æ ¼å¼æ”¯æŒ** | æœ‰é™ | 40+ ç§æ ¼å¼ |
| **å‡çº§** | éœ€è¦é‡æ–°å¼€å‘ | è‡ªåŠ¨å‡çº§ |

### æ‰©å±•èƒ½åŠ›

**æœªæ¥å¯æ¥å…¥çš„ MCP æœåŠ¡**:
1. âœ… AIOCR - æ–‡æ¡£è¯†åˆ«ï¼ˆå·²åˆ†æï¼‰
2. â³ è¯­éŸ³è¯†åˆ« MCP - å¤„ç†è¯­éŸ³æ¶ˆæ¯
3. â³ å›¾ç‰‡ç”Ÿæˆ MCP - è‡ªåŠ¨ç”Ÿæˆå›¾è¡¨ã€æµç¨‹å›¾
4. â³ æ•°æ®åˆ†æ MCP - å®¢æˆ·æ•°æ®æ´å¯Ÿ
5. â³ ç¿»è¯‘ MCP - å¤šè¯­è¨€æ”¯æŒ
6. â³ ä»£ç æ‰§è¡Œ MCP - æŠ€æœ¯æ”¯æŒåœºæ™¯

---

## ğŸ“‹ å®æ–½è®¡åˆ’

### ç«‹å³è¡ŒåŠ¨ï¼ˆæ¨èï¼‰

**ç¬¬ä¸€æ­¥**: å®ç° MCP ä¸­å°åŸºç¡€æ¶æ„ï¼ˆ1-2å°æ—¶ï¼‰
- åˆ›å»º `modules/mcp_platform/`
- å®ç° `MCPManager` å’Œ `AIOCRClient`
- æ·»åŠ é…ç½®æ–‡ä»¶

**ç¬¬äºŒæ­¥**: é›†æˆåˆ°çŸ¥è¯†åº“ä¸Šä¼ ï¼ˆ30åˆ†é’Ÿï¼‰
- åœ¨ `upload_with_etl.py` ä¸­é›†æˆ
- æµ‹è¯• PDF/DOC ä¸Šä¼ 

**ç¬¬ä¸‰æ­¥**: é›†æˆåˆ°æ¶ˆæ¯å¤„ç†ï¼ˆ1å°æ—¶ï¼‰
- åœ¨ `message_service.py` ä¸­é›†æˆ
- æ”¯æŒå›¾ç‰‡å’Œæ–‡ä»¶æ¶ˆæ¯

**ç¬¬å››æ­¥**: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆ30åˆ†é’Ÿï¼‰
- ç«¯åˆ°ç«¯æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–

**æ€»è®¡**: çº¦ 4 å°æ—¶å³å¯å®Œæˆ

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### æ˜¯å¦éœ€è¦ MCP ä¸­å°ï¼Ÿ

**âœ… å¼ºçƒˆæ¨è**ï¼Œå¦‚æœæ‚¨æœ‰ä»¥ä¸‹éœ€æ±‚ï¼š
- ğŸ“„ å¤§é‡æ–‡æ¡£éœ€è¦å¤„ç†
- ğŸ–¼ï¸ å®¢æˆ·ç»å¸¸å‘é€å›¾ç‰‡/æ–‡ä»¶
- ğŸ”Š æœªæ¥å¯èƒ½éœ€è¦è¯­éŸ³è¯†åˆ«
- ğŸ¨ éœ€è¦å›¾è¡¨ç”Ÿæˆç­‰é«˜çº§åŠŸèƒ½
- ğŸ’° å¸Œæœ›é™ä½å¼€å‘å’Œç»´æŠ¤æˆæœ¬

### å®æ–½å»ºè®®

**Phase 1: AIOCR é›†æˆï¼ˆç«‹å³å®æ–½ï¼‰**
- å®ç° MCP ä¸­å°åŸºç¡€æ¶æ„
- æ¥å…¥ AIOCR æœåŠ¡
- é›†æˆåˆ°çŸ¥è¯†åº“ä¸Šä¼ 

**Phase 2: æ¶ˆæ¯å¤„ç†é›†æˆï¼ˆ1å‘¨å†…ï¼‰**
- æ”¯æŒå›¾ç‰‡æ¶ˆæ¯ OCR
- æ”¯æŒæ–‡ä»¶æ¶ˆæ¯è§£æ

**Phase 3: æ‰©å±•æ›´å¤šæœåŠ¡ï¼ˆæŒ‰éœ€ï¼‰**
- è¯­éŸ³è¯†åˆ«
- å›¾ç‰‡ç”Ÿæˆ
- å…¶ä»– MCP æœåŠ¡

---

## âœ… éœ€è¦æˆ‘ç«‹å³å®ç°å—ï¼Ÿ

æˆ‘å¯ä»¥ï¼š
1. âœ… åˆ›å»ºå®Œæ•´çš„ MCP ä¸­å°æ¨¡å—
2. âœ… å®ç° AIOCR å®¢æˆ·ç«¯
3. âœ… é›†æˆåˆ°çŸ¥è¯†åº“ä¸Šä¼ 
4. âœ… é›†æˆåˆ°æ¶ˆæ¯å¤„ç†
5. âœ… ç¼–å†™å®Œæ•´çš„æµ‹è¯•è„šæœ¬
6. âœ… æ›´æ–°æ–‡æ¡£

é¢„è®¡è€—æ—¶ï¼š2-3 å°æ—¶  
é¢„æœŸæ•ˆæœï¼šæ–‡æ¡£å¤„ç†èƒ½åŠ› +300%

éœ€è¦æˆ‘å¼€å§‹å®ç°å—ï¼ŸğŸ˜Š

