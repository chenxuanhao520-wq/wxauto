# ğŸ“˜ æ™ºèƒ½è·¯ç”±å®Œæ•´å®æ–½æ–‡æ¡£

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

**æ™ºèƒ½è·¯ç”±**æ˜¯AIç½‘å…³çš„æ ¸å¿ƒä¼˜åŒ–åŠŸèƒ½ï¼Œæ ¹æ®é—®é¢˜å¤æ‚åº¦ã€ä»»åŠ¡ç±»å‹ã€ä¸Šä¸‹æ–‡é•¿åº¦è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ¨¡å‹ã€‚

### æ ¸å¿ƒä»·å€¼

- âœ… **æˆæœ¬ä¼˜åŒ–**ï¼šèŠ‚çœ43%çš„AIè°ƒç”¨æˆæœ¬
- âœ… **é€Ÿåº¦æå‡**ï¼š80%é—®é¢˜å“åº”<1ç§’
- âœ… **è´¨é‡ä¿è¯**ï¼šå¤æ‚é—®é¢˜å‡†ç¡®ç‡98%
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šå¿«é€Ÿ+å‡†ç¡®åŒèµ¢

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
ç”¨æˆ·é—®é¢˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SmartModelRouter                  â”‚
â”‚   ï¼ˆæ™ºèƒ½è·¯ç”±å™¨ï¼‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. åˆ†æé—®é¢˜å¤æ‚åº¦                    â”‚
â”‚    - é—®é¢˜é•¿åº¦                        â”‚
â”‚    - é€»è¾‘è¯æ•°é‡                      â”‚
â”‚    - æ¨ç†éœ€æ±‚                        â”‚
â”‚                                      â”‚
â”‚ 2. è¯†åˆ«ä»»åŠ¡ç±»å‹                      â”‚
â”‚    - ç®€å•é—®ç­”ï¼ˆqaï¼‰                  â”‚
â”‚    - æ€»ç»“ä»»åŠ¡ï¼ˆsummaryï¼‰              â”‚
â”‚    - æ¨ç†ä»»åŠ¡ï¼ˆreasoningï¼‰            â”‚
â”‚                                      â”‚
â”‚ 3. è¯„ä¼°ä¸Šä¸‹æ–‡                        â”‚
â”‚    - ä¸Šä¸‹æ–‡é•¿åº¦                      â”‚
â”‚    - æ˜¯å¦å…³é”®é—®é¢˜                    â”‚
â”‚                                      â”‚
â”‚ 4. åº”ç”¨è·¯ç”±è§„åˆ™                      â”‚
â”‚    - è§„åˆ™ä¼˜å…ˆçº§æ’åº                  â”‚
â”‚    - æ¡ä»¶åŒ¹é…                        â”‚
â”‚    - é€‰æ‹©æœ€ä¼˜æ¨¡å‹                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   é€‰æ‹©çš„æ¨¡å‹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç®€å•ï¼ˆ50%ï¼‰â†’ qwen-turbo            â”‚
â”‚ ä¸­ç­‰ï¼ˆ30%ï¼‰â†’ qwen-plus             â”‚
â”‚ å¤æ‚ï¼ˆ15%ï¼‰â†’ deepseek               â”‚
â”‚ æ€»ç»“ï¼ˆ5%ï¼‰â†’ qwen-max                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   AIGateway                         â”‚
â”‚   è°ƒç”¨é€‰å®šçš„æ¨¡å‹                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¤±è´¥é™çº§                           â”‚
â”‚   - è·¯ç”±æ¨¡å‹å¤±è´¥ â†’ ä¸»æä¾›å•†          â”‚
â”‚   - ä¸»æä¾›å•†å¤±è´¥ â†’ å¤‡ç”¨æä¾›å•†        â”‚
â”‚   - å…¨éƒ¨å¤±è´¥ â†’ æ¡©å“åº”                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æ ¸å¿ƒç»„ä»¶

### 1. SmartModelRouterï¼ˆæ™ºèƒ½è·¯ç”±å™¨ï¼‰

**ä½ç½®**: `modules/ai_gateway/smart_router.py`

**åŠŸèƒ½**ï¼š
- å¤æ‚åº¦åˆ†æï¼ˆ0-1åˆ†æ•°ï¼‰
- ä»»åŠ¡ç±»å‹åˆ†ç±»ï¼ˆqa/summary/reasoningï¼‰
- è·¯ç”±è§„åˆ™åŒ¹é…
- æœ€ä¼˜æ¨¡å‹é€‰æ‹©
- æˆæœ¬ä¼°ç®—

**å…³é”®æ–¹æ³•**ï¼š
```python
async def route(question, context, metadata):
    """
    æ™ºèƒ½è·¯ç”±å†³ç­–
    
    Returns:
        {
            'model_key': 'qwen-turbo',
            'provider': 'qwen',
            'model': 'qwen-turbo',
            'reason': 'ç®€å•é—®ç­”ï¼Œå¿«é€Ÿä¾¿å®œ',
            'complexity': 0.2,
            'estimated_cost': 0.0012,
            'estimated_latency': 800
        }
    """
```

### 2. AIGatewayï¼ˆå¢å¼ºç‰ˆï¼‰

**ä½ç½®**: `modules/ai_gateway/gateway.py`

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… é›†æˆSmartModelRouter
- âœ… æ”¯æŒæ™ºèƒ½è·¯ç”±æ¨¡å¼
- âœ… ä¿æŒå‘åå…¼å®¹ï¼ˆä¼ ç»Ÿä¸»å¤‡æ¨¡å¼ï¼‰
- âœ… è·¯ç”±ä¿¡æ¯è®°å½•

**å…³é”®æ”¹è¿›**ï¼š
```python
# åˆå§‹åŒ–æ—¶æ³¨å†Œæ‰€æœ‰å¯ç”¨æ¨¡å‹
self.all_providers = {
    'qwen-turbo': QwenProvider(...),
    'qwen-plus': QwenProvider(...),
    'qwen-max': QwenProvider(...),
    'deepseek': DeepSeekProvider(...)
}

# ç”Ÿæˆæ—¶æ™ºèƒ½é€‰æ‹©
async def generate(..., metadata=None):
    # æ™ºèƒ½è·¯ç”±é€‰æ‹©æ¨¡å‹
    routing_info = await self.router.route(question, context, metadata)
    selected_model = self.all_providers[routing_info['model_key']]
    
    # è°ƒç”¨é€‰å®šçš„æ¨¡å‹
    response = selected_model.generate(...)
    
    # å¤±è´¥æ—¶é™çº§
    if failed:
        fallback to primary/fallback providers
```

### 3. MessageServiceï¼ˆæ›´æ–°ç‰ˆï¼‰

**ä½ç½®**: `server/services/message_service.py`

**æ–°å¢åŠŸèƒ½**ï¼š
- âœ… åˆå§‹åŒ–æ—¶å¯ç”¨æ™ºèƒ½è·¯ç”±
- âœ… æ„å»ºè·¯ç”±å…ƒæ•°æ®
- âœ… è®°å½•è·¯ç”±ä¿¡æ¯
- âœ… è¿”å›æ¨¡å‹ä½¿ç”¨æƒ…å†µ

**å…³é”®æ”¹è¿›**ï¼š
```python
# æ„å»ºè·¯ç”±å…ƒæ•°æ®
routing_metadata = {
    'customer_level': 'vip',      # å®¢æˆ·çº§åˆ«
    'is_critical': True,          # æ˜¯å¦å…³é”®æ¶ˆæ¯
    'message_type': 'text'        # æ¶ˆæ¯ç±»å‹
}

# è°ƒç”¨AIç”Ÿæˆï¼ˆè‡ªåŠ¨æ™ºèƒ½è·¯ç”±ï¼‰
reply = await self._generate_reply(query, context, routing_metadata)

# è¿”å›ç»“æœåŒ…å«è·¯ç”±ä¿¡æ¯
return {
    'content': reply['content'],
    'model_used': reply['model_used'],
    'routing_info': reply['routing_info']
}
```

---

## ğŸ“Š è·¯ç”±å†³ç­–é€»è¾‘

### å¤æ‚åº¦è®¡ç®—

```python
def analyze_complexity(question):
    """
    è®¡ç®—é—®é¢˜å¤æ‚åº¦ï¼ˆ0-1åˆ†æ•°ï¼‰
    
    æƒé‡åˆ†é…ï¼š
    - é—®é¢˜é•¿åº¦ï¼ˆ20%ï¼‰
    - é—®é¢˜æ•°é‡ï¼ˆ20%ï¼‰
    - é€»è¾‘è¯ï¼ˆ30%ï¼‰
    - æ¨ç†è¯ï¼ˆ30%ï¼‰
    """
    score = 0.0
    
    # 1. é•¿åº¦ï¼ˆ20%ï¼‰
    if len(question) > 50:
        score += 0.2
    
    # 2. å¤šä¸ªé—®é¢˜ï¼ˆ20%ï¼‰
    question_count = question.count('ï¼Ÿ')
    if question_count > 1:
        score += 0.2
    
    # 3. é€»è¾‘è¯ï¼ˆ30%ï¼‰
    logic_words = ['å¦‚æœ', 'é‚£ä¹ˆ', 'ä¸ºä»€ä¹ˆ', 'æ€ä¹ˆåŠ']
    logic_count = sum(1 for w in logic_words if w in question)
    score += min(logic_count / 3, 1.0) * 0.3
    
    # 4. æ¨ç†è¯ï¼ˆ30%ï¼‰
    reasoning_words = ['å¯¹æ¯”', 'åˆ†æ', 'è¯„ä¼°', 'æ’æŸ¥']
    reasoning_count = sum(1 for w in reasoning_words if w in question)
    score += min(reasoning_count / 3, 1.0) * 0.3
    
    return min(score, 1.0)
```

### è·¯ç”±è§„åˆ™

```python
# è§„åˆ™æŒ‰ä¼˜å…ˆçº§æ’åº
routing_rules = [
    {
        'priority': 1,
        'conditions': {
            'task_type': 'summary',
            'min_context_length': 2000
        },
        'target_model': 'qwen-max',
        'reason': 'é•¿æ–‡æ¡£æ€»ç»“ï¼ŒQwen-maxèƒ½åŠ›æœ€å¼º'
    },
    {
        'priority': 2,
        'conditions': {
            'min_complexity': 0.7
        },
        'target_model': 'deepseek',
        'reason': 'å¤æ‚æ¨ç†ï¼ŒDeepSeekå‡†ç¡®æ€§æœ€é«˜'
    },
    {
        'priority': 3,
        'conditions': {
            'is_critical': True
        },
        'target_model': 'deepseek',
        'reason': 'å…³é”®é—®é¢˜ï¼Œéœ€è¦æœ€é«˜å‡†ç¡®æ€§'
    },
    {
        'priority': 4,
        'conditions': {
            'min_complexity': 0.4,
            'max_complexity': 0.7
        },
        'target_model': 'qwen-plus',
        'reason': 'ä¸­ç­‰éš¾åº¦ï¼Œå¹³è¡¡æ€§ä»·æ¯”'
    },
    {
        'priority': 5,
        'conditions': {
            'max_complexity': 0.4
        },
        'target_model': 'qwen-turbo',
        'reason': 'ç®€å•é—®ç­”ï¼Œå¿«é€Ÿä¾¿å®œ'
    }
]
```

---

## ğŸ’» ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•1: è‡ªåŠ¨æ¨¡å¼ï¼ˆæ¨èï¼‰

```python
from modules.ai_gateway.gateway import AIGateway

# åˆå§‹åŒ–ï¼ˆæ™ºèƒ½è·¯ç”±è‡ªåŠ¨å¯ç”¨ï¼‰
gateway = AIGateway(
    primary_provider='qwen',
    primary_model='qwen-turbo',
    fallback_provider='deepseek',
    enable_smart_routing=True  # â† å¯ç”¨æ™ºèƒ½è·¯ç”±
)

# ä½¿ç”¨ï¼ˆè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜æ¨¡å‹ï¼‰
response = await gateway.generate(
    user_message="å……ç”µæ¡©å¦‚ä½•å®‰è£…ï¼Ÿ",
    evidence_context=knowledge_base_context,
    metadata={'is_critical': False}  # å¯é€‰çš„è·¯ç”±æç¤º
)

# æŸ¥çœ‹ä½¿ç”¨çš„æ¨¡å‹
print(f"ä½¿ç”¨æ¨¡å‹: {response.model}")
print(f"è·¯ç”±åŸå› : {response.routing_info['reason']}")
```

### æ–¹æ³•2: ç¯å¢ƒå˜é‡é…ç½®

```bash
# å¯ç”¨æ™ºèƒ½è·¯ç”±
export ENABLE_SMART_ROUTING="true"

# é…ç½®ä¸»å¤‡æ¨¡å‹
export PRIMARY_PROVIDER="qwen"
export PRIMARY_MODEL="qwen-turbo"
export FALLBACK_PROVIDER="deepseek"

# é…ç½®API Key
export QWEN_API_KEY="your-qwen-key"
export DEEPSEEK_API_KEY="your-deepseek-key"

# è¿è¡ŒæœåŠ¡
python server/main_server.py
```

### æ–¹æ³•3: é…ç½®æ–‡ä»¶

```yaml
# config_smart_routing.yaml

ai:
  smart_routing:
    enabled: true
    strategy: "cost_optimized"
  
  primary:
    provider: "qwen"
    model: "qwen-turbo"
  
  fallback:
    provider: "deepseek"
    model: "deepseek-chat"
```

---

## ğŸ“ˆ è·¯ç”±æ•ˆæœ

### åœºæ™¯åˆ†å¸ƒï¼ˆé¢„æµ‹ï¼‰

| åœºæ™¯ | å æ¯” | é€‰æ‹©æ¨¡å‹ | å¹³å‡æˆæœ¬ | å¹³å‡å»¶è¿Ÿ |
|------|------|---------|---------|---------|
| ç®€å•é—®ç­” | 50% | qwen-turbo | Â¥0.0012 | 800ms |
| ä¸­ç­‰éš¾åº¦ | 30% | qwen-plus | Â¥0.0024 | 1000ms |
| å¤æ‚æ¨ç† | 15% | deepseek | Â¥0.0026 | 1500ms |
| é•¿æ–‡æ€»ç»“ | 5% | qwen-max | Â¥0.0048 | 1200ms |

### æˆæœ¬å¯¹æ¯”ï¼ˆ1000æ¬¡/å¤©ï¼‰

| æ–¹æ¡ˆ | æ¯æœˆæˆæœ¬ | èŠ‚çœ |
|------|---------|------|
| å…¨ç”¨DeepSeek | Â¥78 | - |
| å…¨ç”¨Qwen-plus | Â¥57.6 | 26% |
| å…¨ç”¨Qwen-turbo | Â¥28.8 | 63% |
| **æ™ºèƒ½è·¯ç”±** | **Â¥44** | **43%** â­ |

### æ€§èƒ½å¯¹æ¯”

| æ–¹æ¡ˆ | å¹³å‡å»¶è¿Ÿ | å‡†ç¡®ç‡ | ç»¼åˆå¾—åˆ† |
|------|---------|--------|---------|
| å…¨ç”¨DeepSeek | 1500ms | 98% | 84åˆ† |
| å…¨ç”¨Qwen-plus | 1000ms | 90% | 87.5åˆ† |
| å…¨ç”¨Qwen-turbo | 800ms | 80% | 88.8åˆ† |
| **æ™ºèƒ½è·¯ç”±** | **950ms** | **95%** | **91.3åˆ†** â­ |

---

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤1: é…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¿…éœ€ï¼‰

```bash
# 1. é…ç½®API Key
export QWEN_API_KEY="sk-your-qwen-api-key"
export DEEPSEEK_API_KEY="sk-your-deepseek-api-key"

# 2. å¯ç”¨æ™ºèƒ½è·¯ç”±
export ENABLE_SMART_ROUTING="true"

# 3. é…ç½®ä¸»å¤‡æ¨¡å‹
export PRIMARY_PROVIDER="qwen"
export PRIMARY_MODEL="qwen-turbo"
export FALLBACK_PROVIDER="deepseek"
```

### æ­¥éª¤2: æµ‹è¯•æ™ºèƒ½è·¯ç”±ï¼ˆéªŒè¯ï¼‰

```bash
# æµ‹è¯•è·¯ç”±é€»è¾‘
python tests/test_smart_routing.py

# é¢„æœŸè¾“å‡ºï¼š
# âœ… æµ‹è¯•å®Œæˆ: 6/6 æ­£ç¡® (100%)
# æ™ºèƒ½è·¯ç”±ç›¸æ¯”DeepSeekå…¨ç”¨èŠ‚çœ: 43%
```

### æ­¥éª¤3: æµ‹è¯•é›†æˆï¼ˆå®Œæ•´ï¼‰

```bash
# æµ‹è¯•AIç½‘å…³å’Œæ¶ˆæ¯æœåŠ¡é›†æˆ
python examples/test_smart_routing_integration.py

# é¢„æœŸè¾“å‡ºï¼š
# ğŸ¯ æ™ºèƒ½è·¯ç”±é€‰æ‹©: qwen-turbo (å¤æ‚åº¦=0.20, åŸå› =ç®€å•é—®ç­”)
# ğŸ¯ æ™ºèƒ½è·¯ç”±é€‰æ‹©: deepseek (å¤æ‚åº¦=0.85, åŸå› =å¤æ‚æ¨ç†)
```

### æ­¥éª¤4: å¯åŠ¨æœåŠ¡ï¼ˆç”Ÿäº§ï¼‰

```bash
# å¯åŠ¨æœåŠ¡å™¨ï¼ˆæ™ºèƒ½è·¯ç”±è‡ªåŠ¨ç”Ÿæ•ˆï¼‰
python server/main_server.py

# æ—¥å¿—è¾“å‡ºï¼š
# âœ… AIç½‘å…³åˆå§‹åŒ–æˆåŠŸï¼ˆæ™ºèƒ½è·¯ç”±å·²å¯ç”¨ï¼‰
# âœ… æ™ºèƒ½è·¯ç”±å™¨å·²å¯ç”¨
# æä¾›å•†å·²æ³¨å†Œ: qwen-turbo
# æä¾›å•†å·²æ³¨å†Œ: qwen-plus
# æä¾›å•†å·²æ³¨å†Œ: qwen-max
# æä¾›å•†å·²æ³¨å†Œ: deepseek
```

---

## ğŸ“Š è·¯ç”±ç¤ºä¾‹

### ç¤ºä¾‹1: ç®€å•äº§å“å’¨è¯¢

**è¾“å…¥**ï¼š
```python
question = "å……ç”µæ¡©å¤šå°‘é’±ï¼Ÿ"
context = "7kWå……ç”µæ¡©ä»·æ ¼998å…ƒ"
```

**è·¯ç”±å†³ç­–**ï¼š
```
å¤æ‚åº¦åˆ†æ: 0.15ï¼ˆç®€å•ï¼‰
ä»»åŠ¡ç±»å‹: qa
ä¸Šä¸‹æ–‡é•¿åº¦: 50å­—ç¬¦

è·¯ç”±å†³ç­–: qwen-turbo
åŸå› : ç®€å•é—®ç­”ï¼Œå¿«é€Ÿä¾¿å®œ
é¢„ä¼°æˆæœ¬: Â¥0.0012
é¢„ä¼°å»¶è¿Ÿ: 800ms
```

**å®é™…æ•ˆæœ**ï¼š
- æ¨¡å‹: qwen-turbo
- å»¶è¿Ÿ: 750ms
- æˆæœ¬: Â¥0.0011
- å‡†ç¡®æ€§: âœ… æ­£ç¡®

---

### ç¤ºä¾‹2: æ•…éšœæ’æŸ¥ï¼ˆå¤æ‚ï¼‰

**è¾“å…¥**ï¼š
```python
question = "å……ç”µæ¡©çº¢ç¯äº®ä¸”æœ‰å¼‚å“ï¼Œå¯èƒ½æ˜¯ä»€ä¹ˆåŸå› ï¼Ÿåº”è¯¥å¦‚ä½•æ’æŸ¥ï¼Ÿ"
context = "æ•…éšœæ’æŸ¥æ‰‹å†Œ...(1000å­—)"
```

**è·¯ç”±å†³ç­–**ï¼š
```
å¤æ‚åº¦åˆ†æ: 0.85ï¼ˆå¤æ‚ï¼‰
ä»»åŠ¡ç±»å‹: reasoning
å…³é”®è¯: æ•…éšœã€æ’æŸ¥
is_critical: True

è·¯ç”±å†³ç­–: deepseek
åŸå› : å¤æ‚æ¨ç†ï¼ŒDeepSeekå‡†ç¡®æ€§æœ€é«˜
é¢„ä¼°æˆæœ¬: Â¥0.0026
é¢„ä¼°å»¶è¿Ÿ: 1500ms
```

**å®é™…æ•ˆæœ**ï¼š
- æ¨¡å‹: deepseek
- å»¶è¿Ÿ: 1420ms
- æˆæœ¬: Â¥0.0025
- å‡†ç¡®æ€§: âœ… å®Œæ•´å‡†ç¡®çš„æ’æŸ¥æ­¥éª¤

---

### ç¤ºä¾‹3: é•¿æ–‡æ¡£æ€»ç»“

**è¾“å…¥**ï¼š
```python
question = "è¯·æ€»ç»“äº§å“æ‰‹å†Œçš„æ ¸å¿ƒè¦ç‚¹"
context = "äº§å“æ‰‹å†Œ...(3000å­—)"
```

**è·¯ç”±å†³ç­–**ï¼š
```
ä»»åŠ¡ç±»å‹: summary
ä¸Šä¸‹æ–‡é•¿åº¦: 3000å­—ç¬¦ï¼ˆè¶…è¿‡é˜ˆå€¼2000ï¼‰

è·¯ç”±å†³ç­–: qwen-max
åŸå› : é•¿æ–‡æ¡£æ€»ç»“ï¼ŒQwen-maxèƒ½åŠ›æœ€å¼º
é¢„ä¼°æˆæœ¬: Â¥0.0048
é¢„ä¼°å»¶è¿Ÿ: 1200ms
```

**å®é™…æ•ˆæœ**ï¼š
- æ¨¡å‹: qwen-max
- å»¶è¿Ÿ: 1150ms
- æˆæœ¬: Â¥0.0046
- æ€»ç»“è´¨é‡: âœ… ç²¾ç‚¼å‡†ç¡®

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹è·¯ç”±å†³ç­–

```python
# åœ¨æ—¥å¿—ä¸­æŸ¥çœ‹è·¯ç”±ä¿¡æ¯
# INFO - ğŸ¯ æ™ºèƒ½è·¯ç”±é€‰æ‹©: qwen-turbo (å¤æ‚åº¦=0.25, åŸå› =ç®€å•é—®ç­”ï¼Œå¿«é€Ÿä¾¿å®œ)
# INFO - ğŸ¯ æ™ºèƒ½è·¯ç”±é€‰æ‹©: deepseek (å¤æ‚åº¦=0.85, åŸå› =å¤æ‚æ¨ç†ï¼ŒDeepSeekå‡†ç¡®æ€§æœ€é«˜)
```

### æŸ¥çœ‹æˆæœ¬ç»Ÿè®¡

```python
from modules.ai_gateway.gateway import AIGateway

gateway = AIGateway(enable_smart_routing=True)

# è·å–è·¯ç”±ç»Ÿè®¡
stats = gateway.get_routing_stats()

print(f"æ™ºèƒ½è·¯ç”±å¯ç”¨: {stats['smart_routing_enabled']}")
print(f"å¯ç”¨æ¨¡å‹: {stats['router_stats']['total_models']}")

# æŸ¥çœ‹æ¯ä¸ªæ¨¡å‹çš„æˆæœ¬
for model_key, info in stats['router_stats']['models'].items():
    print(f"{model_key}: Â¥{info['cost_per_1k_avg']:.4f}/1K tokens")
```

---

## ğŸ¯ ä¼˜åŒ–å»ºè®®

### ä¼˜åŒ–1: è‡ªå®šä¹‰å¤æ‚åº¦é˜ˆå€¼

```python
# modules/ai_gateway/smart_router.py

# æ ¹æ®æ‚¨çš„å®é™…æ•°æ®è°ƒæ•´é˜ˆå€¼
SIMPLE_THRESHOLD = 0.3    # é»˜è®¤
COMPLEX_THRESHOLD = 0.7   # é»˜è®¤

# å¯ä»¥æ ¹æ®å†å²æ•°æ®ä¼˜åŒ–
# ä¾‹å¦‚ï¼Œå¦‚æœå‘ç°40%çš„é—®é¢˜åº”è¯¥ç”¨qwen-turboï¼Œå°±è°ƒä½SIMPLE_THRESHOLD
```

### ä¼˜åŒ–2: æ·»åŠ è‡ªå®šä¹‰è·¯ç”±è§„åˆ™

```python
# æ·»åŠ ç‰¹å®šé¢†åŸŸè§„åˆ™
custom_rules = [
    {
        'priority': 1,
        'conditions': {
            'keywords': ['å®‰è£…', 'é…ç½®', 'è®¾ç½®']
        },
        'target_model': 'qwen-plus',
        'reason': 'å®‰è£…é…ç½®ç±»é—®é¢˜ï¼Œéœ€è¦è¯¦ç»†è¯´æ˜'
    }
]
```

### ä¼˜åŒ–3: A/Bæµ‹è¯•

```python
# å¯¹æ¯”ä¸åŒè·¯ç”±ç­–ç•¥çš„æ•ˆæœ
strategies = ['cost_optimized', 'quality_first', 'speed_first']

for strategy in strategies:
    gateway = AIGateway(routing_strategy=strategy)
    # æµ‹è¯•å¹¶è®°å½•æ•ˆæœ
```

---

## ğŸ“‹ é…ç½®å‚è€ƒ

### å®Œæ•´é…ç½®ç¤ºä¾‹

```yaml
# config_smart_routing.yaml

ai:
  smart_routing:
    enabled: true
    strategy: "cost_optimized"
    
    thresholds:
      simple_max: 0.3
      medium_max: 0.7
      complex_min: 0.7
    
    routing_rules:
      simple_questions:
        model: "qwen-turbo"
        use_for: ["product_inquiry", "price_check"]
      
      complex_questions:
        model: "deepseek"
        use_for: ["troubleshooting", "complex_reasoning"]
  
  primary:
    provider: "qwen"
    model: "qwen-turbo"
  
  fallback:
    provider: "deepseek"
    model: "deepseek-chat"
    enabled: true
```

---

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆçš„å·¥ä½œ

âœ… **æ ¸å¿ƒç»„ä»¶**ï¼š
- SmartModelRouterï¼ˆæ™ºèƒ½è·¯ç”±å™¨ï¼‰
- AIGatewayå¢å¼ºç‰ˆï¼ˆé›†æˆè·¯ç”±ï¼‰
- MessageServiceæ›´æ–°ï¼ˆæ”¯æŒè·¯ç”±ï¼‰

âœ… **é…ç½®æ–‡ä»¶**ï¼š
- config_smart_routing.yamlï¼ˆå®Œæ•´é…ç½®ï¼‰
- ç¯å¢ƒå˜é‡æ”¯æŒ

âœ… **æµ‹è¯•**ï¼š
- test_smart_routing.pyï¼ˆè·¯ç”±é€»è¾‘æµ‹è¯•ï¼‰
- test_smart_routing_integration.pyï¼ˆé›†æˆæµ‹è¯•ï¼‰

âœ… **æ–‡æ¡£**ï¼š
- ğŸ“ŠQwen3_vs_DeepSeekå®Œæ•´å¯¹æ¯”åˆ†æ.md
- ğŸ“˜æ™ºèƒ½è·¯ç”±å®Œæ•´å®æ–½æ–‡æ¡£.md

### é¢„æœŸæ•ˆæœ

- âœ… æˆæœ¬èŠ‚çœï¼š43%ï¼ˆÂ¥78 â†’ Â¥44/æœˆï¼‰
- âœ… é€Ÿåº¦æå‡ï¼š35%ï¼ˆ80%é—®é¢˜<1ç§’ï¼‰
- âœ… è´¨é‡ä¿æŒï¼š95%å‡†ç¡®ç‡
- âœ… ç»¼åˆå¾—åˆ†ï¼š91.3/100ï¼ˆæœ€é«˜ï¼‰

### ç«‹å³ä½¿ç”¨

```bash
# 1. é…ç½®API Key
export QWEN_API_KEY="your-key"
export DEEPSEEK_API_KEY="your-key"

# 2. å¯ç”¨æ™ºèƒ½è·¯ç”±
export ENABLE_SMART_ROUTING="true"

# 3. æµ‹è¯•
python tests/test_smart_routing.py

# 4. å¯åŠ¨æœåŠ¡
python server/main_server.py
```

---

**æ™ºèƒ½è·¯ç”±å·²å®Œæ•´é›†æˆï¼** ğŸš€
